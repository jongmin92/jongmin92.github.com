<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>92Hz</title>
  <icon>https://www.gravatar.com/avatar/8b7f06e12e9f3c555a0587f51748ac7f</icon>
  <subtitle>To Be A Lean Developer!</subtitle>
  <link href="/feed.xml" rel="self"/>
  
  <link href="https://jongmin92.github.io/"/>
  <updated>2019-12-06T15:40:19.480Z</updated>
  <id>https://jongmin92.github.io/</id>
  
  <author>
    <name>KimJongMin</name>
    <email>kdhx92@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>NoSuchMethodException &amp; NoSuchMethodError 해결하기</title>
    <link href="https://jongmin92.github.io/2019/12/05/Java/nosuchmethod/"/>
    <id>https://jongmin92.github.io/2019/12/05/Java/nosuchmethod/</id>
    <published>2019-12-05T13:43:00.000Z</published>
    <updated>2019-12-06T15:40:19.480Z</updated>
    
    <content type="html"><![CDATA[<p>애플리케이션에서 사용하는 라이브러리의 버전을 업데이트하거나 혹은 새로운 라이브러리를 추가하는 과정에서 종종 <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/NoSuchMethodError.html" target="_blank" rel="noopener">NoSuchMethodError</a>을 마주하게 된다.<br>이번에는 NoSuchMethodErrors 대한 내용과 해결하는 방법에 대해서 알아보자.</p><h1 id="nosuchmethoderrors"><a href="#NoSuchMethodErrors" class="headerlink" title="NoSuchMethodErrors"></a>NoSuchMethodErrors</h1><p><strong>NoSuchMethodErrors는 런타임(runtime) 시점에 존재하지 않는 메서드(method)를 호출하는 경우에 발생한다.</strong><br>일반적으로 존재하지 않는 메서드를 사용하려는 경우 컴파일(compile) 시점에 컴파일러가 에러를 발생시킨다. 그런데 런타임 시점에 에러가 발생했다는 말은 즉, <strong>컴파일때는 해당 메서드가 존재했지만 런타임 시점에 찾을 수 없었다는 것을 의미한다.</strong></p><h1 id="원인"><a href="#원인" class="headerlink" title="원인"></a>원인</h1><p>NoSuchMethodErrors가 발생하는 일반적인 상황에 대해서 좀 더 알아보자.</p><h2 id="라이브러리-breaking-change"><a href="#라이브러리-Breaking-Change" class="headerlink" title="라이브러리 Breaking Change"></a>라이브러리 Breaking Change</h2><p>NoSuchMethodErrors가 발생하는 원인 중 하나는 애플리케이션에서 사용하는 라이브러리 중 하나가 한 버전에서 다음 버전으로 변경될 때, Breaking Change를 포함하는 경우이다.<br><strong><code>Breaking Change</code>란 라이브러리가 제공하던 API에 변경 사항이 있음을 의미한다. API가 사라진다던가 return type 혹은 parameters가 변경되는 경우들이 있다.</strong></p><p>그러나, 위에서도 이야기한 것처럼 일반적으로 존재하지 않는 메서드를 사용하려는 경우 컴파일 시점에 컴파일러가 에러를 발생시키는데 어떻게 런타임 시점에 에러가 발생할 수 있는 것일까?</p><p>최근에는 SpringBoot로 애플리케이션을 개발하고 Tomcat 자체를 포함해 fatjar(uberjar)로 패키징(packaging) 후 배포해서 jar 파일을 실행하는 것으로 애플리케이션을 실행하는 것이 자연스럽게 여겨진다.</p><p>Embeded Tomcat을 사용하지 않았던 때를 생각해보자. Spring 애플리케이션을 개발하고 war로 패키징한 후, Tomcat이 설치된 폴더 아래의 webapps에 war를 배포 후 Tomcat을 재기동 하는 것으로 애플리케이션을 실행했었다.</p><p>이것이 의미하는 것이 무엇일까? Servlet Container인 Tomcat과 함게 애플리케이션이 실행되고 있는 런타임 시점에 HTTP 요청이 들어오면 Tomcat은 해당 요청에 대한 HttpServletRequest와 HttpServletResponse를 만들고 우리가 작성한 Spring 애플리케이션 코드를 실행한다.<br>우리는 애플리케이션 코드에서 Tomcat으로부터 전달받은 HttpServletRequest와 HttpServletResponse를 사용하는데, <strong>개발하는 시점에 Spring 애플리케이션에서는 HttpServletRequest와 HttpServletResponse를 어떻게 사용할 수 있는 것일까?</strong></p><p>Gradle을 사용한다면 build.gradle을, Maven을 사용하고 있다면 pom.xml을 확인해보자. 다음과 같이 HttpServletRequest와 HttpServletResponse를 포함하고 있는 <code>javax.servlet-api</code> 라이브러리를 포함하고 있을 것이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ex) build.gradle</span><br><span class="line">compileOnly(&quot;javax.servlet:javax.servlet-api:3.0.1&quot;)</span><br></pre></td></tr></table></figure><p>다만 <a href="https://jongmin92.github.io/2019/05/09/Gradle/gradle-api-vs-implementation/">implementation 혹은 api</a>가 아닌 <a href="https://blog.gradle.org/introducing-compile-only-dependencies" target="_blank" rel="noopener">compileOnly</a>를 사용해서 의존성을 선언하고 있다. 이것이 의미하는 것은 <strong>애플리케이션을 작성하고 컴파일 시점까지만<br>3.0.1 버전의 javax.servlet-api를 사용하겠다는 것이다. 그 후 컴파일이 완료되고 Tomcat에 의해서 애플리케이션이 실행되는 런타임 시점에는 Tomcat에 의해 classpath에 포함된 javax.servlet-api를 사용하게 된다.</strong></p><p>Tomcat은 버전에 따라 사용하는 Servlet 버전이 다르다. 따라서 Spring 애플리케이션에서 compileOnly 의존성으로 사용하고 있는 Servlet 라이브러리의 버전과 실제 애플리케이션이 구동되는 Tomcat에서 사용하는 버전에 차이가 있다면 생각과는 다르게 동작할 수 있는 가능성이 있는 것이다.</p><blockquote><p><a href="http://tomcat.apache.org/whichversion.html" target="_blank" rel="noopener">Apache Tomcat Versions</a><br><img src="/images/post/2019-12-05/tomcat_version.png" alt="tomcat_version"></p></blockquote><p>만약 Spring 애플리케이션의 Servlet 버전을 3.0 버전에 맞춰 개발하고 있었는데 애플리케이션이 실행되는 Tomcat이 6.0.x(Servlet 버전 2.5) 혹은 8.0.x(Servlet 버전 3.1)이라면 의도치 않은 Breaking Change를 겪게될 수 있는 것이다.</p><h2 id="라이브러리-버전-overriding"><a href="#라이브러리-버전-Overriding" class="headerlink" title="라이브러리 버전 Overriding"></a>라이브러리 버전 Overriding</h2><p>다른 원인으로는 라이브러리 버전 Overriding 문제가 있다. 다음을 가정해보자.</p><p>애플리케이션에서 라이브러리 A를 사용하고 있다. 라이브러리 A는 다른 라이브러리 B에 대해 의존성(dependency)를 갖고 있다. 애플리케이션에서 라이브러리 B를 직접 호출하지는 않지만 라이브러리 B를 사용하기 때문에 A까지 포함되게 되는데 이때, 라이브러리 B는 해당 애플리케이션에 대해 <code>전이 의존성(transitive dependency)</code>이라고 부른다.</p><p>이 경우, 만약 라이브러리 B를 이용하는 또 다른 라이브러리 C가 있고 이를 애플리케이션에서 사용하고 있다면 <strong>build system에 의해 버전 충돌로 인한 문제가 발생할 수 있다.</strong></p><ul><li>애플리케이션 &lt;- 라이브러리 A &lt;- 라이브러리 B (버전 1.x)</li><li>애플리케이션 &lt;- 라이브러리 C &lt;- 라이브러리 B (버전 2.x)</li></ul><p>Gradle과 Maven 같은 빌드 시스템은 이와 같은 버전 충돌 문제가 발생했을 때, 두 버전 중 하나를 선택하게 된다.</p><p>위의 예시에서 라이브러리 B의 2.x 버전을 선택하게 되었을 때, 라이브러리 C에서는 문제가 발생하지 않지만 라이브러리 A에서는 문제가 발생할 수 있다. (라이브러리 B가 버전 1.x와 2.x 사이에 Breaking Change가 존재할 수 있기 때문이다.)</p><h1 id="해결책"><a href="#해결책" class="headerlink" title="해결책"></a>해결책</h1><p>크게 3단계로 해결할 수 있다.</p><h2 id="문제의-class-찾기"><a href="#문제의-Class-찾기" class="headerlink" title="문제의 Class 찾기"></a>문제의 Class 찾기</h2><p><strong>먼저 문제의 메서드를 포함하는 클래스를 찾아야한다. NoSuchMethodError 로그로부터 쉽게 찾을 수 있다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.NoSuchMethodError: </span><br><span class="line">  com.jongmin.example.Service.hello(Ljava/lang/String;)Ljava/lang/String;</span><br></pre></td></tr></table></figure></p><p>클래스를 찾았다면 검색 혹은 사용하고 있는 IDE를 통해서 해당 클래스가 포함된 JAR(라이브러리)를 찾을 수 있다.</p><h2 id="class-호출하는-곳-찾기"><a href="#Class-호출하는-곳-찾기" class="headerlink" title="Class 호출하는 곳 찾기"></a>Class 호출하는 곳 찾기</h2><p><strong>다음으로 메서드를 호출하는 위치를 찾아야 한다. 이 정보는 에러 로그의 stack trace를 이용해 찾을 수 있다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.NoSuchMethodError: </span><br><span class="line">  com.jongmin.example.Service.hello(Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line">  at com.jongmin.example.NoSuchMethod.main(ProvokeNoSuchMethodError.java:<span class="number">7</span>)</span><br></pre></td></tr></table></figure></p><p>위의 로그에서는 NoSuchMethod 클래스가 런타임에 존재하지 않는 hello 메서드를 호출하려고 하는 것을 확인할 수 있다. 이제 해당 클래스가 속한 라이브러리를 찾아야한다.</p><h2 id="버전-확인"><a href="#버전-확인" class="headerlink" title="버전 확인"></a>버전 확인</h2><p>이제 NoSuchMethodError가 발생하는 위치와 런타임 시점에 존재하지 않는 메서드를 알았으므로 해결할 수 있다.</p><p><strong>현재 프로젝트의 모든 dependency를 출력해보자.</strong></p><p>Gradle을 사용하고 있다면 다음의 명령어를 사용한다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew dependencies &gt; dependencies.txt</span><br></pre></td></tr></table></figure></p><p>Maven을 사용한다면 다음의 명령어를 사용한다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dependency:list &gt; dependencies.txt</span><br></pre></td></tr></table></figure></p><p>dependencies.txt 파일을 확인하면 런타임 시점에 존재하지 않는 메서드와 이를 호출하는 클래스가 포함 된 라이브러리를 찾을 수 있다.</p><p>예를 들면, 다음과 같은 출력 결과를 확인할 수 있다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\--- org.springframework.data:spring-data-commons:1.8.2.RELEASE</span><br><span class="line">|      \--- org.springframework:spring-core:3.2.10.RELEASE -&gt; 4.3.20.RELEASE (*)</span><br></pre></td></tr></table></figure></p><p>위의 결과를 보면 spring-data-commons 라이브러리가 3.2.10 버전의 spring-core에 의존하지만 다른 라이브러리도 버전 4.3.20의 spring-core에 의존하고 있어 3.2.10 버전이 4.3.2 버전으로 Overriding된 것이다.</p><p>그럼 이제 어떤 라이브러리가 spring-core 4.3.2 버전 라이브러리에 의존하고 있는지 찾을 수 있다.</p><p>마지막으로 spring-core 라이브러리의 두 버전 중 어떤 버전이 spring-core를 필요로하는 두 라이브러리의 종속성을 만족시키는지 확인하고 결정해야 한다. 일반적이라면 안정적인 라이브러리라면 업데이트 되더라도 하위 호환성(backward compatibility)를 유지하기 때문에 최신 버전을 사용하면 될 것이다.</p><h1 id="nosuchmethodexception"><a href="#NoSuchMethodException" class="headerlink" title="NoSuchMethodException"></a>NoSuchMethodException</h1><p>NoSuchMethodException은 NoSuchMethodError와 관련이 있지만 다른 context에서 발생한다. <strong><code>NoSuchMethodError</code>는 JAR 파일이 컴파일 시점과 런타임 시점에 다른 버전을 갖는 경우 발생한다. 반면 <code>NoSuchMethodException</code>은 reflection을 이용해 존재하지 않는 메서드를 사용하려고하면 발생한다.</strong></p><p>예를 들면, 다음과 같은 코드이다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String.class.getMethod(<span class="string">"notExist"</span>);</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;애플리케이션에서 사용하는 라이브러리의 버전을 업데이트하거나 혹은 새로운 라이브러리를 추가하는 과정에서 종종 &lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/la
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot Application의 monitoring 시스템 구축하기</title>
    <link href="https://jongmin92.github.io/2019/12/04/Spring/prometheus/"/>
    <id>https://jongmin92.github.io/2019/12/04/Spring/prometheus/</id>
    <published>2019-12-03T17:20:00.000Z</published>
    <updated>2019-12-04T01:51:32.917Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/post/2019-12-04/system.png" alt="system"><br>Spring Boot를 사용하고 있는 애플리케이션에서 <a href="https://jongmin92.github.io/2019/12/03/Spring/micrometer/">이전에 살펴본 Micrometer</a>를 이용해서 metric을 생성하고 Prometheus를 이용해 수집, 그리고 Grafana로 시각화하는 시스템을 만들어보자.</p><blockquote><p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a>는 metric을 수집하고 모니터링 및 알람에 사용되는 오픈소스 애플리케이션이다. time series database를 사용해 metric을 저장하고 flexible한 query를 사용하 metric을 조회할 수 있다.</p><p><a href="https://grafana.com/" target="_blank" rel="noopener">Grafana</a>는 데이터 시각화, 모니터링 및 분석을 위한 오픈소스 플랫폼이다. 사용자는 Grafana에서 패널(panel)을 사용해 설정된 기간 동안 특정 metric을 나타내는 dashboard를 만들 수 있다.<br>Grafana는 그래프, 테이블 같은 것들을 지원할 뿐만 아니라 시각화를 위한 별도의 플러그인을 추가해서 사용할 수도 있다.</p></blockquote><h1 id="spring-boot-dependency"><a href="#Spring-Boot-Dependency" class="headerlink" title="Spring Boot Dependency"></a>Spring Boot Dependency</h1><p><strong>Spring Boot 2.0 이상</strong>부터는 애플리케이션의 metric 측정을 위해서 <code>Micrometer</code>를 제공한다. Micrometer는 Spring Boot 2의 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-metrics" target="_blank" rel="noopener">Actuator에 포함</a>되어 있기 때문에 <code>spring-boot-starter-actuator</code>를 dependency에 추가해주면 쉽게 사용할 수 있다.</p><p>추가적으로 <code>micrometer-registry-prometheus</code> dependency가 필요하다. 이 dependency는 Micrometer가 만들어내는 metric을 Prometheus 서버에서 사용할 수 있는 metric format으로 변경한다.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">'org.springframework.boot:spring-boot-starter-actuator'</span></span><br><span class="line">    implementation <span class="string">'io.micrometer:micrometer-registry-prometheus'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="actuator-endpoint-설정"><a href="#Actuator-Endpoint-설정" class="headerlink" title="Actuator Endpoint 설정"></a>Actuator Endpoint 설정</h1><p>Actuator는 Spring MVC 혹은 Spring WebFlux를 사용하는 경우, Micrometer를 통해 생성된 애플리케이션의 metric을 <code>Prometheus 서버</code>에서 가져갈(Pull)수 있도록 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-metrics-export-prometheus" target="_blank" rel="noopener">추가적인 endpoint를 제공</a>해준다.</p><p>Spring Boot 2.0 이상부터 사용하는 Actuator는 1.x 버전에서 사용하던 것과는 달리 대부분의 endpoint가 disabled로 설정되어 있다. 기본적으로 <code>/health</code>와 <code>/info</code> 2가지 endpoint만 default로 사용 가능하다. 따라서 <code>/Prometheus</code> endpoint를 사용할 수 있도록 다음과 같이 <code>application.yml</code>에서 설정이 필요하다.<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">health,</span> <span class="string">info,</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure></p><p>애플리케이션을 실행하고 <a href="http://localhost:8080/actuator" target="_blank" rel="noopener">http://localhost:8080/actuator</a> 를 통해 Actuator가 제공하는 endpoint들을 확인할 수 있다.<br><img src="/images/post/2019-12-04/endpoint.png" alt="endpoint"></p><p><a href="http://localhost:8080/actuator/prometheus" target="_blank" rel="noopener">http://localhost:8080/actuator/prometheus</a> 에서는 Micrometer를 통해 수집된 metric들을 확인할 수 있다.</p><p><img src="/images/post/2019-12-04/prometheus_endpoint.png" alt="prometheus_endpoint"></p><blockquote><p><strong>Spring Boot 2는 기본적으로 다음과 같은 metric들을 제공하고 있다.</strong></p><ul><li>JVM, report utilization of:<ul><li>Various memory and buffer pools</li><li>Statistics related to garbage collection</li><li>Thread utilization</li><li>Number of classes loaded/unloaded</li></ul></li><li>CPU usage</li><li>Spring MVC and WebFlux request latencies</li><li>RestTemplate latencies</li><li>Cache utilization</li><li>Datasource utilization, including HikariCP pool metrics</li><li>RabbitMQ connection factories</li><li>File descriptor usage</li><li>Logback: record the number of events logged to Logback at each level</li><li>Uptime: report a gauge for uptime and a fixed gauge representing the application’s absolute start time</li><li>Tomcat usage</li></ul></blockquote><h1 id="prometheus-설치-및-설정"><a href="#Prometheus-설치-및-설정" class="headerlink" title="Prometheus 설치 및 설정"></a>Prometheus 설치 및 설정</h1><p>애플리케이션에서의 설정은 끝났으니 애플리케이션에서 생성하는 metric을 수집하기 위한 Prometheus Server를 준비해보자.</p><p>테스트를 할 때는 역시나 docker(<a href="https://hub.docker.com/r/prom/prometheus" target="_blank" rel="noopener">prometheus image</a>)를 이용하면 간편하다. 만약 실제 로컬 환경 혹은 별도의 서버 환경에서 설치해서 사용하고 싶다면 <a href="https://prometheus.io/download/#prometheus" target="_blank" rel="noopener">https://prometheus.io/download/#prometheus</a> 에서 다운받아 설치하자.</p><p>Prometheus Server는 기동시 <code>/etc/prometheus/prometheus.yml</code> 설정 파일을 사용한다. docker volume mount를 이용해 Prometheus Server에서 사용할 설정 <code>prometheus.yml</code> 파일을 만들어보자.<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">10</span><span class="string">s</span> <span class="comment"># 10초 마다 Metric을 Pulling</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'spring-boot-app'</span></span><br><span class="line"><span class="attr">    metrics_path:</span> <span class="string">'/actuator/prometheus'</span> <span class="comment"># Application prometheus endpoint</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['host.docker.internal:8080']</span> <span class="comment"># Application host:port</span></span><br></pre></td></tr></table></figure></p><blockquote><p>docker에서 <code>host.docker.internal</code>은 특별한 DNS name으로 사용되며 docker를 실행하는 host를 가리킨다. 개발용으로만 사용해야 하며, Docker Desktop(Mac) 외부의 환경에서는 동작하지 않는다.</p></blockquote><p>파일 생성을 완료했다면 prom/prometheus 이미지를 이용해 docker로 prometheus를 실행한다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/Users/user/work/prometheus</span><br><span class="line"></span><br><span class="line">$ docker run -p 9090:9090 -v /Users/user/work/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml --name prometheus -d prom/prometheus --config.file=/etc/prometheus/prometheus.yml</span><br></pre></td></tr></table></figure><p>문제 없이 실행되었다면 <a href="http://localhost:9090" target="_blank" rel="noopener">http://localhost:9090</a> 에 접속해보자. 다음과 같이 Prometheus main 화면을 볼 수 있다.<br><img src="/images/post/2019-12-04/prometheus_main.png" alt="prometheus_main.png"></p><p>docker로 Prometheus를 실행하면서 설정 파일이 잘 적용되었는지도 확인해보자.<br><img src="/images/post/2019-12-04/prometheus_configuration.png" alt="prometheus_configuration.png"></p><p>Status -&gt; Targets 메뉴에서는 Application의 상태를 확인할 수 있다.<br><img src="/images/post/2019-12-04/prometheus_targets.png" alt="prometheus_targets.png"></p><p>Application의 상태(Status)가 DOWN인 경우에는 Application이 현재 기동중인지, prometheus.yml에서 targets의 값이 제대로 되어있는지 확인이 필요하다.<br><img src="/images/post/2019-12-04/prometheus_targets_2.png" alt="prometheus_targets_2.png"></p><p>여기까지 문제가 없다면 아래와 같이 수집된 metric 중 하나를 선택해 값이 잘 나오는지 확인해보자.<br><img src="/images/post/2019-12-04/prometheus_graph.png" alt="prometheus_graph.png"></p><h1 id="prometheus에서-수집한-metric을-grafana로-시각화하기"><a href="#Prometheus에서-수집한-metric을-Grafana로-시각화하기" class="headerlink" title="Prometheus에서 수집한 metric을 Grafana로 시각화하기"></a>Prometheus에서 수집한 metric을 Grafana로 시각화하기</h1><p>Prometheus의 웹 페이지에서 쿼리를 실행해 원하는 metric을 그래프로 시각화할 수 있다. 하지만 매번 모니터링을 위해 수동으로 쿼리를 실행하는 것은 비효율적이고 기본적으로 제공하는 대시보드 또한 간단하게 그래프를 볼 수 있는 정도이다.<br><strong>Prometheus가 제공하는 것만으로는 시각화하는데 한계가 있기 때문에 보통 별도의 시각화 도구를 이용해서 metric들을 모니터링한다.</strong></p><p>이번에는 별도의 시각화 도구로 Grafana를 사용해보자. 역시나 docker(<a href="https://hub.docker.com/r/grafana/grafana/" target="_blank" rel="noopener">grafana/grafana</a>)를 사용한다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name=grafana -p 3000:3000 grafana/grafana</span><br></pre></td></tr></table></figure><p>실행 후 <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a> 에 접속해보자. 다음과 같이 Grafana login 화면을 볼 수 있다.<br>기본 설정된 ID/PW인 <code>admin/admin</code> 으로 로그인할 수 있다.<br><img src="/images/post/2019-12-04/grafana_login.png" alt="grafana_login.png"></p><p>Home Dashboard에서 <code>Add data source</code>를 클릭해 Data Source 추가하자.<br><img src="/images/post/2019-12-04/grafana_add_datasource.png" alt="grafana_add_datasource.png"></p><p>Grafana에서 시각화할 데이터로서 Prometheus에 수집되고 있는 metric을 사용할 것이기 때문에 Prometheus를 선택한다.<br><img src="/images/post/2019-12-04/grafana_add_datasource_2.png" alt="grafana_add_datasource_2.png"></p><p>Name과 URL(Prometheus Server)을 설정하고 Save &amp; Test를 클릭한다.<br><img src="/images/post/2019-12-04/grafana_add_datasource_3.png" alt="grafana_add_datasource_3.png"></p><p>Prometheus가 Data Source로 추가되었다.<br><img src="/images/post/2019-12-04/grafana_add_datasource_4.png" alt="grafana_add_datasource_4.png"></p><p>다음으로는 Data Source를 이용해 Dashboard를 생성해보자.<br><img src="/images/post/2019-12-04/grafana_new_dashboard.png" alt="grafana_new_dashboard.png"></p><p>그래프를 이용해볼 것이기 때문에 <code>Choose Visualization</code>을 클릭한다.<br><img src="/images/post/2019-12-04/grafana_new_dashboard_2.png" alt="grafana_new_dashboard_2.png"></p><p>Metrics로 이전에 Prometheus에서도 확인해보았던 jvm_memoruy_used_bytes를 선택한다.<br><img src="/images/post/2019-12-04/grafana_new_dashboard_3.png" alt="grafana_new_dashboard_3.png"></p><p>작업한 Dashboard를 저장한다.<br><img src="/images/post/2019-12-04/grafana_new_dashboard_4.png" alt="grafana_new_dashboard_4.png"></p><p>추가된 Dashboard를 확인할 수 있다.<br><img src="/images/post/2019-12-04/grafana_new_dashboard_5.png" alt="grafana_new_dashboard_5.png"></p><p>Spring Boot Application에서 생성하는 metric을 Prometheus를 통해 수집하고, Grafana로 시각화하는 것까지 마무리했다.<br>실제로는 애플리케이션에서 기본적으로 제공하는 Metric 뿐만 아니라 Micrometer를 이용해 직접 필요한 Metric을 추가할 수도 있다.<br>또한 Grafana에는 소개하지 않은 더 많은 유용한 기능들이 있다. 필요한 기능은 문서를 통해 찾아가며 사용해보자.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/post/2019-12-04/system.png&quot; alt=&quot;system&quot;&gt;&lt;br&gt;Spring Boot를 사용하고 있는 애플리케이션에서 &lt;a href=&quot;https://jongmin92.github.io/2019/12
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/tags/Spring/"/>
    
      <category term="Spring Boot" scheme="https://jongmin92.github.io/tags/Spring-Boot/"/>
    
      <category term="Actuator" scheme="https://jongmin92.github.io/tags/Actuator/"/>
    
      <category term="Micrometer" scheme="https://jongmin92.github.io/tags/Micrometer/"/>
    
      <category term="Prometheus" scheme="https://jongmin92.github.io/tags/Prometheus/"/>
    
      <category term="Grafana" scheme="https://jongmin92.github.io/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>Micrometer</title>
    <link href="https://jongmin92.github.io/2019/12/03/Spring/micrometer/"/>
    <id>https://jongmin92.github.io/2019/12/03/Spring/micrometer/</id>
    <published>2019-12-02T15:18:00.000Z</published>
    <updated>2019-12-02T16:04:57.728Z</updated>
    
    <content type="html"><![CDATA[<h1 id="micrometer란"><a href="#Micrometer란" class="headerlink" title="Micrometer란?"></a>Micrometer란?</h1><p><a href="https://micrometer.io/" target="_blank" rel="noopener">micrometer.io</a>에서는 <code>Micrometer</code>에 대해서 다음과 같이 소개하고 있다.</p><blockquote><p><strong>Micrometer</strong> provides a simple <code>facade</code> over the instrumentation <code>clients</code> for the most popular <code>monitoring systems</code>, allowing you to instrument your <code>JVM-based application</code> code without vendor lock-in. Think <code>SLF4J</code>, but for metrics</p></blockquote><p><strong>Micrometer는 JVM 기반의 애플리케이션에서 다양한 모니터링 도구가 제공하는 클라이언트 라이브러리에 대한 <a href="https://ko.wikipedia.org/wiki/%ED%8D%BC%EC%82%AC%EB%93%9C_%ED%8C%A8%ED%84%B4" target="_blank" rel="noopener">facade</a>를 제공한다.</strong> 로깅 관련된 시스템에서는 SLF4J가 있다면 모니터링(metric) 시스템에서는 Micrometer가 있는 것이다.</p><p>즉, 모니터링 시스템을 만드는 vendor들은 Micrometer 인터페이스를 따르기 때문에 Micrometer를 사용하면 애플리케이션 내의 코드 상에서는 모니터링 시스템 클라이언트로 어떤 것을 사용할지에 대한 고민에서 벗어나 Micrometer를 이용해 애플리케이션 metric을 수집하기만 하면 된다.<br>(모니터링 시스템을 선택하는 것은 런타임 시점에 정해진다고 생각하면 된다.)</p><p>예를 들어, 모니터링 시스템으로 Prometheus를 사용한다고 하면 아래와 같이 표현할 수 있다.<br><img src="/images/post/2019-12-03/micrometer.png" alt="micrometer"></p><p>Micrometer는 다음과 같은 모니터링 시스템을 지원한다.</p><ul><li>AppOptics, Azure Monitor, Netflix Atlas, CloudWatch, Datadog, Dynatrace, Elastic, Ganglia, Graphite, Humio, Influx/Telegraf, JMX, KairosDB, New Relic, Prometheus, SignalFx, Google Stackdriver, StatsD, Wavefront</li></ul><p><strong>Micrometer에 의해서 기록된 애플리케이션의 metric 정보는 시스템의 이상 유뮤룰 판단하기 위한 모니터링(알람) 용도로 사용된다.</strong></p><h1 id="supported-monitoring-systems"><a href="#Supported-monitoring-systems" class="headerlink" title="Supported monitoring systems"></a>Supported monitoring systems</h1><p>Micrometer는 코어 모듈과 측정 <a href="https://en.wikipedia.org/wiki/Service_provider_interface" target="_blank" rel="noopener">SPI</a>(Service Provider Interface)를 포함하고 있다. (각각 Registry라고 부르는 다양한 모니터링 시스템에 대한 구현을 포함하고 있다.)<br>모니터링 시스템에는 중요한 3가지 특징이 있다.</p><h2 id="dimensionality"><a href="#Dimensionality" class="headerlink" title="Dimensionality"></a>Dimensionality</h2><p>Dimensionality는 수집하는 metric 이름에 tag(key-value)를 붙일 수 있도록 지원하는 것을 말한다. 반면 일부 모니터링 시스템의 경우에는 tag 형태가 아닌, flat한 metric name만 사용이 가능하다. 이를 hierarchical system이라고 한다.<br>Micrometer는 hierarchical system에 metric을 보낼 때는 tag를 metric name에 추가한다.</p><ul><li>Dimensional: AppOptics, Atlas, Azure Monitor, Cloudwatch, Datadog, Datadog StatsD, Dynatrace, Elastic, Humio, Influx, KairosDB, New Relic, <code>Prometheus</code>, SignalFx, Sysdig StatsD, Telegraf StatsD, Wavefront</li><li>Hierarchical: Graphite, Ganglia, JMX, Etsy StatsD</li></ul><h2 id="rate-aggregation"><a href="#Rate-aggregation" class="headerlink" title="Rate aggregation"></a>Rate aggregation</h2><p>모니터링 시스템 사용자들은 일정 시간 간격 동안의 특정 지표에 대한 평균값을 필요로 하는 경우가 많다. 어떤 모니터링 시스템은 애플리케이션에서 평균값을 직접 구해서 보내주기를 기대한다. 반면에 어떤 모니터링 시스템은 애플리케이션이 누적된 값을 보내주기를 기대하며, 모니터링 시스템이 직접 평균값을 구하는 경우도 있다.</p><ul><li>Client-side: AppOptics, Atlas, Azure Monitor, Datadog, Elastic, Graphite, Ganglia, Humio, Influx, JMX, Kairos, New Relic, all StatsD flavors, SignalFx</li><li>Server-side: <code>Prometheus</code>, Wavefront</li></ul><h2 id="publishing"><a href="#Publishing" class="headerlink" title="Publishing"></a>Publishing</h2><p>일부 모니터링 시스템은 metric 정보를 애플리케이션으로부터 polling한다. 반면 일부 모니터링 시스템은 애플리케이션이 일정한 간격으로 metric 정보를 push하는 방식으로 사용된다.</p><ul><li>Client pushes: AppOptics, Atlas, Azure Monitor, Datadog, Elastic, Graphite, Ganglia, Humio, Influx, JMX, Kairos, New Relic, SignalFx, Wavefront</li><li>Server polls: <code>Prometheus</code>, all StatsD flavors</li></ul><p>Micrometer 어떤 Registry를 사용하는지에 따라, 위와 같은 요구사항을 충족하도록 metric 정보를 커스터마이징한다.</p><h1 id="registry"><a href="#Registry" class="headerlink" title="Registry"></a>Registry</h1><p><code>Meter</code>는 애플리케이션의 metric을 수집하기 위한 인터페이스이다. Meter는 <code>MeterRegistry</code>에 의해 생성되어 등록된다. 지원되는 각 모니터링 시스템은 MeterRegistry 구현체를 갖고 있다.</p><p><code>SimpleMeterRegistry</code>는 각 meter의 최신 값을 메모리에 저장한다. 그리고 metric 정보를 다른 시스템으로 내보내지 않는다. 따라서 만약 어떤 모니터링 시스템을 사용할지 결정하지 못했다면 SimpleMegerRegistry를 사용하면 된다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br></pre></td></tr></table></figure></p><h2 id="composite-registries"><a href="#Composite-registries" class="headerlink" title="Composite registries"></a>Composite registries</h2><p>Micrometer는 여러 Registry를 추가할 수 있는 <code>CompositeMeterRegistry</code>를 제공한다. 따라서 CompositeMeterRegistry를 사용하면 둘 이상의 모니터링 시스템에서 동시에 metric을 사용할 수 있다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompositeMeterRegistry compositeRegistry = <span class="keyword">new</span> CompositeMeterRegistry();</span><br><span class="line">SimpleMeterRegistry oneSimpleMeter = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">AtlasMeterRegistry atlasMeterRegistry = <span class="keyword">new</span> AtlasMeterRegistry(atlasConfig, Clock.SYSTEM);</span><br><span class="line"> </span><br><span class="line">compositeRegistry.add(oneSimpleMeter);</span><br><span class="line">compositeRegistry.add(atlasMeterRegistry);</span><br></pre></td></tr></table></figure></p><h2 id="global-registry"><a href="#Global-registry" class="headerlink" title="Global registry"></a>Global registry</h2><p>Micrometer는 static 변수로 <code>Global MeterRegistry</code>를 제공한다. <a href="https://github.com/micrometer-metrics/micrometer/blob/master/micrometer-core/src/main/java/io/micrometer/core/instrument/Metrics.java#L35" target="_blank" rel="noopener">Metrics.globalRegistry</a>를 통해 static 변수에 접근할 수 있으며 Metrics 클래스에는 글로벌 MeterRegistry를 기반으로 Meter를 생성하는 정적 빌더 메소드가 있다.<br>Global MeterRegistry는 CompositeMeterRegistry 객체이다.</p><h1 id="meters"><a href="#Meters" class="headerlink" title="Meters"></a>Meters</h1><p>Micrometer는 Meter의 구현체로 다음의 것들을 지원한다. Meter의 type 별로 수집되는 metric 수가 다르다.</p><ul><li>Timer, Counter, Gauge, DistributionSummary, LongTaskTimer, FunctionCounter, FunctionTimer, TimeGauge</li></ul><p><strong>Meter는 <code>이름(name)</code>과 <code>태그(tag)</code>로 고유하게 식별된다.</strong></p><h2 id="naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h2><p>Micrometer는 소문자 단어를 ‘.’으로 구분하는 naming 규칙을 사용한다. 각각의 모니터링 시스템은 naming 규칙과 관련해 권장 사항을 갖고 있으며 일부 모니터링 시스템은 서로의 naming 규칙이 달라 호환되지 않을 수도 있다.</p><p>따라서 모니터링 시스템의 각 Micrometer 구현체는 소문자 단어와 ‘.’으로 구분된 이름을 각자의 모니터링 시스템 naming 규칙으로 변환하는 기능을 제공한다.</p><p>예를 들면 아래의 <code>timer</code> meter는 각각의 모니터링에서 다음과 같이 변경된다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry.timer(<span class="string">"http.server.requests"</span>);</span><br></pre></td></tr></table></figure></p><ul><li>Prometheus: <code>http_server_requests_duration_seconds</code></li><li>Atlas: <code>httpServerRequests</code></li><li>Graphite: <code>http.server.requests</code></li><li>InfluxDB: <code>http_server_requests</code></li></ul><p><strong>그러므로 Micrometer의 소문자 단어를 ‘.’으로 구분하는 naming 규칙을 사용하면 모니터링 시스템 종류에 상관없이 metric name에 대해 이식성을 보장할 수 있다.</strong></p><h2 id="counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h2><p>Counter는 애플리케이션에서 특정 속성에 대한 카운트를 기록한다. Build method 혹은 MetricRegistry의 helper method를 통해 custom counter를 생성할 수 있다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Counter counter = Counter</span><br><span class="line">  .builder(<span class="string">"instance"</span>)</span><br><span class="line">  .description(<span class="string">"indicates instance count of the object"</span>)</span><br><span class="line">  .tags(<span class="string">"dev"</span>, <span class="string">"performance"</span>)</span><br><span class="line">  .register(registry);</span><br><span class="line"> </span><br><span class="line">counter.increment(<span class="number">2.0</span>);</span><br><span class="line">  </span><br><span class="line">assertTrue(counter.count() == <span class="number">2</span>);</span><br><span class="line">  </span><br><span class="line">counter.increment(-<span class="number">1</span>); <span class="comment">// 카운트는 증가만 가능하다.</span></span><br><span class="line">  </span><br><span class="line">assertTrue(counter.count() == <span class="number">2</span>);</span><br></pre></td></tr></table></figure></p><h2 id="timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h2><p>시스템의 latency(지연 시간) 혹은 이벤트 빈도를 측정하기 위해서 Timers를 사용할 수 있다. Timer는 이벤트가 발생한 수와 총 시간을 기록한다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SimpleMeterRegistry registry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">Timer timer = registry.timer(<span class="string">"app.event"</span>);</span><br><span class="line">timer.record(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">1500</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123; &#125;</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">timer.record(<span class="number">3000</span>, MILLISECONDS);</span><br><span class="line"> </span><br><span class="line">assertTrue(<span class="number">2</span> == timer.count());</span><br><span class="line">assertTrue(<span class="number">4510</span> &gt; timer.totalTime(MILLISECONDS) &amp;&amp; <span class="number">4500</span> &lt;= timer.totalTime(MILLISECONDS));</span><br></pre></td></tr></table></figure></p><h2 id="gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h2><p>Gauge는 Meter의 현재 값을 보여준다. 다른 Meter와 다르게 Guage는 데이터의 변경이 관찰 된 경우에만 데이터를 기록한다. 캐시 등의 통계를 모니터링 할 때 유용하다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SimpleMeterRegistry registry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line">Gauge gauge = Gauge</span><br><span class="line">  .builder(<span class="string">"cache.size"</span>, list, List::size)</span><br><span class="line">  .register(registry);</span><br><span class="line"> </span><br><span class="line">assertTrue(gauge.value() == <span class="number">0.0</span>);</span><br><span class="line">  </span><br><span class="line">list.add(<span class="string">"1"</span>);</span><br><span class="line">  </span><br><span class="line">assertTrue(gauge.value() == <span class="number">1.0</span>);</span><br></pre></td></tr></table></figure></p><h1 id="binders"><a href="#Binders" class="headerlink" title="Binders"></a>Binders</h1><p>Micrometer에는 JVM, 캐시, ExecutorService 및 로깅 서비스를 모니터링하기 위한 여러 내장 Binder가 있다. </p><ul><li>JVM 및 시스템 모니터링: ClassLoaderMetrics</li><li>JVM memory pool: JvmMemoryMetrics</li><li>GC metrics: JvmGcMetrics</li><li>Thread 및 CPU 사용률: JvmThreadMetrics, ProcessorMetrics</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;micrometer란&quot;&gt;&lt;a href=&quot;#Micrometer란&quot; class=&quot;headerlink&quot; title=&quot;Micrometer란?&quot;&gt;&lt;/a&gt;Micrometer란?&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://micrometer.io/&quot;
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/tags/Spring/"/>
    
      <category term="Spring Boot" scheme="https://jongmin92.github.io/tags/Spring-Boot/"/>
    
      <category term="Micrometer" scheme="https://jongmin92.github.io/tags/Micrometer/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot에서의 Bean Validation (2)</title>
    <link href="https://jongmin92.github.io/2019/11/21/Spring/bean-validation-2/"/>
    <id>https://jongmin92.github.io/2019/11/21/Spring/bean-validation-2/</id>
    <published>2019-11-20T15:44:00.000Z</published>
    <updated>2019-11-21T16:15:27.240Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>해당 포스팅에서 사용된 예제 코드는 <a href="https://github.com/jongmin92/code-examples/tree/master/spring-boot/validation" target="_blank" rel="noopener">spring-boot validation example</a>에서 확인 가능합니다.</p></blockquote><h1 id="custom-validator"><a href="#Custom-Validator" class="headerlink" title="Custom Validator"></a>Custom Validator</h1><p>사용 가능한 <a href="https://docs.jboss.org/hibernate/beanvalidation/spec/2.0/api/javax/validation/constraints/package-summary.html" target="_blank" rel="noopener">constraint 어노테이션</a>이 제공하는 제약 조건 외에 필요한 경우, 직접 만들어서 사용할 수 있다.</p><p><a href="https://jongmin92.github.io/2019/11/18/Spring/bean-validation-1/">이전 포스팅</a>에서 <code>InPutRequest</code>와 <code>InputEntity</code> 클래스에서 정규식(Regular Expression)을 사용하여 String이 유효한 PinCode 형식(6자리)인지 확인했었다. 이 부분을 별도의 Validator를 구현해 대체해보려고 한다.</p><p>먼저, custom constraint 어노테이션 <code>PinCode</code>를 생성한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123; FIELD &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = PinCodeValidator.class)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PinCode &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "</span>&#123;PinCode.invalid&#125;<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>custom constraint 어노테이션에는 다음과 같은 것들이 필요하다.</p><ul><li>parameter <code>message</code>: <code>ValidationMessages.properties</code>에서 특정 property key를 가리키는 메시지 (제약 조건 위반시 메시지로 사용된다.)</li><li>parameter <code>groups</code>: 유효성 검사가 어떤 상황에서 실행되는지 정의할 수 있는 매개 변수 그룹.</li><li>parameter <code>payload</code>: 유효성 검사에 전달할 payload를 정의할 수 있는 매개 변수.</li><li><code>@Constraint</code>: <code>ConstraintValidator</code> interface 구현을 나타내는 어노테이션</li></ul><p>PinCode validator는 다음과 같이 구현한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PinCodeValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">PinCode</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Pattern pattern = Pattern.compile(<span class="string">"^[0-9]&#123;6&#125;$"</span>);</span><br><span class="line">        <span class="keyword">final</span> Matcher matcher = pattern.matcher(value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> matcher.matches();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이제 다른 constraint 어노테이션과 마찬가지로 @PinCode 어노테이션을 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InputEntityWithCustomValidator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PinCode</span></span><br><span class="line">    <span class="keyword">private</span> String pinCode;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="직접-validator를-생성해-validation-하기"><a href="#직접-Validator를-생성해-Validation-하기" class="headerlink" title="직접 Validator를 생성해 Validation 하기"></a>직접 Validator를 생성해 Validation 하기</h1><p>Spring이 지원하는 Bean Validator에 의존하지 않고 직접 Bean Validation을 하고자하는 경우가 있을 수 있다.</p><p>이 경우, 직접 <code>Validator</code>를 생성하고 validation을 할 수 있다. Spring의 지원이 전혀 필요하지 않다는 것이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectlyValidateService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateInput</span><span class="params">(InputEntity inputEntity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">        <span class="keyword">final</span> Validator validator = factory.getValidator();</span><br><span class="line">        <span class="keyword">final</span> Set&lt;ConstraintViolation&lt;InputEntity&gt;&gt; violations = validator.validate(inputEntity);</span><br><span class="line">        <span class="keyword">if</span> (!violations.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(violations);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그러나, Spring Boot는 이미 사전에 설정되어 만들어진 <code>Validator</code> 인스턴스를 제공한다. 그렇기 때문에 위와 같이 별도의 Validator 인스턴스를 직접 생성하지 않고 서비스에서 주입받아 사용하면 된다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectlyValidateService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Validator validator;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateInputWithInjectedValidator</span><span class="params">(InputEntity inputEntity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Set&lt;ConstraintViolation&lt;InputEntity&gt;&gt; violations = validator.validate(inputEntity);</span><br><span class="line">        <span class="keyword">if</span> (!violations.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(violations);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위의 Service는 Spring에 의해 Bean으로 생성될 때, Validator를 주입받게 된다.</p><p>위의 두 방법이 제대로 동작하는지 확인하기 위해 테스트 코드를 작성해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DirectlyValidateServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DirectlyValidateService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenInputEntityIsInvalid_thenThrowsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> InputEntity inputEntity = <span class="keyword">new</span> InputEntity();</span><br><span class="line">        inputEntity.setNumberBetweenOneAndTen(<span class="number">50</span>);</span><br><span class="line">        inputEntity.setNotEmptyString(<span class="string">""</span>);</span><br><span class="line">        inputEntity.setPinCode(<span class="string">"1234"</span>);</span><br><span class="line"></span><br><span class="line">        assertThrows(ConstraintViolationException.class, () -&gt; &#123;</span><br><span class="line">            service.validateInput(inputEntity);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">givenInjectedValidator_whenInputEntityIsInvalid_thenThrowsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> InputEntity inputEntity = <span class="keyword">new</span> InputEntity();</span><br><span class="line">        inputEntity.setNumberBetweenOneAndTen(<span class="number">50</span>);</span><br><span class="line">        inputEntity.setNotEmptyString(<span class="string">""</span>);</span><br><span class="line">        inputEntity.setPinCode(<span class="string">"1234"</span>);</span><br><span class="line"></span><br><span class="line">        assertThrows(ConstraintViolationException.class, () -&gt; &#123;</span><br><span class="line">            service.validateInputWithInjectedValidator(inputEntity);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="validation-groups"><a href="#Validation-Groups" class="headerlink" title="Validation Groups"></a>Validation Groups</h1><p>종종 특정 객체(클래스)는 서로 다른 상황에서 공유되어 사용될 수 있다.</p><p>예를 들면, CRUD와 같은 작업에서 “Create”와 “Update”를 수행할 때 같은 객체(클래스)를 사용하는 것이다. 그러나 다음의 경우처럼 서로 다른 상황에서 실행되어야 하는 validation이 있을 수 있다.</p><ul><li>“Create” 상황에서만 Validation</li><li>“Update” 상황에서만 Validation</li><li>두 가지 상황 모두에서 Validation</li></ul><p>위와 같이 Validation 규칙을 구현할 수 있는 Bean Validation 기능을 <code>Validation Groups</code>이라고 부른다.</p><p>이전에 custom constraint 어노테이션을 직접 만들면서 <code>groups</code> 필드가 반드시 있어야 하는것을 보았다. 이를 이용해서 Validation이 실행되어야 하는 특정 validation group을 명시할 수 있다.</p><p>CRUD 예제를 위해 <code>OnCreate</code>와 <code>OnUpdate</code>라는 2개의 marker interface를 정의한다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnCreate</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnUpdate</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure></p><p>그 다음 marker interface를 다음과 같은 constraint 어노테이션과 함께 사용할 수 있다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputEntityWithCustomValidator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Null</span>(groups = OnCreate.class)</span><br><span class="line">  <span class="meta">@NotNull</span>(groups = OnUpdate.class)</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>위의 코드는 “Create” 상황에서는 id가 null일 수 있고, “Update” 상황에서는 not null이어야 함을 의미한다.</p><p>Spring은 <code>@Validated</code> 어노테이션을 이용해 validation group을 사용할 수 있도록 지원한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateServiceWithGroups</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Validated</span>(OnCreate.class)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validateForCreate</span><span class="params">(@Valid InputEntityWithCustomValidator input)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Validated</span>(OnUpdate.class)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validateForUpdate</span><span class="params">(@Valid InputEntityWithCustomValidator input)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Validated</code> 어노테이션은 클래스에도 적용되어야 하며, validation group에 의한 Validation을 하기 위해서는 메서드에도 적용되어야 한다.</p><p>제대로 동작하는지 확인하기 위해 테스트 코드를 작성해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateServiceWithGroupsTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ValidateServiceWithGroups service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenInputIsInvalidForCreate_thenThrowsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InputEntityWithCustomValidator input = <span class="keyword">new</span> InputEntityWithCustomValidator();</span><br><span class="line">        input.setId(<span class="number">17L</span>);</span><br><span class="line">        input.setNumberBetweenOneAndTen(<span class="number">5</span>);</span><br><span class="line">        input.setNotEmptyString(<span class="string">"not empty"</span>);</span><br><span class="line">        input.setPinCode(<span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">        assertThrows(ConstraintViolationException.class, () -&gt; &#123;</span><br><span class="line">            service.validateForCreate(input);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenInputIsInvalidForUpdate_thenThrowsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InputEntityWithCustomValidator input = <span class="keyword">new</span> InputEntityWithCustomValidator();</span><br><span class="line">        input.setId(<span class="keyword">null</span>);</span><br><span class="line">        input.setNumberBetweenOneAndTen(<span class="number">5</span>);</span><br><span class="line">        input.setNotEmptyString(<span class="string">"not empty"</span>);</span><br><span class="line">        input.setPinCode(<span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">        assertThrows(ConstraintViolationException.class, () -&gt; &#123;</span><br><span class="line">            service.validateForUpdate(input);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;해당 포스팅에서 사용된 예제 코드는 &lt;a href=&quot;https://github.com/jongmin92/code-examples/tree/master/spring-boot/validation&quot; target=&quot;_blank&quot; 
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/tags/Spring/"/>
    
      <category term="Spring Boot" scheme="https://jongmin92.github.io/tags/Spring-Boot/"/>
    
      <category term="Bean Validation" scheme="https://jongmin92.github.io/tags/Bean-Validation/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot에서의 Bean Validation (1)</title>
    <link href="https://jongmin92.github.io/2019/11/18/Spring/bean-validation-1/"/>
    <id>https://jongmin92.github.io/2019/11/18/Spring/bean-validation-1/</id>
    <published>2019-11-17T15:35:00.000Z</published>
    <updated>2019-11-20T15:38:48.673Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://beanvalidation.org/news/2018/02/26/bean-validation-2-0-whats-in-it/" target="_blank" rel="noopener">Bean Validation</a>은 Java 생태계에서 유효성(Validation) 검증 로직을 구현하기위한 사실상의 표준이다. Bean Validation은 Spring과 Spring Boot에도 잘 통합되어 있다.</p><blockquote><p>해당 포스팅에서 사용된 예제 코드는 <a href="https://github.com/jongmin92/code-examples/tree/master/spring-boot/validation" target="_blank" rel="noopener">spring-boot validation example</a>에서 확인 가능합니다.</p></blockquote><h1 id="validation-설정"><a href="#Validation-설정" class="headerlink" title="Validation 설정"></a>Validation 설정</h1><p>Spring Boot에서의 Bean Validation은 <code>spring-boot-starter-validation</code>를 추가함으로써 사용할 수 있다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">'org.springframework.boot:spring-boot-starter-validation'</span>)</span><br></pre></td></tr></table></figure></p><p>Spring Dependency Management Gradle 플러그인(“io.spring.dependency-management”)을 사용한다면 현재 사용중인 Spring Boot 버전에서 자동으로 의존성(버전)을 가져오기 때문에 별도로 버전을 명시할 필요가 없다.</p><p>만약 <code>spring-boot-starter-web</code>를 포함하고 있다면 Validation Starter도 포함되어 있기 때문에 따로 추가할 필요는 없다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br></pre></td></tr></table></figure></p><blockquote><p>Validation Starter는 Bean Validation Specification 구현체 중 가장 널리 사용되고 있는 <a href="https://hibernate.org/validator/" target="_blank" rel="noopener">hibernate validator</a>를 포함하고 있다.</p></blockquote><h1 id="bean-validation-기본"><a href="#Bean-Validation-기본" class="headerlink" title="Bean Validation 기본"></a>Bean Validation 기본</h1><p><strong>기본적으로 Bean Validation은 클래스 필드에 특정 어노테이션(annotation)을 달아 제약 조건을 정의하는 방식으로 동작한다.</strong> 그 후 해당 클래스 객체를 <a href="https://docs.jboss.org/hibernate/beanvalidation/spec/2.0/api/javax/validation/Validator.html" target="_blank" rel="noopener">Validator</a>를 이용해 제약 조건의 충족 여부를 확인한다.</p><h1 id="spring-mvc-controller의-validation"><a href="#Spring-MVC-Controller의-Validation" class="headerlink" title="Spring MVC Controller의 Validation"></a>Spring MVC Controller의 Validation</h1><p>Spring RestController를 통해 Client로부터 전달받은 요청(request, input)에 대해 유효성을 검사하고자 한다. Client로부터 들어오는 다음의 3가지 요청 형식에 대해서 유효성 검사를 할 수 있다.</p><ul><li><strong>request body</strong></li><li><strong>path에 포함된 variables</strong> (ex. /foos/{id}의 id) </li><li><strong>query parameters</strong></li></ul><h2 id="request-body"><a href="#Request-Body" class="headerlink" title="Request Body"></a>Request Body</h2><p>POST 혹은 PUT 요청에서 request body에 JSON 형식의 데이터를 전달하는 것은 일반적이며, Spring은 JSON 형식의 데이터를 Java 객체에 자동으로 매핑한다. 이 과정에서 매핑되는 Java 객체가 요구 사항을 충족하는지 확인하려 한다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InputRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Min</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="meta">@Max</span>(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numberBetweenOneAndTen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty</span></span><br><span class="line">    <span class="keyword">private</span> String notEmptyString;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^[0-9]&#123;6&#125;$"</span>)</span><br><span class="line">    <span class="keyword">private</span> String pinCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>numberBetweenOneAndTen는 1에서 10 사이의 값을 가져야 하며, notEmptyString은 빈 문자열(“”)이 아니어야 하고, pinCode는 6자리의 숫자를 가져야 한다.</p><p>request body에서 <code>InputRequest</code> 객체를 가져와 유효성 검사를 하는 RestController는 다음과 같다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateRequestBodyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/validateBody"</span>)</span><br><span class="line">    <span class="function">ResponseEntity&lt;String&gt; <span class="title">validateBody</span><span class="params">(@Valid @RequestBody InputRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"valid"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>@RequestBody 어노테이션을 사용하고 있는 Input 매개변수에 <code>@Valid</code> 어노테이션만 추가하면 된다.</strong> 이로인해 Spring은 다른 작업을 수행하기 전에 먼저 객체를 Validator에 전달해서 유효성을 검사하게 된다.</p><blockquote><p>만약 <code>InputRequest</code> 클래스에 유효성을 검사해야하는 다른 객체가 필드로 포함된 경우, 이 필드에도 @Valid 어노테이션을 추가해야한다. 이러한 경우를 <strong>Complex Type</strong>이라고 부른다.</p></blockquote><p>유효성 검사에 실패할 경우 <code>MethodArgumentNotValidException</code> 예외가 발생한다. 기본적으로 Spring은 이 예외에 대해서 HTTP status code 400(Bad Request)으로 변환한다.</p><p>아래의 테스트 코드를 통해 동작을 확인할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension.class)</span><br><span class="line"><span class="meta">@WebMvcTest</span>(controllers = ValidateRequestBodyController.class)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateRequestBodyControllerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenInputRequestIsInvalid_thenReturnStatus400</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> InputRequest request = <span class="keyword">new</span> InputRequest();</span><br><span class="line">        request.setNumberBetweenOneAndTen(<span class="number">50</span>);</span><br><span class="line">        request.setNotEmptyString(<span class="string">""</span>);</span><br><span class="line">        request.setPinCode(<span class="string">"1234"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String body = objectMapper.writeValueAsString(request);</span><br><span class="line"></span><br><span class="line">        mvc.perform(post(<span class="string">"/validateBody"</span>)</span><br><span class="line">                            .contentType(<span class="string">"application/json"</span>)</span><br><span class="line">                            .content(body))</span><br><span class="line">           .andExpect(status().isBadRequest());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="path-variables-amp-request-parameters"><a href="#Path-Variables-amp-Request-Parameters" class="headerlink" title="Path Variables &amp; Request Parameters"></a>Path Variables &amp; Request Parameters</h2><p>path에 포함된 variables과 query parameters에 대한 유효성 검사는 조금 다르게 동작한다.</p><p>Path Variable과 Request Parameter의 경우는 int와 같은 primitive type이거나 Integer 혹은 String과 같은 객체이기 때문에 복잡한 유효성 검사를 하지 않는다.</p><p>클래스 필드에 직접 어노테이션을 추가하지 않고 다음과 같이 Controller 메소드 매개 변수에 직접 제약 조건을 추가한다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateParametersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/validatePathVariable/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">ResponseEntity&lt;String&gt; <span class="title">validatePathVariable</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> @<span class="title">Min</span><span class="params">(<span class="number">5</span>)</span> <span class="keyword">int</span> id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"valid"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/validateRequestParameter"</span>)</span><br><span class="line">    <span class="function">ResponseEntity&lt;String&gt; <span class="title">validateRequestParameter</span><span class="params">(@RequestParam(<span class="string">"param"</span>)</span> @<span class="title">Min</span><span class="params">(<span class="number">5</span>)</span> <span class="keyword">int</span> param) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"valid"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong><code>@Validated</code> 어노테이션을 클래스 레벨의 Controller에 추가해 Spring이 메서드 매개 변수에 대한 제한 조건 annotation을 평가하게 해야한다.</strong></p><p>request body 유효성 검사와 달리 실패할 경우 <code>MethodArgumentNotValidException</code> 예외가 아닌 <code>ConstraintViolationException</code> 예외가 발생한다. 주의할 것으로는 Spring은 <code>ConstraintViolationException</code> 예외에 대해서는 기본적으로 exception을 handling 하지 않기 때문에 HTTP status code 500(Internal Server Error)로 처리한다.</p><p>만약 HTTP status code 400(Bad Request)으로 처리하고자 한다면, custom exception handler를 사용하면 된다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateParametersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request mapping method omitted</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ConstraintViolationException.class)</span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.BAD_REQUEST)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function">String <span class="title">handleConstraintViolationException</span><span class="params">(ConstraintViolationException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"not valid due to validation error: "</span> + e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>테스트 코드를 통해 동작을 확인해보자.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension.class)</span><br><span class="line"><span class="meta">@WebMvcTest</span>(controllers = ValidateParametersController.class)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateParametersControllerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenPathVariableIsInValid_thenReturnStatus400</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mvc.perform(get(<span class="string">"/validatePathVariable/1"</span>))</span><br><span class="line">           .andExpect(status().isBadRequest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenRequestParameterIsInvalid_thenReturnStatus400</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mvc.perform(get(<span class="string">"/validateRequestParameter"</span>)</span><br><span class="line">                            .param(<span class="string">"param"</span>, <span class="string">"1"</span>))</span><br><span class="line">           .andExpect(status().isBadRequest());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="spring-service의-validation"><a href="#Spring-Service의-Validation" class="headerlink" title="Spring Service의 Validation"></a>Spring Service의 Validation</h1><p>Controller 레벨에서 입력을 검증하는것 뿐만 아니라 <code>@Validated</code>와 <code>@Valid</code> 어노테이션을 이용해 다른 Spring component에서도 입력에 대해 유효성을 검증할 수 있다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validateInputRequest</span><span class="params">(@Valid InputRequest input)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>@Validated</code> 어노테이션은 클래스 수준에서만 평가되기 때문에 메서드에는 추가하지 말아야 한다.</p><p>테스트 코드는 다음과 같다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ValidateService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenInputRequestIsInvalid_thenThrowException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> InputRequest request = <span class="keyword">new</span> InputRequest();</span><br><span class="line">        request.setNumberBetweenOneAndTen(<span class="number">50</span>);</span><br><span class="line">        request.setNotEmptyString(<span class="string">""</span>);</span><br><span class="line">        request.setPinCode(<span class="string">"1234"</span>);</span><br><span class="line"></span><br><span class="line">        assertThrows(ConstraintViolationException.class, () -&gt; &#123;</span><br><span class="line">            service.validateInputRequest(request);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="spring-repository의-validation"><a href="#Spring-Repository의-Validation" class="headerlink" title="Spring Repository의 Validation"></a>Spring Repository의 Validation</h1><p>유효성 검사를 위한 가장 마지막 계층은 persistence layer이다. 기본적으로 Spring Data는 Hibernate를 사용하여 Bean Validation을 지원한다.</p><h2 id="jpa-entities"><a href="#JPA-Entities" class="headerlink" title="JPA Entities"></a>JPA Entities</h2><p><code>InputEntity</code> 클래스의 객체를 DB에 저장하려고 한다. 먼저 필요한 JPA 어노테이션들을 추가한다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InputEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Min</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="meta">@Max</span>(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numberBetweenOneAndTen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty</span></span><br><span class="line">    <span class="keyword">private</span> String notEmptyString;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^[0-9]&#123;6&#125;$"</span>)</span><br><span class="line">    <span class="keyword">private</span> String pinCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>위의 Entity를 관리하는 CRUE Repository도 생성한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidateRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">InputEntity</span>, <span class="title">Long</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>기본적으로 제약 조건을 위반한 <code>InputEntity</code> 객체를 저장할 때 <code>ConstraintViolationException</code>이 발생한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith</span>(SpringExtension.class)</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateRepositoryTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ValidateRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenInputEntityIsInvalid_thenThrowsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> InputEntity inputEntity = <span class="keyword">new</span> InputEntity();</span><br><span class="line">        inputEntity.setNumberBetweenOneAndTen(<span class="number">50</span>);</span><br><span class="line">        inputEntity.setNotEmptyString(<span class="string">""</span>);</span><br><span class="line">        inputEntity.setPinCode(<span class="string">"1234"</span>);</span><br><span class="line"></span><br><span class="line">        assertThrows(ConstraintViolationException.class, () -&gt; &#123;</span><br><span class="line">            repository.save(inputEntity);</span><br><span class="line">            entityManager.flush();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Bean Validation은 <code>EntityManager</code>가 flush된 후에 트리거 된다.</strong> Hibernate는 특정 상황에서 <code>EntityManager</code>를 자동으로 flush하지만 integration test의 경우에는 직접 수행해야한다.</p><p>만약 Spring Data Repository에서 Bean Validation을 비활성화하려면 Spring Boot property인 <code>spring.jpa.properties.javax.persistence.validation.mode</code> 값을 <code>none</code>으로 설정하면 된다.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://beanvalidation.org/news/2018/02/26/bean-validation-2-0-whats-in-it/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Bean Validation&lt;/a&gt;은
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/tags/Spring/"/>
    
      <category term="Spring Boot" scheme="https://jongmin92.github.io/tags/Spring-Boot/"/>
    
      <category term="Bean Validation" scheme="https://jongmin92.github.io/tags/Bean-Validation/"/>
    
  </entry>
  
  <entry>
    <title>MySQL - Replication</title>
    <link href="https://jongmin92.github.io/2019/11/13/Database/mysql-replication/"/>
    <id>https://jongmin92.github.io/2019/11/13/Database/mysql-replication/</id>
    <published>2019-11-13T13:22:00.000Z</published>
    <updated>2019-11-17T15:15:00.004Z</updated>
    
    <content type="html"><![CDATA[<h1 id="database-replication"><a href="#Database-Replication" class="headerlink" title="Database Replication"></a>Database Replication</h1><p><strong>여러 대의 DB 서버가 있을 때 각각의 DB 서버가 동일한 데이터를 유지하도록 하는 메커니즘 혹은 기법을 말한다.</strong></p><p>Replication(리플리케이션)을 이용해서 <code>백업</code>과 <code>부하분산</code>같은 목적을 달성할 수 있다.<br>master 서버에 데이터가 기록(쓰기)되고, slave 서버들은 master에 기록된 데이터를 전파받으며 보통 읽기에 사용된다.</p><p>정리하면 한대의 master 서버는 쓰기, 여러대의 slave 서버들은 읽기에 사용되는 것이다.</p><h1 id="백업과-부하분산"><a href="#백업과-부하분산" class="headerlink" title="백업과 부하분산"></a>백업과 부하분산</h1><p><strong>master DB의 데이터가 빠른 속도로 slave DB에 복제되기 때문에 master DB에 문제가 생겼을 때, slave DB를 master DB로 대체해 빠르게 장애를 복구할 수 있다.</strong></p><p>그렇지만 <strong>Replication 자체가 완전한 백업을 의미하는 것은 아니다.</strong> master DB에 의도하지 않은 작업(데이터를 잘못해서 대량으로 삭제)을 수행했을 때 해당 작업이 slave DB에도 전파가 되기 때문에 이러한 것들은 복구가 불가능하다.<br>그러므로 실시간 성의 백업은 Replication이 담당하고, 시간차를 두고 백업이 필요한 것은 보통 스케쥴링을 통하여 시간 간격을 두고 백업을 하는것이 바람직하다.</p><p>읽기와 관련된 부하분산을 할 수 있다는 것이 Replication의 장점이다. 한계라고 하면 쓰기와 관련된 부분인데, 한 대의 master DB에 쓰기가 집중되기 때문에 쓰기 작업에 부하가 많다면 문제가 생길 수 있다.</p><p>간략하게 Replication이 동작하는 방식을 확인해보자. 아래 그림은 master DB와 slave DB가 1대1로 연결되어 있는 구조이다.</p><p><img src="/images/post/2019-11-13/replication_1.jpg" alt="replication-1"></p><ol><li>master DB가 Data의 변경사항을 <code>Binary log</code>에 기록한다.</li><li>master DB가 Slave DB에게 변경이 있음을 통지한다.</li><li>slave DB가 <code>I/O thread</code> 이용해 Binary log를 가져온다.</li><li>slave DB의 <code>Relay log</code>에 변경사항을 기록한다.</li><li>slave DB의 <code>SQL thread</code>를 이용해 변경사항을 반영한다.</li></ol><p>아래 그림은 또 다른 구조의 Replication이다. master DB와 slave DB가 존재하고 slave DB에 다시 slave DB가 존재하는 구조이다.<br>가운데의 slave DB가 master DB 처럼 Binary log를 생성해서 다른 slave에게 전달하는 것이다. 이 경우 가장 마지막에 있는 slave DB가 직접 master DB에 접근하는 것이 아니기 때문에 master DB의 부담을 줄일 수 있다.<br>또한 가운데의 slave DB 역시 master DB 처럼 Binary log를 생성하고 있기 때문에 master DB에 문제가 생겼을 때, 빠르고 쉽게 master DB로 대체가 가능하다.</p><p><img src="/images/post/2019-11-13/replication_2.jpg" alt="replication-2"></p><h1 id="replication-실습"><a href="#Replication-실습" class="headerlink" title="Replication 실습"></a>Replication 실습</h1><p>그럼 이제 간단하게 MySQL Replication을 구축해보자. 여러 대의 서버에 MySQL을 설치하고 준비하는 것은 번거롭기 때문에 간편하게 도커를 이용해서 진행해보자.</p><h2 id="mysql-master-컨테이너-실행하기"><a href="#MySQL-master-컨테이너-실행하기" class="headerlink" title="MySQL master 컨테이너 실행하기"></a>MySQL master 컨테이너 실행하기</h2><p>먼저 master DB 컨테이너를 생성하고 접속한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run --name mysql-master -e MYSQL_ROOT_PASSWORD=asdf1234 -d mysql</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-master /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt-get update; apt-get install vim -y</span></span><br></pre></td></tr></table></figure></p><p>설치한 vim을 이용해 MySQL 설정 파일인 <code>/etc/mysql/my.cnf</code> 파일에 다음의 내용을 추가한다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin  </span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure></p><blockquote><ul><li><strong>log-bin</strong>: 업데이트되는 모든 query들을 Binary log 파일에 기록한다는 의미이다.<br>기본적으로 Binary log 파일은 MySQL의 data directory인 /var/lib/mysql/ 에 호스트명-bin.000001, 호스트명-bin.000002 형태로 생성된다.<br>이때, log-bin 설정을 변경하면 Binary log 파일의 경로와 파일명의 접두어를 변경할 수 있다. log-bin=mysql 이라 설정하면 mysql-bin.000001, mysql-bin.000002 형태로 Binary log 파일이 생성된다.</li><li><strong>server-id</strong>: Replication 설정에서 서버를 식별하기 위한 고유 ID값이다. master, slave 각각 다르게 설정해야 한다.</li></ul></blockquote><p>도커 컨테이너(MySQL)를 재시작해서 변경된 설정 파일을 반영한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker restart mysql-master</span></span><br></pre></td></tr></table></figure></p><p>변경한 설정이 잘 적용되었는지 확인해보자.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-master /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p </span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS\G</span></span><br><span class="line"></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000001</span><br><span class="line">         Position: 155</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set:</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="master-db에-user-생성하기"><a href="#master-DB에-User-생성하기" class="headerlink" title="master DB에 User 생성하기"></a>master DB에 User 생성하기</h2><p>slave DB에서 접근할 수 있도록 master DB에 User 계정을 생성하고 <code>REPLICATION SLAVE</code> 권한을 부여한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE USER <span class="string">'repl'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'replpw'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER USER <span class="string">'repl'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'replpw'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO <span class="string">'repl'</span>@<span class="string">'%'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>User가 생성되었는지 User 테이블을 확인한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE mysql;</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT user, host FROM user;</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| user             | host      |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| repl             | %         |</span><br><span class="line">| root             | %         |</span><br><span class="line">| mysql.infoschema | localhost |</span><br><span class="line">| mysql.session    | localhost |</span><br><span class="line">| mysql.sys        | localhost |</span><br><span class="line">| root             | localhost |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>다음으로, Replication 테스트를 위한 DB와 테이블을 생성한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE testdb;</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE testdb;</span></span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE TABLE testtable ( text varchar(20) );</span></span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> DESC testtable;</span></span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| text  | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO testtable VALUES (<span class="string">'test row'</span>);</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * from testtable;</span></span><br><span class="line">+----------+</span><br><span class="line">| text     |</span><br><span class="line">+----------+</span><br><span class="line">| test row |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="master-db-dump"><a href="#master-DB-dump" class="headerlink" title="master DB dump"></a>master DB dump</h2><p>slave DB에서 master DB를 연결하기 전에 master DB의 현재 DB 상태(table과 data)를 slave DB에 그대로 반영하기 위해 dump한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-master /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysqldump -u root -p testdb &gt; dump.sql</span></span><br></pre></td></tr></table></figure></p><p>dump된 파일을 slave DB 컨테이너에 옮기기 위해 먼저 로컬 PC로 복사한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker cp mysql-master:dump.sql .</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat dump.sql</span></span><br></pre></td></tr></table></figure></p><h2 id="mysql-slave-컨테이너-실행하기"><a href="#MySQL-slave-컨테이너-실행하기" class="headerlink" title="MySQL slave 컨테이너 실행하기"></a>MySQL slave 컨테이너 실행하기</h2><p>slave DB 컨테이너를 생성하고 접속한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run --name mysql-slave --link mysql-master -e MYSQL_ROOT_PASSWORD=asdf1234 -d mysql</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-slave /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt-get update; apt-get install vim -y</span></span><br></pre></td></tr></table></figure></p><p>설치한 vim을 이용해 MySQL 설정 파일인 <code>/etc/mysql/my.cnf</code> 파일에 다음의 내용을 추가한다.<br>slave 서버를 여러 대로 구축하고자 할 때에 각 slave 서버의 server-id는 각각 달라야 한다는 것에 주의하자. (2^32-1 까지 가능하다.)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin  </span><br><span class="line">server-id=2</span><br></pre></td></tr></table></figure></p><p>도커 컨테이너(MySQL)를 재시작해서 변경된 설정 파일을 반영한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker restart mysql-slave</span></span><br></pre></td></tr></table></figure></p><h2 id="slave-db에-dump-파일-적용"><a href="#slave-DB에-dump-파일-적용" class="headerlink" title="slave DB에 dump 파일 적용"></a>slave DB에 dump 파일 적용</h2><p>로컬 PC로 복사한 master DB의 dump 파일을 slave DB로 옮긴 후 반영한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker cp dump.sql mysql-slave:.</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-slave /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE testdb;</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p testdb &lt; dump.sql</span></span><br></pre></td></tr></table></figure></p><p>다시 mysql에 접속해 <code>testdb</code> DB에 <code>testtable</code> 테이블과 데이터가 생성되어 있다면 정상적으로 dump 파일이 적용된 것이다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE testdb;</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW TABLES;</span></span><br><span class="line">+------------------+</span><br><span class="line">| Tables_in_testdb |</span><br><span class="line">+------------------+</span><br><span class="line">| testtable        |</span><br><span class="line">+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="slave-db에서-master-db-연동하기"><a href="#slave-DB에서-master-DB-연동하기" class="headerlink" title="slave DB에서 master DB 연동하기"></a>slave DB에서 master DB 연동하기</h2><p>이제 마지막으로 slave 서버에서 master 서버와 연동하는 작업만 하면 된다.</p><p>그 전에 master DB의 mysql에 한번 더 접속하여 Binary log 파일의 현재 상태를 읽어야 한다. 이 <strong>Binary log 파일을 통해 master와 slave의 DB가 동기화되므로 반드시 동일한 로그의 위치를 서로 참조하고 있어야 한다.</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-master /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS\G </span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000001</span><br><span class="line">         Position: 1949</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set:</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>출력된 결과에서 File, Position 필드의 값을 기억하도록 한다.<br><strong><code>File</code> 은 현재 바이너리 로그 파일명이고, <code>Position</code> 은 현재 로그의 위치를 나타낸다.</strong> 앞서 DB와 테이블을 생성한 query가 추가됐으므로 이전에 <strong>SHOW MASTER STATUS\G</strong> 를 실행했을 때보다 Position 값이 증가했음을 볼 수 있다.</p><p>이제 slave 서버의 mysql에 접속하여 master 서버와의 연결에 필요한 변수들을 적절히 설정해주어야 한다.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-slave /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p  </span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'mysql-master'</span>, MASTER_USER=<span class="string">'repl'</span>, MASTER_PASSWORD=<span class="string">'replpw'</span>, MASTER_LOG_FILE=<span class="string">'mysql-bin.000001'</span>, MASTER_LOG_POS=1949;</span></span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><blockquote><ul><li>MASTER_HOST : master 서버의 호스트명</li><li>MASTER_USER : master 서버의 mysql에서 REPLICATION SLAVE 권한을 가진 User 계정의 이름</li><li>MASTER_PASSWORD : master 서버의 mysql에서 REPLICATION SLAVE 권한을 가진 User 계정의 비밀번호</li><li>MASTER_LOG_FILE : master 서버의 바이너리 로그 파일명</li><li>MASTER_LOG_POS : master 서버의 현재 로그의 위치</li></ul></blockquote><p>아래의 명령어를 실행해 slave의 상태를 확인해보자.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br></pre></td></tr></table></figure></p><h2 id="replication-테스트"><a href="#Replication-테스트" class="headerlink" title="Replication 테스트"></a>Replication 테스트</h2><p>문제 없이 Replication 설정이 완료되었다면 마지막으로 실제 잘 동작하는지 확인해보자.<br>master DB에서 데이터를 생성하고, slave DB에 복제되어 데이터가 조회되는지 확인한다.</p><p>master DB에서 데이터를 생성한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-master /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE testdb;</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO testtable VALUES (<span class="string">'test row2'</span>);</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM testtable;</span></span><br><span class="line">+-----------+</span><br><span class="line">| text      |</span><br><span class="line">+-----------+</span><br><span class="line">| test row  |</span><br><span class="line">| test row2 |</span><br><span class="line">+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>slave DB에서 데이터를 조회한다.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql-slave /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -p</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * from testtable;</span></span><br><span class="line">+-----------+</span><br><span class="line">| text      |</span><br><span class="line">+-----------+</span><br><span class="line">| test row  |</span><br><span class="line">| test row2 |</span><br><span class="line">+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;database-replication&quot;&gt;&lt;a href=&quot;#Database-Replication&quot; class=&quot;headerlink&quot; title=&quot;Database Replication&quot;&gt;&lt;/a&gt;Database Replication&lt;/h1&gt;&lt;
      
    
    </summary>
    
      <category term="Database" scheme="https://jongmin92.github.io/categories/Database/"/>
    
    
      <category term="MySQL" scheme="https://jongmin92.github.io/tags/MySQL/"/>
    
      <category term="Replication" scheme="https://jongmin92.github.io/tags/Replication/"/>
    
      <category term="MMM" scheme="https://jongmin92.github.io/tags/MMM/"/>
    
  </entry>
  
  <entry>
    <title>Reactive Streams (3)</title>
    <link href="https://jongmin92.github.io/2019/11/10/Java/reactive-3/"/>
    <id>https://jongmin92.github.io/2019/11/10/Java/reactive-3/</id>
    <published>2019-11-10T12:01:00.000Z</published>
    <updated>2019-11-12T15:20:06.785Z</updated>
    
    <content type="html"><![CDATA[<p><strong>“<code>Reactive Streams</code>란 non-blocking과 back pressure를 이용한 asynchronous 스트림 처리의 표준이다.”</strong> 라고 지난 글에서 이야기 했다.</p><p>이번에는 <code>asynchronous(비동기 처리)</code>에 대해서 이야기해보자.</p><p>먼저 아래 간단한 코드를 실행해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Publisher&lt;Integer&gt; pub = <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">                sub.onSubscribe(<span class="keyword">new</span> Subscription() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">                        sub.onNext(<span class="number">1</span>);</span><br><span class="line">                        sub.onNext(<span class="number">2</span>);</span><br><span class="line">                        sub.onNext(<span class="number">3</span>);</span><br><span class="line">                        sub.onNext(<span class="number">4</span>);</span><br><span class="line">                        sub.onNext(<span class="number">5</span>);</span><br><span class="line">                        sub.onComplete();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;Integer&gt; sub = <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onSubscribe"</span>);</span><br><span class="line">                s.request(Long.MAX_VALUE);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onNext: &#123;&#125;"</span>, integer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onError"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onComplete"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        pub.subscribe(sub);</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">"Exit)"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 실행결과</span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.475</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onSubscribe</span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.480</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - request: <span class="number">9223372036854775807</span></span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">5</span></span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - onComplete</span><br><span class="line"><span class="number">23</span>:<span class="number">27</span>:<span class="number">45.484</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - exit</span><br></pre></td></tr></table></figure><p>subscriber를 publisher에 등록(subscribe)하고 처리(onSubscribe -&gt; request -&gt; next)가 끝나면 exit 로그를 마지막으로 종료된다. 이때 subscriber와 publisher의 진행은 모두 main 스레드에서 진행된다.<br>즉, subscriber를 등록 후 publisher가 데이터를 push하고 처리할 때까지 main 스레드를 붙잡고 있게 된다.<br>만약 publisher 혹은 subscriber의 처리가 지연된다면 main 스레드는 더욱 오래 사용해야 할 것이다.</p><p>결국 publisher에 subscriber를 등록하면 별도의 스레드에서 진행하고 main 스레드는 계속해서 다른 작업을 진행하기를 원하는 것이다.</p><h1 id="publishon"><a href="#publishOn" class="headerlink" title="publishOn"></a>publishOn</h1><p>먼저 publisher가 main 스레드가 아닌 별도의 스레드에서 동작하도록 만들어보자.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">publishOn</span><span class="params">(Publisher&lt;Integer&gt; pub)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">            Executors.newSingleThreadExecutor().execute(() -&gt; &#123;</span><br><span class="line">                pub.subscribe(sub);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>파라미터로 전달받은 publisher의 subscribe 메서드를 별도의 스레드에서 실행하도록 하는 publisher를 새로 만들어서 반환한다. publishOn 메서드를 기존의 publisher에 적용해 실행하면 다음과 같이 실행결과를 확인할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- 실행결과</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.820</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - exit</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.820</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onSubscribe</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.824</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - request: <span class="number">9223372036854775807</span></span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.827</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.827</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.827</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.827</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.827</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">5</span></span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">57.827</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onComplete</span><br></pre></td></tr></table></figure><p>main 스레드는 바로 해제되어 이후의 일을 진행할 수 있게 되었고 onSubscribe 이후의 처리는 모두 별도의 스레드에서 진행된다.</p><p>그러나 아직 “빠른 프로듀서”와 “느린 컨슈머”의 문제가 남아있다. publisher가 데이터를 빠르게 생산하지만 subscriber의 onNext에서 데이터를 소비하는 작업에 시간이 오래 걸리는 경우인 것이다.<br>이때는 subscriber 또한 별도의 스레드에서 onNext 처리를 하도록 함으로써 해결할 수 있다.</p><h1 id="subscribeon"><a href="#subscribeOn" class="headerlink" title="subscribeOn"></a>subscribeOn</h1><p>subscriber도 별도의 스레드에서 동작하도록 만들어보자.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Subscriber&lt;Integer&gt; <span class="title">subscriberOn</span><span class="params">(Subscriber&lt;Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">            Executors.newSingleThreadExecutor().execute(() -&gt; sub.onSubscribe(s));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">            Executors.newSingleThreadExecutor().execute(() -&gt; sub.onNext(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">            Executors.newSingleThreadExecutor().execute(() -&gt; sub.onError(t));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Executors.newSingleThreadExecutor().execute(() -&gt; sub.onComplete());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>파라미터로 전달받은 subscriber의 onSubscribe, onNext, onError, onComplete 메서드를 별도의 스레드에서 실행하도록 하는 subscriber를 새로 만들어서 반환한다. subscriberOn 메서드를 기존의 subscriber에 적용해 실행하면 다음과 같이 실행결과를 확인할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- 실행결과</span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.604</span> [main] INFO com.jongmin.reactive.practice.SchedulerEx - exit</span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.604</span> [pool-<span class="number">2</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onSubscribe</span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.607</span> [pool-<span class="number">2</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - request: <span class="number">9223372036854775807</span></span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.609</span> [pool-<span class="number">3</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.609</span> [pool-<span class="number">4</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">2</span></span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.609</span> [pool-<span class="number">5</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.609</span> [pool-<span class="number">6</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">4</span></span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.610</span> [pool-<span class="number">7</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onNext: <span class="number">5</span></span><br><span class="line"><span class="number">00</span>:<span class="number">14</span>:<span class="number">53.610</span> [pool-<span class="number">8</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.SchedulerEx - onComplete</span><br></pre></td></tr></table></figure><p>이제는 main 스레드는 subscriber를 publisher에 등록(subscribe)까지만 하고 그 이후의 작업은 publisher와 subscriber 모두 별도의 스레드에서 동작하게 되었다.</p><p>전체 코드는 다음과 같다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Publisher&lt;Integer&gt; pub = <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">                sub.onSubscribe(<span class="keyword">new</span> Subscription() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">                        log.info(<span class="string">"request: &#123;&#125;"</span>, n);</span><br><span class="line">                        sub.onNext(<span class="number">1</span>);</span><br><span class="line">                        sub.onNext(<span class="number">2</span>);</span><br><span class="line">                        sub.onNext(<span class="number">3</span>);</span><br><span class="line">                        sub.onNext(<span class="number">4</span>);</span><br><span class="line">                        sub.onNext(<span class="number">5</span>);</span><br><span class="line">                        sub.onComplete();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;Integer&gt; sub = <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onSubscribe"</span>);</span><br><span class="line">                s.request(Long.MAX_VALUE);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onNext: &#123;&#125;"</span>, integer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onError"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onComplete"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        publishOn(pub).subscribe(subscriberOn(sub));</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"exit"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">publishOn</span><span class="params">(Publisher&lt;Integer&gt; pub)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">                Executors.newSingleThreadExecutor().execute(() -&gt; &#123;</span><br><span class="line">                    pub.subscribe(sub);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Subscriber&lt;Integer&gt; <span class="title">subscriberOn</span><span class="params">(Subscriber&lt;Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">                Executors.newSingleThreadExecutor().execute(() -&gt; sub.onSubscribe(s));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">                Executors.newSingleThreadExecutor().execute(() -&gt; sub.onNext(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                Executors.newSingleThreadExecutor().execute(() -&gt; sub.onError(t));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Executors.newSingleThreadExecutor().execute(() -&gt; sub.onComplete());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;“&lt;code&gt;Reactive Streams&lt;/code&gt;란 non-blocking과 back pressure를 이용한 asynchronous 스트림 처리의 표준이다.”&lt;/strong&gt; 라고 지난 글에서 이야기 했다.&lt;/p&gt;
&lt;p&gt;이번
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Reactive" scheme="https://jongmin92.github.io/tags/Reactive/"/>
    
  </entry>
  
  <entry>
    <title>Reactive Streams (2)</title>
    <link href="https://jongmin92.github.io/2019/11/07/Java/reactive-2/"/>
    <id>https://jongmin92.github.io/2019/11/07/Java/reactive-2/</id>
    <published>2019-11-07T13:17:00.000Z</published>
    <updated>2019-11-07T16:03:39.215Z</updated>
    
    <content type="html"><![CDATA[<p>지난번 Reactive Streams API를 구현한 예제를 바탕으로 간단한 Operator를 만들어보자.</p><p>Operator라 함은 Stream의 <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#map-java.util.function.Function-" target="_blank" rel="noopener">map</a>연산 처럼 Publisher가 제공하는 data를 가공할 수 있도록 하는 것이다.</p><p>먼저 간단한 Publisher와 Subscriber 코드이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PubSub</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Publisher&lt;Integer&gt; pub = iterPub(Stream.iterate(<span class="number">1</span>, a -&gt; a + <span class="number">1</span>)</span><br><span class="line">                                               .limit(<span class="number">5</span>)</span><br><span class="line">                                               .collect(Collectors.toList()));</span><br><span class="line">        pub.subscribe(logSub());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">iterPub</span><span class="params">(List&lt;Integer&gt; iter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber sub)</span> </span>&#123;</span><br><span class="line">                sub.onSubscribe(<span class="keyword">new</span> Subscription() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">                        iter.forEach(i -&gt; sub.onNext(i));</span><br><span class="line">                        sub.onComplete();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Subscriber&lt;Integer&gt; <span class="title">logSub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onSubscribe"</span>);</span><br><span class="line">                s.request(Long.MAX_VALUE);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onNext: &#123;&#125;"</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onError"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onComplete"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 실행결과</span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.255</span> [main] INFO com.jongmin.reactive.practice.PubSub - onSubscribe</span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.260</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.262</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.262</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.262</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.262</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">5</span></span><br><span class="line"><span class="number">23</span>:<span class="number">32</span>:<span class="number">28.262</span> [main] INFO com.jongmin.reactive.practice.PubSub - onComplete</span><br></pre></td></tr></table></figure><h1 id="operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h1><p><strong>Publisher -&gt; [Data1] -&gt; <code>Operator</code> -&gt; [Data2] -&gt; Subscriber</strong></p><p>위와 같이 Data1을 Data2로 변환하는 Operator를 만들어보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PubSub</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Publisher&lt;Integer&gt; pub = iterPub(Stream.iterate(<span class="number">1</span>, a -&gt; a + <span class="number">1</span>)</span><br><span class="line">                                               .limit(<span class="number">5</span>)</span><br><span class="line">                                               .collect(Collectors.toList()));</span><br><span class="line">        Publisher&lt;Integer&gt; mapPub = mapPub(pub, s -&gt; s * <span class="number">10</span>);</span><br><span class="line">        <span class="comment">// iterrPub -&gt; [Data1] -&gt; mapPub -&gt; [Data2]  -&gt; logSub</span></span><br><span class="line">        mapPub.subscribe(logSub());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">mapPub</span><span class="params">(Publisher&lt;Integer&gt; pub, Function&lt;Integer, Integer&gt; f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">                pub.subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">                        sub.onSubscribe(s);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">                        sub.onNext(f.apply(i));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                        sub.onError(t);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        sub.onComplete();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">iterPub</span><span class="params">(List&lt;Integer&gt; iter)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Subscriber&lt;Integer&gt; <span class="title">logSub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 실행결과</span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.758</span> [main] INFO com.jongmin.reactive.practice.PubSub - onSubscribe</span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.764</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">10</span></span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.767</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">20</span></span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.767</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">30</span></span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.767</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">40</span></span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.767</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">50</span></span><br><span class="line"><span class="number">23</span>:<span class="number">45</span>:<span class="number">19.767</span> [main] INFO com.jongmin.reactive.practice.PubSub - onComplete</span><br></pre></td></tr></table></figure><p>mapPub 메서드가 추가되었다. Data를 제공하는 Publisher와 가공에 사용할 Function을 받아 Operator(새로운 Publisher)를 반환한다.</p><p>실제 하는 일은 단순하다. 기존 Publisher와 Subscriber를 이어준다.</p><p>Operator가 기존 Publisher를 subscribe하고, 받게되는 Subscription을 기존 Subscriber에게 전달한다. </p><h1 id="delegatesub"><a href="#DelegateSub" class="headerlink" title="DelegateSub"></a>DelegateSub</h1><p>Operator가 하는 일은 기존 Publisher와 Subscriber를 이어주면서, onNext 부분에서 전달받은 Function을 적용해주는 것 뿐이다.</p><p>onNext를 제외하고는 Operator 마다 코드가 반복될 수 있기 때문에 해당 부분을 DelegateSub으로 분리해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelegateSub</span> <span class="keyword">implements</span> <span class="title">Subscriber</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    Subscriber sub;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelegateSub</span><span class="params">(Subscriber sub)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sub = sub;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">        sub.onSubscribe(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">        sub.onNext(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">        sub.onError(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sub.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DelegateSub을 사용해서 기존 코드를 다음과 같이 수정할 수 있다. 필요한 onNext 메서드만 오버라이딩해서 사용한다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PubSub2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Publisher&lt;Integer&gt; pub = iterPub(Stream.iterate(<span class="number">1</span>, a -&gt; a + <span class="number">1</span>)</span><br><span class="line">                                               .limit(<span class="number">5</span>)</span><br><span class="line">                                               .collect(Collectors.toList()));</span><br><span class="line">        Publisher&lt;Integer&gt; mapPub = mapPub(pub, s -&gt; s * <span class="number">10</span>);</span><br><span class="line">        mapPub.subscribe(logSub());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">mapPub</span><span class="params">(Publisher&lt;Integer&gt; pub, Function&lt;Integer, Integer&gt; f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">                pub.subscribe(<span class="keyword">new</span> DelegateSub(sub) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">                        sub.onNext(f.apply(i));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">iterPub</span><span class="params">(List&lt;Integer&gt; iter)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Subscriber&lt;Integer&gt; <span class="title">logSub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="subpub"><a href="#SubPub" class="headerlink" title="SubPub"></a>SubPub</h1><p>이번에는 Publisher로부터 전달받은 Data를 전부 더하는 sum operation을 만들어보자.</p><p>기존 Publisher와 Subscriber를 onNext로 이어주지 않고, onComplete이 호출되었을 때, sum 값을 onNext로 전달한 뒤 onComplete을 호출해 종료한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PubSub2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Publisher&lt;Integer&gt; pub = iterPub(Stream.iterate(<span class="number">1</span>, a -&gt; a + <span class="number">1</span>)</span><br><span class="line">                                               .limit(<span class="number">5</span>)</span><br><span class="line">                                               .collect(Collectors.toList()));</span><br><span class="line">        Publisher&lt;Integer&gt; sumPub = sumPub(pub);</span><br><span class="line">        sumPub.subscribe(logSub());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">sumPub</span><span class="params">(Publisher&lt;Integer&gt; pub)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Publisher&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Integer&gt; sub)</span> </span>&#123;</span><br><span class="line">                pub.subscribe(<span class="keyword">new</span> DelegateSub(sub) &#123;</span><br><span class="line">                    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">                        sum += i;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        sub.onNext(sum);</span><br><span class="line">                        sub.onComplete();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Publisher&lt;Integer&gt; <span class="title">iterPub</span><span class="params">(List&lt;Integer&gt; iter)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Subscriber&lt;Integer&gt; <span class="title">logSub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 실행결과</span><br><span class="line"><span class="number">00</span>:<span class="number">30</span>:<span class="number">48.643</span> [main] INFO com.jongmin.reactive.practice.PubSub - onSubscribe</span><br><span class="line"><span class="number">00</span>:<span class="number">30</span>:<span class="number">48.648</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">15</span></span><br><span class="line"><span class="number">00</span>:<span class="number">30</span>:<span class="number">48.650</span> [main] INFO com.jongmin.reactive.practice.PubSub - onComplete</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;지난번 Reactive Streams API를 구현한 예제를 바탕으로 간단한 Operator를 만들어보자.&lt;/p&gt;
&lt;p&gt;Operator라 함은 Stream의 &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/ap
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Reactive" scheme="https://jongmin92.github.io/tags/Reactive/"/>
    
  </entry>
  
  <entry>
    <title>Reactive Streams (1)</title>
    <link href="https://jongmin92.github.io/2019/11/05/Java/reactive-1/"/>
    <id>https://jongmin92.github.io/2019/11/05/Java/reactive-1/</id>
    <published>2019-11-04T16:03:00.000Z</published>
    <updated>2019-11-07T14:25:49.330Z</updated>
    
    <content type="html"><![CDATA[<h1 id="reactive-streams-란"><a href="#Reactive-Streams-란" class="headerlink" title="Reactive Streams 란?"></a>Reactive Streams 란?</h1><p><a href="http://www.reactive-streams.org/" target="_blank" rel="noopener">reactive-streams.org</a> 에서는 <code>Reactive Streams</code>를 다음과 같이 정의하고 있다.</p><blockquote><p>Reactive Streams is an initiative to provide a standard for asynchronous stream processing with non-blocking back pressure. </p></blockquote><p><strong><code>Reactive Streams</code>란 non-blocking과 back pressure를 이용한 asynchronous 스트림 처리의 표준이다.</strong></p><p>중요한 키워드가 여러개 등장 했는데, 먼저 back pressure에 대해서 알아보자.</p><h1 id="back-pressure"><a href="#Back-Pressure" class="headerlink" title="Back Pressure"></a>Back Pressure</h1><p><code>Back Pressure</code>는 Reactive Streams에서 가장 중요한 요소라고 할 수 있다. Back Pressure가 등장하게 된 배경을 이해하기 위해서 먼저 옵저버 패턴을 이해하고 옵저버 패턴이 갖고 있는 문제점을 인식할 수 있어야한다.</p><h2 id="observable-amp-observer"><a href="#Observable-amp-Observer" class="headerlink" title="Observable &amp; Observer"></a>Observable &amp; Observer</h2><blockquote><p><strong>옵저버 패턴(observer pattern)</strong> 은 객체의 상태 변화를 관찰하는 관찰자들, 즉 옵저버들의 목록을 객체에 등록하여 상태 변화가 있을 때마다 메서드 등을 통해 객체가 직접 목록의 각 옵저버에게 통지하도록 하는 디자인 패턴이다. 주로 분산 이벤트 핸들링 시스템을 구현하는 데 사용된다. 발행/구독 모델로 알려져 있기도 하다.</p><p><a href="https://ko.wikipedia.org/wiki/%EC%98%B5%EC%84%9C%EB%B2%84_%ED%8C%A8%ED%84%B4" target="_blank" rel="noopener">옵저버 패턴 - 위키백과</a></p></blockquote><p>예를 들면, 안드로이드에서 Button이 클릭되었을 때 실행할 함수를 onclicklistener에 추가하는데 이와 같이 이벤트 핸들링 처리를 위해 사용되는 패턴이다. 이 패턴에는 Observable과 Observer가 등장한다.</p><ul><li><strong>Osbservable</strong>: 등록된 Observer들을 관리하며, 새로운 데이터(이벤트)가 들어오면 등록된 Observer에게 데이터를 전달한다. 데이터를 생성해서 전달하기 때문에 <strong>Publisher</strong>(발행)라고 부른다.</li><li><strong>Observer</strong>: Observable로 부터 데이터(이벤트)를 받을 수 있다. 데이터를 전달 받기 때문에 <strong>Subscriber</strong>(구독)라고 부른다.</li></ul><p>Java는 이미 JDK 1.0 부터 옵저버 패턴을 쉽게 구현할 수 있는 인터페이스를 제공하고 있다. 아래의 코드는 JDK 1.0에 포함된 Observable과 Observer 인터페이스를 사용해 만든 간단한 예시 코드이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ob</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Source -&gt; Event/Data -&gt; Observer</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">                setChanged();</span><br><span class="line">                notifyObservers(i);         <span class="comment">// push</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Observer ob = <span class="keyword">new</span> Observer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"&#123;&#125;"</span>, arg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        IntObservable io = <span class="keyword">new</span> IntObservable();</span><br><span class="line">        io.addObserver(ob);</span><br><span class="line"></span><br><span class="line">        ExecutorService es = Executors.newSingleThreadExecutor();</span><br><span class="line">        es.execute(io);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"EXIT"</span>);</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 실행결과</span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.715</span> [main] INFO com.jongmin.reactive.practice.Ob - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.715</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">2</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">4</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">5</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">6</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">7</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">8</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">47</span>:<span class="number">30.719</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.jongmin.reactive.practice.Ob - <span class="number">10</span></span><br></pre></td></tr></table></figure><h2 id="문제점"><a href="#문제점" class="headerlink" title="문제점"></a>문제점</h2><p>옵저버 패턴에서는 Publisher(Observable)이 Subscriber(Observer)에게 데이터(이벤트)를 Push(notifyObservers)하는 방식으로 전달한다. 이때, Publisher는 Subscriber의 상태에 상관없이 데이터를 전달하는데만 집중한다.</p><p>만약, Subscriber는 1초에 10개의 데이터를 처리할 수 있는데 Publisher가 1초에 20개의 데이터를 전달(Push)한다면 어떤 문제가 발생할까? 다음과 같은 문제가 발생할 수 있다.</p><ul><li>Subscriber에 별도의 queue(버퍼)를 두고 처리하지 않고 대기중인 데이터를 저장할 수 있다.</li><li>하지만, queue의 사용 가능한 공간도 전부 금방 소모될 것이다.</li><li>queue의 크기를 넘어가게 되면 데이터는 소실될 것이다.</li><li>queue의 크기를 너무 크게 생성하면 OOM(Out Of Memory) 문제가 발생할 수 있다.</li></ul><h2 id="해결-방법"><a href="#해결-방법" class="headerlink" title="해결 방법"></a>해결 방법</h2><p>Observable과 Observer의 문제를 어떻게 해결할 수 있을까? Publisher가 Subscriber에게 데이터를 Push 하던 기존의 방식을 Subscriber가 Publisher에게 자신이 <strong>처리할 수 있는 만큼의 데이터를 Request하는 방식</strong>으로 해결할 수 있다. 필요한(처리할 수 있는) 만큼만 요청해서 Pull하는 것이다. 데이터 요청의 크기가 Subscriber에 의해서 결정되는 것이다. 이를 <code>dynamic pull</code> 방식이라 부르며, Back Pressure의 기본 원리이다.</p><h1 id="reactive-streams-api"><a href="#Reactive-Streams-API" class="headerlink" title="Reactive Streams API"></a>Reactive Streams API</h1><p><strong>Reactive Streams는 표준화된 API이다.</strong> 2013년 netflix, pivotal, lightbend의 엔지니어들에 의해서 처음 시작되어, 2015 4월에 JVM에 대한 1.0.0 스펙이 릴리즈 되었다.<br>Java 9부터는 reactive streams이 java.util.concurrent의 패키지 아래 <a href="https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/Flow.html" target="_blank" rel="noopener">Flow</a>라는 형태로 JDK에 포함되었다. 기존에 reactive streams가 가진 API와 스펙, pull방식을 사용하는 원칙을 그대로 수용하였다.</p><p>아래는 Reactive Streams API이다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Publisher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; s)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscription</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>실제로 보면 굉장히 간단한 API들의 조합으로 이루어져 있다.</p><ul><li><strong>Publisher</strong>: Subscriber를 받아들이는 <code>subscribe</code> 메서드 하나만 갖는다.</li><li><strong>Subscriber</strong>: 데이터를 받아 처리할 수 있는 <code>onNext</code>, 에러를 처리하는 <code>onError</code>, 모든 데이터를 받아 완료되었을 때는 <code>onComplete</code>, 그리고 Publisher로부터 Subscription을 전달 받는 <code>onSubscribe</code> 메서드로 이루어진다.</li><li><strong>Subscription</strong>: n개의 데이터를 요청하는 <code>request</code>와 구독을 취소하는 <code>cancel</code>을 갖는다.</li></ul><p>전체적인 흐름은 다음과 같다.<br><img src="/images/post/2019-11-05/reactive-streams.png" alt="reactive streams"></p><ol><li>Subscriber가 Publisher에게 구독을 요청한다.</li><li>Publisher는 Subscriber의 onSubscribe 메서드를 통해 Subscription을 전달한다.</li><li>Subscriber는 Publisher에게 직접 데이터를 요청하지 않고 Subscription을 통해 요청한다.</li><li>Publisher는 Subscription을 통해 onNext에 데이터를 전달하고 완료되면 onComplete, 에러가 발생하면 onError에 전달한다.</li></ol><h2 id="example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>마지막으로 Reactive Streams API를 간단하게 구현해 테스트 해보자.</p><blockquote><p>Reactive Streams API의 Interface는 간단해 보이지만 이를 구현한 구현체는 Reactive Streams Specification을 만족해야만 한다. 구현체가 Specification을 만족하는지는 Reactive Streams TCK(Technology Compatibility Kit)라는 도구를 이용해 검증할 수 있다.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PubSub</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Iterable&lt;Integer&gt; iter = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        Publisher p = <span class="keyword">new</span> Publisher() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber subscriber)</span> </span>&#123;</span><br><span class="line">                Iterator&lt;Integer&gt; it = iter.iterator();</span><br><span class="line"></span><br><span class="line">                subscriber.onSubscribe(<span class="keyword">new</span> Subscription() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">while</span>(n-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">                                subscriber.onNext(it.next());</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                subscriber.onComplete();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        log.info(<span class="string">"cancel"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;Integer&gt; s = <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">            Subscription subscription;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onSubscribe"</span>);</span><br><span class="line">                <span class="keyword">this</span>.subscription = subscription;</span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer item)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onNext: &#123;&#125;"</span>, item);</span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onError"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.info(<span class="string">"onComplete"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        p.subscribe(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 실행결과</span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.655</span> [main] INFO com.jongmin.reactive.practice.PubSub - onSubscribe</span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.660</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.662</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">2</span></span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.663</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.663</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">4</span></span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.663</span> [main] INFO com.jongmin.reactive.practice.PubSub - onNext: <span class="number">5</span></span><br><span class="line"><span class="number">00</span>:<span class="number">19</span>:<span class="number">08.663</span> [main] INFO com.jongmin.reactive.practice.PubSub - onComplete</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;reactive-streams-란&quot;&gt;&lt;a href=&quot;#Reactive-Streams-란&quot; class=&quot;headerlink&quot; title=&quot;Reactive Streams 란?&quot;&gt;&lt;/a&gt;Reactive Streams 란?&lt;/h1&gt;&lt;p&gt;&lt;a h
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Reactive" scheme="https://jongmin92.github.io/tags/Reactive/"/>
    
  </entry>
  
  <entry>
    <title>Spring Bean LifeCycle</title>
    <link href="https://jongmin92.github.io/2019/05/21/Spring/spring-bean-life-cycle/"/>
    <id>https://jongmin92.github.io/2019/05/21/Spring/spring-bean-life-cycle/</id>
    <published>2019-05-20T16:54:00.000Z</published>
    <updated>2019-05-26T06:06:19.024Z</updated>
    
    <content type="html"><![CDATA[<p>최근 사내에서 Kafka 관련된 설정을 리팩토링하는 작업을 했습니다. SpringBoot를 도입하며 Kafka 설정 관련된 부분들을 SpringBoot의 <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/ConfigurationProperties.html" target="_blank" rel="noopener">@ConfigurationProperties</a>를 이용하도록 변경하고, XML 기반의 빈 생성 부분을 Java Config 기반으로 변경했습니다.<br>현재 프로젝트에서는 여러가지 이유로 기존의 Kafka Producer를 확장(extends)해서 사용하고 있는데, 이번에 리팩토링 관련한 PR에서 <strong>확장해서 사용하고 있는 Kafka Producer에서 <code>close</code> 메서드를 구현하고 있는지 확인해달라는 리뷰를 받았습니다.</strong></p><p>컨테이너에 등록된 Bean이 DisposableBean interface를 구현하고 있거나 @PreDestroy 어노테이션 또는 destroyMethod 속성을 사용하고 있다면 Bean의 Lifecycle 마지막에 자원을 해제하거나 필요한 작업을 수행할 수 있습니다. 그러나 위의 방법 말고도 Spring container에서 Bean을 제거 할 때, <strong><code>close()</code></strong> 와 <strong><code>shutdown()</code></strong> 메서드를 호출합니다.</p><p><a href="https://kafka.apache.org/11/javadoc/index.html?org/apache/kafka/clients/producer/KafkaProducer.html" target="_blank" rel="noopener">Kafka Producer</a>는 <strong><a href="https://docs.oracle.com/javase/7/docs/api/java/io/Closeable.html" target="_blank" rel="noopener">Closeable</a></strong> interface를 구현(implement)하고 있기 때문에 close 메서드를 포함하고 있습니다. Kafka Producer가 Bean으로 등록되어 있고 후에 소멸될 때 close 메서드가 호출되어 해당 자원이 모두 해제될 것입니다.</p><p> 따라서 제가 받았던 리뷰는 기존 Kafka Producer를 확장한 것을 Bean으로 등록해 사용하고 있는데, 해당 확장 클래스가 close 메서드를 제대로 구현해 Bean이 소멸 될 때 호출될 close 메서드에서 자원이 제대로 해제하고 있는지 확인해 달라는 것이었습니다.</p><blockquote><p><strong><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html" target="_blank" rel="noopener">AutoCloseable</a></strong> 은 <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html" target="_blank" rel="noopener">try-with-resource</a> 구문과 함께 사용됩니다.</p></blockquote><p>이번 리뷰를 통해 Bean의 LifeCycle과 close, shutdown 메서드에 대해 다시 살펴보는 계기가 되었습니다.</p><h1 id="initialize-메서드"><a href="#Initialize-메서드" class="headerlink" title="Initialize 메서드"></a>Initialize 메서드</h1><p>Initialize 메서드는 Bean Object가 생성되고 DI를 마친 후 실행되는 메서드입니다. 일반적으로 Object의 초기화 작업이 필요한 경우 생성자에서 처리하지만 DI를 통해 Bean이 주입된 후에 초기화할 작업이 있다면 초기화 메서드를 이용해서 초기화를 진행할 수 있습니다.</p><h2 id="postconstruct"><a href="#PostConstruct" class="headerlink" title="@PostConstruct"></a>@PostConstruct</h2><p>초기화 하고 싶은 메서드에 <strong><code>@PostConstruct</code></strong> 어노테이션을 붙여주면 Spring이 해당 메서드를 초기화시에 호출합니다. PostConstruct는 <a href="https://jcp.org/en/jsr/detail?id=250" target="_blank" rel="noopener">JSR-250</a> 스펙에 포함되어 있기 때문에 JSR-250을 구현한 다른 프레임워크 혹은 라이브러리에서도 동작합니다. 다른 초기화 메서드에 비해 Spring에 의존적이지 않다는 장점이 있습니다.</p><blockquote><p><a href="https://en.wikipedia.org/wiki/JSR_250" target="_blank" rel="noopener">JSR-250</a><br>JSR 250 is a Java Specification Request with the objective to develop annotations (that is, information about a software program that is not part of the program itself) for common semantic concepts in the Java SE and Java EE platforms that apply across a variety of individual technologies.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postConstruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"postConstruct"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="initializingbean"><a href="#InitializingBean" class="headerlink" title="InitializingBean"></a>InitializingBean</h2><p><strong><code>InitializingBean</code></strong> 인터페이스를 구현하면 Spring이 afterPropertiesSet 메서드를 초기화시에 호출합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"afterPropertiesSet"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="beaninitmethod"><a href="#Bean-initMethod" class="headerlink" title="@Bean(initMethod)"></a>@Bean(initMethod)</h2><p>@Bean 어노테이션을 이용해 Bean을 생성할 때, @Bean 어노테이션의 <strong><code>initMethod</code></strong> 속성을 이용해 초기화 메서드를 지정할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleBean <span class="title">simpleBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Slf</span>4j</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            log.info(<span class="string">"init"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="destroy-메서드"><a href="#Destroy-메서드" class="headerlink" title="Destroy 메서드"></a>Destroy 메서드</h1><p>Destroy 메서드는 스프링 컨테이너가 종료 될 때, 호출되어 Bean이 사용한 리소스들을 반환하거나 종료 시점에 처리해야할 작업이 있을 경우 사용합니다.</p><h2 id="predestroy"><a href="#PreDestroy" class="headerlink" title="PreDestroy"></a>PreDestroy</h2><p><strong><code>@PreDestroy</code></strong> 도 PostConstruct처럼 <a href="https://jcp.org/en/jsr/detail?id=250" target="_blank" rel="noopener">JSR-250</a> 스펙에 포함되어 있기 때문에 JSR-250을 구현한 다른 프레임워크 혹은 라이브러리에서도 동작합니다. 컨테이너가 종료 될 때 실행하고 싶은 메서드에 어노테이션을 붙여주면 Spring이 컨테이너 종료 시 해당 메서드를 호출합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"preDestroy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="disposablebean"><a href="#DisposableBean" class="headerlink" title="DisposableBean"></a>DisposableBean</h2><p><strong><code>DisposableBean</code></strong> 인터페이스를 구현하면 Spring이 destroy 메서드를 호출합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lf4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBean</span> <span class="keyword">implements</span> <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"destroy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="beandestroymethod"><a href="#Bean-destroyMethod" class="headerlink" title="@Bean(destroyMethod)"></a>@Bean(destroyMethod)</h2><p>@Bean 어노테이션을 이용해 Bean을 생성할 때, @Bean 어노테이션의 <strong><code>destroyMethod</code></strong> 속성을 이용해 컨테이너 종료시 실행하고자 하는 메서드를 지정할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(destroyMethod = <span class="string">"destroy"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleBean <span class="title">simpleBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Slf</span>4j</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            log.info(<span class="string">"destroy"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="close-amp-shutdown"><a href="#close-amp-shutdown" class="headerlink" title="close &amp; shutdown"></a>close &amp; shutdown</h1><p>close와 shutdown 메서드는 <a href="https://docs.spring.io/spring/docs/3.2.4.RELEASE_to_4.0.0.M3/Spring%20Framework%203.2.4.RELEASE/org/springframework/beans/factory/support/DisposableBeanAdapter.html" target="_blank" rel="noopener">DisposableBeanAdapter</a>에 의해 실행됩니다.<br><img src="/images/post/2019-05-21/disposableBeanAdapter.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;최근 사내에서 Kafka 관련된 설정을 리팩토링하는 작업을 했습니다. SpringBoot를 도입하며 Kafka 설정 관련된 부분들을 SpringBoot의 &lt;a href=&quot;https://docs.spring.io/spring-boot/docs/cu
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Spring" scheme="https://jongmin92.github.io/tags/Spring/"/>
    
      <category term="Bean" scheme="https://jongmin92.github.io/tags/Bean/"/>
    
      <category term="Closeable" scheme="https://jongmin92.github.io/tags/Closeable/"/>
    
      <category term="AutoClosable" scheme="https://jongmin92.github.io/tags/AutoClosable/"/>
    
      <category term="DisposableBeanAdapter" scheme="https://jongmin92.github.io/tags/DisposableBeanAdapter/"/>
    
  </entry>
  
  <entry>
    <title>오픈소스 컷 컨트리뷰트 경험기</title>
    <link href="https://jongmin92.github.io/2019/05/18/Etc/open-source-experience/"/>
    <id>https://jongmin92.github.io/2019/05/18/Etc/open-source-experience/</id>
    <published>2019-05-18T11:13:00.000Z</published>
    <updated>2019-05-25T09:07:40.316Z</updated>
    
    <content type="html"><![CDATA[<p>얼마 전 개발자 생에 처음으로 오픈소스에 컨트리뷰트를 하는 경험을 하였습니다. 이번 포스팅에서는 오픈소스 첫 컨트리뷰트 관련해 이야기 해보려 합니다.</p><h1 id="어떻게-시작하게-되었는가"><a href="#어떻게-시작하게-되었는가" class="headerlink" title="어떻게 시작하게 되었는가?"></a>어떻게 시작하게 되었는가?</h1><p>개발자라면 한 번쯤 오픈소스에 기여하고 컨트리뷰터가 되어보고 싶다는 생각을 가져봅니다. 저 역시 언젠가 한 번쯤… 이라는 생각은 오래 전 부터 갖고 있었지만 막상 실행에 옮기기 까지가 쉽지 않았습니다. 이미 오픈소스에 기여해 본 많은 개발자 분들이 오픈소스 기여에 쉽게 입문 할 수 있도록 여러 가이드들도 많이 만들어 주셨지만 저는 그 마저도 이용을 하지 못하고 있었습니다. 그러던 도중 우연히 <code>Armeria Sprint</code>라는 좋은 기회가 찾아왔습니다.</p><blockquote><p>LINE의 오픈소스와 Armeria에 대해 조금 더 알아보고 싶다면 다음 글들이 도움이 될 것 같습니다.</p><ul><li><a href="https://engineering.linecorp.com/ko/blog/line-developer-interview-3/" target="_blank" rel="noopener">비동기를 사랑하는 오픈소스 개발자, 이희승</a></li><li><a href="https://engineering.linecorp.com/ko/blog/thank-you-for-contributing-to-armeria/" target="_blank" rel="noopener">오픈소스 Armeria의 기여자를 위한 이벤트를 진행하였습니다</a></li><li><a href="https://engineering.linecorp.com/ko/blog/armeria-sprint-1/" target="_blank" rel="noopener">GitHub Contributions 그래프를 푸릇푸릇하게 만들어보아요(feat. Armeria Sprint)</a></li></ul></blockquote><h1 id="armeria-sprint"><a href="#Armeria-Sprint" class="headerlink" title="Armeria Sprint"></a>Armeria Sprint</h1><p>사내에서 개발하여 오픈소스로 공개한 프로젝트인 Armeria에 기여할 수 있도록 사내 개발자를 대상으로 Armeria Sprint 행사가 있었습니다.</p><blockquote><p><strong>오픈소스 스프린트란?</strong><br>오픈소스 스프린트란 오픈소스에 관심있는 사람들이 모여서 오픈소스에 기여해 보는 것이라고 정의할 수 있습니다. 행사마다 편차가 있겠지만 보통 진행 기간을 하루 정도로 잡고 오전에는 다같이 모여서 각자 할 일(어떤 이슈를 맡아서 할지)을 정하고 오후에는 집중해서 코딩을 합니다.<br>참고 : <a href="https://engineering.linecorp.com/ko/blog/armeria-sprint-1/" target="_blank" rel="noopener">GitHub Contributions 그래프를 푸릇푸릇하게 만들어보아요(feat. Armeria Sprint)</a></p></blockquote><p>오픈소스에 기여해 보고 싶어도 여러 이유로 시작하지 못하고 있었던 저는 해당 행사의 인원 모집이 시작되자마자 고민없이 바로 신청해 참가할 수 있었습니다.</p><p>행사는 이틀에 나누어서 첫째 날에는 환영 세션이 2시간 동안 진행되었고, 둘째 날에는 스프린트가 4시간 동안 진행되었습니다. 행사 동안에는 간단한 자기 소개, 오픈소스에 기여하기 전에 알야아할 것, 스프린트 기간 동안 해결할 이슈 정하기, 그리고 마지막으로 집중해서 코딩하기와 같은 활동들이 있었습니다.</p><h1 id="contribute"><a href="#Contribute" class="headerlink" title="Contribute"></a>Contribute</h1><p>오픈소스에 처음 기여할 때 어려운 부분 중 하나가 <strong>“어떤 이슈를 맡아 해결하여 기여를 할 것인가”</strong>인데요. 저는 이번 Armeria Sprint를 통해 현재 해결해야 할 이슈들이 어떤 것들이 있는지, 해당 이슈는 어떤 부분에 대한 내용인지에 대해 직접 듣고 모르는 부분은 직접 물어보며 진행 할 수 있었기 때문에 조금은 더 수월하게 진행할 수 있었습니다.</p><p>아마 처음 온라인으로 직접 이슈를 처음 선택하기에는 어려운 부분이 있을 것 같은데요. Armeria에서는 <strong><a href="https://github.com/line/armeria/issues?q=is%3Aopen+is%3Aissue+label%3Agood-first-issue" target="_blank" rel="noopener">good-first-issue</a></strong> 라는 이름의 Label을 붙여 조금은 해결하기 쉬운 이슈들을 표시해주고 있습니다.<br><img src="/images/post/2019-05-18/armeria_1.png" alt=""></p><p>해당 이슈들 중 아는 부분이 있거나 해보고 싶은 이슈가 있다면 본인이 해결해 보겠다는 코멘트를 남긴 후 작업을 진행하면 됩니다.<br>내가 맡은 이슈가 어떤 문제를 해결(개선)하기 위한 것인지, 코드의 어떤 부분을 수정해야 하는지 파악하는 것이 처음에 가장 중요하다고 생각합니다. 이를 토대로 처음 PR을 올리게 되면 maintainer 분들이 꼼꼼한 리뷰와 함께 코멘트를 남겨주시기 때문에 같이 고민해가며 코드를 점차 개선해 나아갈 수 있습니다.</p><p>아래는 Armeria Sprint 동안 제가 맡았던 Issue와 PR입니다.</p><ul><li>Issue: <a href="https://github.com/line/armeria/issues/1584" target="_blank" rel="noopener">Provide a way to get request body in service method.</a></li><li>PR: <a href="https://github.com/line/armeria/pull/1745" target="_blank" rel="noopener">Enable to convert request body to expected result type regardless of content-type</a></li></ul><p>스프린트 2일차 때, 약 4시간 정도의 시간 동안 코딩을 하고 당일날 첫 PR을 올릴 수 있었습니다. 첫 PR을 올리고 다음날 maintainer 분들의 리뷰 코멘트가 달리기 시작했고, 틈틈히 코멘트 반영과 리뷰를 반복한 결과 약 3주 정도 후 첫 PR이 머지될 수 있었습니다.</p><p>위 과정을 반복하며 오픈소스에 기여하는데 있어 필요한 부분들을 다시 한 번 생각해 보게 되었습니다.</p><ul><li>몇번의 리뷰와 코멘트 반영 없이 한번에 PR이 머지되기는 쉽지 않습니다. 프로젝트의 maintainer가 아닌 이상 내가 작성한 코드가 모든 경우를 다 커버할 수 있을지는 테스트 코드를 작성하더라도 쉽게 확신할 수 없습니다. 그렇기 때문에 이슈 해결을 위한 코드와 테스트 코드를 작성한 후에는 PR을 만들어 리뷰를 요청드리는게 더 빠르게 머지될 수 있는 방법 같습니다.</li><li>저는 Armeria Sprint를 통해 처음 궁금했던 부분들에 대해 오프라인에서 직접 여쭤보고 답을 받을 수 있었지만, 실제 오픈소스에 기여하는 과정에서는 모든 과정이 온라인에서 진행됩니다. 따라서 글로 본인의 의사를 잘 전달할 수 있는 능력이 중요합니다.<ul><li>나의 생각이 어떠한지, 어떤 부분에 대해서 모르는지 아는지를 글로써 잘 전달해야 maintainer 분들도 참고해 도움이 될 수 있는 코멘트를 남겨주실 수 있습니다.</li></ul></li><li>모든 의사소통은 영어를 이용해서 하지만 Google 번역기가 있으니 너무 걱정하지 않아도 됩니다.</li></ul><h1 id="후기"><a href="#후기" class="headerlink" title="후기"></a>후기</h1><p>Armeria Sprint에서 기념품으로 컵을 받았는데요.<br><img src="/images/post/2019-05-18/armeria_2.jpeg" alt=""></p><p>뒤에 이런 문구가 적혀 있었습니다. 오픈소스에 그리고 Armeria에 관심이 있다면 여러분들도 한 번 기여해보세요!<br><img src="/images/post/2019-05-18/armeria_3.jpeg" alt=""></p><p>처음으로 오픈소스에 기여해보았다는 것, 그리고 그 오픈소스가 Armeria라는 것이 매우 재밌고 뜻 깊은 경험이었습니다. 저도 이번 첫 컨트리뷰트를 시작으로 가능하면 꾸준히 기여를 해보려고 합니다.<br><img src="/images/post/2019-05-18/armeria_4.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;얼마 전 개발자 생에 처음으로 오픈소스에 컨트리뷰트를 하는 경험을 하였습니다. 이번 포스팅에서는 오픈소스 첫 컨트리뷰트 관련해 이야기 해보려 합니다.&lt;/p&gt;
&lt;h1 id=&quot;어떻게-시작하게-되었는가&quot;&gt;&lt;a href=&quot;#어떻게-시작하게-되었는가&quot; c
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Armeria" scheme="https://jongmin92.github.io/tags/Armeria/"/>
    
      <category term="Open source" scheme="https://jongmin92.github.io/tags/Open-source/"/>
    
  </entry>
  
  <entry>
    <title>(Gradle dependency) api와 implementation 차이</title>
    <link href="https://jongmin92.github.io/2019/05/09/Gradle/gradle-api-vs-implementation/"/>
    <id>https://jongmin92.github.io/2019/05/09/Gradle/gradle-api-vs-implementation/</id>
    <published>2019-05-09T13:13:00.000Z</published>
    <updated>2019-05-25T09:07:40.317Z</updated>
    
    <content type="html"><![CDATA[<p><strong>build script의 <code>dependencies</code> 블록에 여러 가지 다양한 종속성 구성(api, implementation, compileOnly, runtimeOnly, annotationProcessor)을 사용하여 라이브러리 종속성을 선언할 수 있습니다.</strong> 다양한 종속성 구성 중 api와 implementation의 차이에 대해서 알아봅니다.</p><h1 id="api-amp-implementation"><a href="#api-amp-implementation" class="headerlink" title="api &amp; implementation"></a>api &amp; implementation</h1><p><a href="https://docs.gradle.org/current/userguide/dependency_management_for_java_projects.html#sec:configurations_java_tutorial" target="_blank" rel="noopener">Gradle document</a>에서는 api와 implementation에 대해서 다음과 같이 설명하고 있습니다.</p><ul><li><strong>api</strong><blockquote><p><strong>The dependencies required to compile the production source of the project which are part of the API exposed by the project.</strong> For example the project uses Guava and exposes public interfaces with Guava classes in their method signatures.</p><p><strong>프로젝트에 의해 노출 된 API의 일부인 프로젝트의 프로덕션 소스를 컴파일하는 데 필요한 종속성</strong></p></blockquote></li><li><strong>implementation</strong><blockquote><p><strong>The dependencies required to compile the production source of the project which are not part of the API exposed by the project.</strong> For example the project uses Hibernate for its internal persistence layer implementation.</p><p><strong>프로젝트에 의해 노출 된 API의 일부가 아닌 프로젝트의 프로덕션 소스를 컴파일하는 데 필요한 종속성</strong></p></blockquote></li></ul><p>위 설명만 가지고는 이해하기가 쉽지 않습니다. <a href="https://developer.android.com/studio/build/dependencies?utm_source=android-studio#dependency_configurations" target="_blank" rel="noopener">Android Developers document</a>에서는 같은 내용을 다음과 같이 한글로 설명하고 있습니다.</p><ul><li><strong>api</strong><blockquote><p>Gradle은 컴파일 클래스 경로 및 빌드 출력에 종속성을 추가합니다. <strong>모듈에 api 종속성을 포함하면 다른 모듈에 그 종속성을 과도적으로 내보내기를 원하며 따라서 런타임과 컴파일 시 모두 종속성을 사용할 수 있다는 사실을 Gradle에 알려줄 수 있습니다.</strong></p><p>이 구성은 compile(현재 지원 중단됨)과 똑같이 동작합니다. 다만 이것은 주의해서 사용해야 하며 다른 업스트림 소비자에게 일시적으로 내보내는 종속성만 함께 사용해야 합니다. 그 이유는 api 종속성이 외부 API를 변경하면 Gradle이 컴파일 시 해당 종속성에 액세스할 권한이 있는 모듈을 모두 다시 컴파일하기 때문입니다. 그러므로 api 종속성이 많이 있으면 빌드 시간이 상당히 증가합니다. 종속성의 API를 별도의 모듈에 노출시키고 싶은 것이 아니라면 라이브러리 모듈은 implementation 종속성을 대신 사용해야 합니다.</p></blockquote></li><li><strong>implementation</strong><blockquote><p>Gradle은 종속성을 컴파일 클래스 경로에 추가하여 종속성을 빌드 출력에 패키징합니다. 다만 <strong>모듈이 implementation 종속성을 구성하는 경우, 이것은 Gradle에 개발자가 모듈이 컴파일 시 다른 모듈로 유출되는 것을 원치 않는다는 것을 알려줍니다. 즉, 종속성은 런타임 시 다른 모듈에서만 이용할 수 있습니다.</strong></p><p>api 또는 compile(지원 중단됨) 대신 이 종속성 구성을 사용하면 빌드 시스템이 재컴파일해야 하는 모듈의 수가 줄어들기 때문에 빌드 시간이 상당히 개선될 수 있습니다. 예를 들어, implementation 종속성이 API를 변경하면 Gradle은 해당 종속성과 그 종속성에 직접 연결된 모듈만 다시 컴파일합니다. 대부분의 앱과 테스트 모듈은 이 구성을 사용해야 합니다.</p></blockquote></li></ul><p>간단하게 차이점을 정리하면 다음과 같습니다.</p><ul><li><strong>api</strong>: 의존 라이브러리 수정시 해당 모듈을 의존하고 있는 모듈들 또한 재빌드<ul><li>A(api) &lt;- B &lt;- C 일 때, C 에서 A 를 접근할 수 있음</li><li>A 수정시 B 와 C 모두 재빌드</li></ul></li><li><strong>implementaion</strong>: 의존 라이브러리 수정시 본 모듈까지만 재빌드<ul><li>A(implementation) &lt;- B &lt;- C 일 때, C 에서 A 를 접근할 수 없음</li><li>A 수정시 B 까지 재빌드 </li></ul></li></ul><h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul><li><a href="https://stackoverflow.com/a/44419574" target="_blank" rel="noopener">https://stackoverflow.com/a/44419574</a></li><li><a href="https://medium.com/mindorks/implementation-vs-api-in-gradle-3-0-494c817a6fa" target="_blank" rel="noopener">https://medium.com/mindorks/implementation-vs-api-in-gradle-3-0-494c817a6fa</a></li><li><a href="https://www.youtube.com/watch?v=7ll-rkLCtyk&amp;feature=youtu.be&amp;t=29m35s" target="_blank" rel="noopener">https://www.youtube.com/watch?v=7ll-rkLCtyk&amp;feature=youtu.be&amp;t=29m35s</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;build script의 &lt;code&gt;dependencies&lt;/code&gt; 블록에 여러 가지 다양한 종속성 구성(api, implementation, compileOnly, runtimeOnly, annotationProcessor)을
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Gradle" scheme="https://jongmin92.github.io/categories/Programming/Gradle/"/>
    
    
      <category term="Gradle" scheme="https://jongmin92.github.io/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>CompletableFuture</title>
    <link href="https://jongmin92.github.io/2019/05/05/Java/java-async-4/"/>
    <id>https://jongmin92.github.io/2019/05/05/Java/java-async-4/</id>
    <published>2019-05-04T16:26:00.000Z</published>
    <updated>2019-05-15T10:06:52.404Z</updated>
    
    <content type="html"><![CDATA[<p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=PzxV-bmLSFY&amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC&amp;index=4" target="_blank" rel="noopener">토비의 봄 TV 11회 스프링 리액티브 프로그래밍 (7) CompletableFuture</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p><p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다. </p><p> 이번에는 자바8에 나온 <strong><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html" target="_blank" rel="noopener">CompletableFuture</a></strong> 라는 새로운 비동기 자바 프로그래밍 기술에 대해서 알아보고, 지난 3회 정도 동안 다루어 왔던 자바 서블릿, 스프링의 비동기 기술 발전의 내용을 자바 8을 기준으로 다시 재작성합니다.</p><h1 id="completablefuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h1><p>먼저 간단한 코드를 통해서 CompletableFuture 사용법에 대해서 알아보겠습니다.</p><h2 id="runasync-amp-thenrun"><a href="#runAsync-amp-thenRun" class="headerlink" title="runAsync &amp; thenRun"></a>runAsync &amp; thenRun</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// Async 작업이 끝나고 해당 스레드에서 계속해서 작업을 수행한다.</span></span><br><span class="line">        CompletableFuture</span><br><span class="line">                .runAsync(() -&gt; log.info(<span class="string">"runAsync"</span>))</span><br><span class="line">                .thenRun(() -&gt; log.info(<span class="string">"thenRun"</span>))</span><br><span class="line">                .thenRun(() -&gt; log.info(<span class="string">"thenRun"</span>));</span><br><span class="line">        log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 별도의 pool을 설정하지 않으면 자바7 부터는 ForkJoinPool이 자동으로 사용된다.</span></span><br><span class="line">        ForkJoinPool.commonPool().shutdown();</span><br><span class="line">        ForkJoinPool.commonPool().awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.841</span> [main] INFO com.example.study.CFuture - exit</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.841</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - runAsync</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.845</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenRun</span><br><span class="line"><span class="number">23</span>:<span class="number">43</span>:<span class="number">15.845</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenRun</span><br></pre></td></tr></table></figure><h2 id="supplyasync-thenapply-thenaccept"><a href="#supplyAsync-thenApply-thenAccept" class="headerlink" title="supplyAsync, thenApply, thenAccept"></a>supplyAsync, thenApply, thenAccept</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// Async 작업이 끝나고 해당 스레드에서 계속해서 작업을 수행한다.</span></span><br><span class="line">        CompletableFuture</span><br><span class="line">                .supplyAsync(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"supplyAsync"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용해 새로운 값을 return 한다.</span></span><br><span class="line">                .thenApply(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> s + <span class="number">1</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용하며 return이 없다.</span></span><br><span class="line">                .thenAccept(s -&gt; log.info(<span class="string">"thenAccept &#123;&#125;"</span>, s));</span><br><span class="line">        log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 별도의 pool을 설정하지않으면 자바7 부터는 ForkJoinPool이 자동으로 사용된다.</span></span><br><span class="line">        ForkJoinPool.commonPool().shutdown();</span><br><span class="line">        ForkJoinPool.commonPool().awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">00.650</span> [main] INFO com.example.study.CFuture - exit</span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">00.650</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - supplyAsync</span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">00.654</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenApply <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">00.656</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenAccept <span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="thencompose"><a href="#thenCompose" class="headerlink" title="thenCompose"></a>thenCompose</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// Async 작업이 끝나고 해당 스레드에서 계속해서 작업을 수행한다.</span></span><br><span class="line">        CompletableFuture</span><br><span class="line">                .supplyAsync(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"supplyAsync"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// return이 CompletableFuture인 경우 thenCompose를 사용한다.</span></span><br><span class="line">                .thenCompose(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(s + <span class="number">1</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용해 새로운 값을 return 한다.</span></span><br><span class="line">                .thenApply(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> s + <span class="number">1</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용하며 return이 없다.</span></span><br><span class="line">                .thenAccept(s -&gt; log.info(<span class="string">"thenAccept &#123;&#125;"</span>, s));</span><br><span class="line">        log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 별도의 pool을 설정하지않으면 자바7 부터는 ForkJoinPool이 자동으로 사용된다.</span></span><br><span class="line">        ForkJoinPool.commonPool().shutdown();</span><br><span class="line">        ForkJoinPool.commonPool().awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">35.893</span> [main] INFO com.example.study.CFuture - exit</span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">35.893</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - supplyAsync</span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">35.897</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenApply <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">35.899</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenApply <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">50</span>:<span class="number">35.899</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenAccept <span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="exceptionally"><a href="#exceptionally" class="headerlink" title="exceptionally"></a>exceptionally</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// Async 작업이 끝나고 해당 스레드에서 계속해서 작업을 수행한다.</span></span><br><span class="line">        CompletableFuture</span><br><span class="line">                .supplyAsync(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"supplyAsync"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// return이 CompletableFuture인 경우 thenCompose를 사용한다.</span></span><br><span class="line">                .thenCompose(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">1</span> == <span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(s + <span class="number">1</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용해 새로운 값을 return 한다.</span></span><br><span class="line">                .thenApply(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> s + <span class="number">1</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                .exceptionally(e -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"exceptionally"</span>);</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">10</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용하며 return이 없다.</span></span><br><span class="line">                .thenAccept(s -&gt; log.info(<span class="string">"thenAccept &#123;&#125;"</span>, s));</span><br><span class="line">        log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 별도의 pool을 설정하지않으면 자바7 부터는 ForkJoinPool이 자동으로 사용된다.</span></span><br><span class="line">        ForkJoinPool.commonPool().shutdown();</span><br><span class="line">        ForkJoinPool.commonPool().awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">31.255</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - supplyAsync</span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">31.257</span> [main] INFO com.example.study.CFuture - exit</span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">31.259</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenApply <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">31.261</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - exceptionally</span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">31.261</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] INFO com.example.study.CFuture - thenAccept -<span class="number">10</span></span><br></pre></td></tr></table></figure><h2 id="thenapplyasync"><a href="#thenApplyAsync" class="headerlink" title="thenApplyAsync"></a>thenApplyAsync</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Async 작업이 끝나고 해당 스레드에서 계속해서 작업을 수행한다.</span></span><br><span class="line">        CompletableFuture</span><br><span class="line">                .supplyAsync(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"supplyAsync"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;, es)</span><br><span class="line">                <span class="comment">// return이 CompletableFuture인 경우 thenCompose를 사용한다.</span></span><br><span class="line">                .thenCompose(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(s + <span class="number">1</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용해 새로운 값을 return 한다.</span></span><br><span class="line">                .thenApply(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> s + <span class="number">2</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 이 작업은 다른 스레드에서 처리를 하려고 할 때, thenApplyAsync를 사용한다.</span></span><br><span class="line">                <span class="comment">// 스레드의 사용을 더 효율적으로 하고 자원을 더 효율적으로 사용한다.</span></span><br><span class="line">                <span class="comment">// 현재 스레드 풀의 정책에 따라서 새로운 스레드를 할당하거나 대기중인 스레드를 사용한다. (스레드 풀 전략에 따라 다르다.)</span></span><br><span class="line">                .thenApplyAsync(s -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"thenApply &#123;&#125;"</span>, s);</span><br><span class="line">                    <span class="keyword">return</span> s + <span class="number">3</span>;</span><br><span class="line">                &#125;, es)</span><br><span class="line">                .exceptionally(e -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">"exceptionally"</span>);</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">10</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 앞의 비동기 작업의 결과를 받아 사용하며 return이 없다.</span></span><br><span class="line">                .thenAcceptAsync(s -&gt; log.info(<span class="string">"thenAccept &#123;&#125;"</span>, s), es);</span><br><span class="line">        log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 별도의 pool을 설정하지않으면 자바7 부터는 ForkJoinPool이 자동으로 사용된다.</span></span><br><span class="line">        ForkJoinPool.commonPool().shutdown();</span><br><span class="line">        ForkJoinPool.commonPool().awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">23</span>:<span class="number">54</span>:<span class="number">00.043</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.CFuture - supplyAsync</span><br><span class="line"><span class="number">23</span>:<span class="number">54</span>:<span class="number">00.043</span> [main] INFO com.example.study.CFuture - exit</span><br><span class="line"><span class="number">23</span>:<span class="number">54</span>:<span class="number">00.047</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.CFuture - thenApply <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">54</span>:<span class="number">00.048</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.CFuture - thenApply <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">54</span>:<span class="number">00.049</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.example.study.CFuture - thenApply <span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">54</span>:<span class="number">00.049</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.example.study.CFuture - thenAccept <span class="number">7</span></span><br></pre></td></tr></table></figure><h1 id="listenablefuture에서-completablefuture로-변환"><a href="#ListenableFuture에서-CompletableFuture로-변환" class="headerlink" title="ListenableFuture에서 CompletableFuture로 변환"></a>ListenableFuture에서 CompletableFuture로 변환</h1><p>Spring 4.0에 들어간 <code>AsyncRestTemplate</code>이 return하는 것은 <code>CompletableFuture</code>가 아닌 <code>ListenableFuture</code>입니다.<br>Spring 4까지는 자바 6~8을 지원하기 때문에 CompletableFuture로 return을 만들지 못하고 계속 ListenableFuture를 유지했습니다. 따라서 ListenableFuture를 CompletableFuture로 만들어 체이닝하기 위해서는 유틸성 wrapper 메서드를 만들어 사용하면 됩니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            toCF(rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .thenCompose(s -&gt; toCF(rt.getForEntity(<span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>, String.class, s.getBody())))</span><br><span class="line">                    .thenCompose(s -&gt; toCF(myService.work(s.getBody())))</span><br><span class="line">                    .thenAccept(s -&gt; dr.setResult(s))</span><br><span class="line">                    .exceptionally(e -&gt; &#123;</span><br><span class="line">                        dr.setErrorResult(e.getMessage());</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">//                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">//                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">//                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">//                    &#125;);</span></span><br><span class="line"><span class="comment">//                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">//                &#125;);</span></span><br><span class="line"><span class="comment">//            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">//            &#125;);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &lt;T&gt; <span class="function">CompletableFuture&lt;T&gt; <span class="title">toCF</span><span class="params">(ListenableFuture&lt;T&gt; lf)</span> </span>&#123;</span><br><span class="line">            CompletableFuture&lt;T&gt; cf = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">            lf.addCallback(s -&gt; cf.complete(s), e -&gt; cf.completeExceptionally(e));</span><br><span class="line">            <span class="keyword">return</span> cf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;해당 포스팅은 토비님의 &lt;strong&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=PzxV-bmLSFY&amp;amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC&amp;amp;index=4&quot; target
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Async" scheme="https://jongmin92.github.io/tags/Async/"/>
    
      <category term="CompletableFuture" scheme="https://jongmin92.github.io/tags/CompletableFuture/"/>
    
  </entry>
  
  <entry>
    <title>@Bean Lite Mode &amp; inter-bean references</title>
    <link href="https://jongmin92.github.io/2019/04/30/Spring/spring-bean-lite-mode/"/>
    <id>https://jongmin92.github.io/2019/04/30/Spring/spring-bean-lite-mode/</id>
    <published>2019-04-30T10:15:00.000Z</published>
    <updated>2019-04-30T11:25:50.378Z</updated>
    
    <content type="html"><![CDATA[<h1 id="bean-methods-in-configuration-classes"><a href="#Bean-Methods-in-Configuration-Classes" class="headerlink" title="@Bean Methods in @Configuration Classes"></a>@Bean Methods in @Configuration Classes</h1><p>일반적으로 <strong><code>@Bean</code></strong> 어노테이션은 <strong><code>@Configuration</code></strong> 어노테이션이 사용된 클래스 내의 메서드에 선언이 됩니다. 이 경우 <strong>@Bean 어노테이션을 사용하는 메서드는 같은 클래스의 다른 @Bean 메소드를 직접 호출하여 참조할 수 있습니다. 이렇게하면 bean 간의 참조(reference)가 강하게 만들어집니다.</strong></p><p>아래 코드의 실행 후 로그를 통해 a() 메서드의 결과로 생성되는 A 클래스의 빈은 b() 와 c() 메서드에서 a() 메서드를 직접 호출해 참조가 되는 것을 확인할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = SpringApplication.run(TestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> A <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> A();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> B <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> B();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> C <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> C();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 샐행 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">04.837</span>  INFO <span class="number">24509</span> --- [           main] com.example.test.TestApplication         : Starting TestApplication on AL01297960.local with PID <span class="number">24509</span> (/Users/user/work/test/build/classes/java/main started by user in /Users/user/work/test)</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">04.841</span>  INFO <span class="number">24509</span> --- [           main] com.example.test.TestApplication         : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">06.229</span>  INFO <span class="number">24509</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.262  INFO 24509 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.262  INFO 24509 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.17]</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.353  INFO 24509 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.353  INFO 24509 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1441 ms</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@42163c37</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@42163c37</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.620  INFO 24509 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.846  INFO 24509 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.850  INFO 24509 --- [           main] com.example.test.TestApplication         : Started TestApplication in 2.489 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">3.45</span>)</span></span></span><br></pre></td></tr></table></figure><p>이러한 관계를 <strong><code>빈 간의 참조(inter-bean references)</code></strong>라 부릅니다. 이러한 빈 간의 참조는 @Configuration 클래스의 @Bean이 cglib wrapper에 의해 래핑되기 때문에 동작하게 됩니다.(@Bean 메서드에 대한 호출을 가로채고 Bean 인스턴스를 컨텍스트에서 반환하게 됩니다.)</p><h1 id="bean-lite-mode"><a href="#Bean-Lite-Mode" class="headerlink" title="@Bean Lite Mode"></a>@Bean Lite Mode</h1><p>처음 알게된 분도 계실 수 있을텐데요, <strong>@Bean 메소드는 @Configuration으로 주석을 달지 않은 클래스 내에서도 선언 될 수도 있습니다.</strong> 이런 경우, @Bean 메서드는 <strong><code>lite mode</code></strong>로 처리됩니다.</p><p><strong>lite mode의 Bean 메서드는 스프링 컨테이너에 의해 일반 팩토리 메서드로 처리됩니다. 그렇기 때문에, lite mode에서는 빈 간의 참조가 지원되지 않습니다.</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = SpringApplication.run(TestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> A <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> A();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> B <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> B();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> C <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> C();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 실행 결과</span></span><br><span class="line">```java</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">20</span>:<span class="number">02</span>:<span class="number">17.530</span>  INFO <span class="number">65524</span> --- [           main] com.example.test.TestApplication         : Starting TestApplication on AL01297960.local with PID <span class="number">65524</span> (/Users/user/work/test/build/classes/java/main started by user in /Users/user/work/test)</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">20</span>:<span class="number">02</span>:<span class="number">17.534</span>  INFO <span class="number">65524</span> --- [           main] com.example.test.TestApplication         : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">20</span>:<span class="number">02</span>:<span class="number">18.857</span>  INFO <span class="number">65524</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.891  INFO 65524 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.891  INFO 65524 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.17]</span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.973  INFO 65524 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.973  INFO 65524 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1368 ms</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@919d542c</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@414fc49c</span></span><br><span class="line"><span class="function">2019-04-30 20:02:19.240  INFO 65524 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2019-04-30 20:02:19.471  INFO 65524 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-30 20:02:19.474  INFO 65524 --- [           main] com.example.test.TestApplication         : Started TestApplication in 2.406 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">3.2</span>)</span></span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;bean-methods-in-configuration-classes&quot;&gt;&lt;a href=&quot;#Bean-Methods-in-Configuration-Classes&quot; class=&quot;headerlink&quot; title=&quot;@Bean Methods in @
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/categories/Programming/Spring/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://jongmin92.github.io/tags/Spring/"/>
    
      <category term="@Configuration" scheme="https://jongmin92.github.io/tags/Configuration/"/>
    
      <category term="@Bean" scheme="https://jongmin92.github.io/tags/Bean/"/>
    
      <category term="Bean references" scheme="https://jongmin92.github.io/tags/Bean-references/"/>
    
  </entry>
  
  <entry>
    <title>AsyncRestTemplate의 콜백 헬과 중복 작업 문제</title>
    <link href="https://jongmin92.github.io/2019/04/26/Java/java-async-3/"/>
    <id>https://jongmin92.github.io/2019/04/26/Java/java-async-3/</id>
    <published>2019-04-25T15:30:00.000Z</published>
    <updated>2019-04-30T10:11:37.291Z</updated>
    
    <content type="html"><![CDATA[<p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=Tb43EyWTSlQ" target="_blank" rel="noopener">토비의 봄 TV 10회 스프링 리액티브 프로그래밍 (6) AsyncRestTemplate의 콜백 헬과 중복 작업 문제</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p><p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p><p>이번에는 포스팅에서는 지난번 ListenableFuture를 사용하면서 발생한 콜백헬을 어떻게 개선할지에 대해서 이야기합니다. <strong>ListenableFuture를 Wrapping 하는 Completion이라는 클래스를 만들어, chainable하게 사용할 수 있는 방식으로 코드를 만들어봅니다.</strong><br>콜백헬의 문제로는 에러를 처리하는 코드가 중복이 된다는 것도 있는데, 이 부분도 해결해봅니다.</p><h1 id="completion-클래스-추가"><a href="#Completion-클래스-추가" class="headerlink" title="Completion 클래스 추가"></a>Completion 클래스 추가</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="andapply-메서드-추가"><a href="#andApply-메서드-추가" class="headerlink" title="andApply 메서드 추가"></a>andApply 메서드 추가</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andApply</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.accept(value);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (fn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf = fn.apply(value);</span><br><span class="line">                lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="acceptcompletion-asynccompletion-클래스-추가"><a href="#AcceptCompletion-AsyncCompletion-클래스-추가" class="headerlink" title="AcceptCompletion, AsyncCompletion 클래스 추가"></a>AcceptCompletion, AsyncCompletion 클래스 추가</h1><p>Completion을 결과를 받아서 사용만 하고 끝나는 Accept 처리를 하는 Completion과, 결과를 받아서 또 다른 비동기 작업을 수행하고 그 결과를 반환하는 Apply 용 Completion으로 분리합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptCompletion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncCompletion</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf = fn.apply(value);</span><br><span class="line">            lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andApply</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AsyncCompletion(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AcceptCompletion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="errorcompletion-클래스-추가"><a href="#ErrorCompletion-클래스-추가" class="headerlink" title="ErrorCompletion 클래스 추가"></a>ErrorCompletion 클래스 추가</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andError(e -&gt; dr.setErrorResult(e))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptCompletion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Consumer&lt;Throwable&gt; econ;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ErrorCompletion</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.econ = econ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                next.run(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            econ.accept(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncCompletion</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf = fn.apply(value);</span><br><span class="line">            lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andApply</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AsyncCompletion(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andError</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> ErrorCompletion(econ);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AcceptCompletion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="generic-적용"><a href="#Generic-적용" class="headerlink" title="Generic 적용"></a>Generic 적용</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andApply(s -&gt; myService.work(s.getBody()))</span><br><span class="line">                    .andError(e -&gt; dr.setErrorResult(e.toString()))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletion</span>&lt;<span class="title">S</span>&gt; <span class="keyword">extends</span> <span class="title">Completion</span>&lt;<span class="title">S</span>, <span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        Consumer&lt;S&gt; con;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptCompletion</span><span class="params">(Consumer&lt;S&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(S value)</span> </span>&#123;</span><br><span class="line">            con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCompletion</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Completion</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Consumer&lt;Throwable&gt; econ;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ErrorCompletion</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.econ = econ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                next.run(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            econ.accept(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCompletion</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Completion</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Function&lt;S, ListenableFuture&lt;T&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncCompletion</span><span class="params">(Function&lt;S, ListenableFuture&lt;T&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(S value)</span> </span>&#123;</span><br><span class="line">            ListenableFuture&lt;T&gt; lf = fn.apply(value);</span><br><span class="line">            lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// S는 넘어온 파라미터, T는 결과</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> &lt;S, T&gt; <span class="function">Completion&lt;S, T&gt; <span class="title">from</span><span class="params">(ListenableFuture&lt;T&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion&lt;S, T&gt; c = <span class="keyword">new</span> Completion&lt;&gt;();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> &lt;V&gt; <span class="function">Completion&lt;T, V&gt; <span class="title">andApply</span><span class="params">(Function&lt;T, ListenableFuture&lt;V&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion&lt;T, V&gt; c = <span class="keyword">new</span> AsyncCompletion&lt;&gt;(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion&lt;T, T&gt; <span class="title">andError</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            Completion&lt;T, T&gt; c = <span class="keyword">new</span> ErrorCompletion&lt;&gt;(econ);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;T&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion&lt;T, Void&gt; c = <span class="keyword">new</span> AcceptCompletion&lt;&gt;(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(T s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(S value)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;해당 포스팅은 토비님의 &lt;strong&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=Tb43EyWTSlQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;토비의 봄 TV 10회 스프링 리액티브 프로그래밍 (6)
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Async" scheme="https://jongmin92.github.io/tags/Async/"/>
    
  </entry>
  
  <entry>
    <title>비동기 RestTemplate과 비동기 MVC/Serlvet</title>
    <link href="https://jongmin92.github.io/2019/04/13/Java/java-async-2/"/>
    <id>https://jongmin92.github.io/2019/04/13/Java/java-async-2/</id>
    <published>2019-04-13T14:24:00.000Z</published>
    <updated>2019-04-30T10:11:37.290Z</updated>
    
    <content type="html"><![CDATA[<p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=ExUfZkh7Puk" target="_blank" rel="noopener">토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p><p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p><h1 id="thread-pool-hell"><a href="#Thread-Pool-Hell" class="headerlink" title="Thread Pool Hell"></a>Thread Pool Hell</h1><p><strong><a href="https://jongmin92.github.io/2019/03/31/Java/java-async-1/#servlet-async">스프링의 비동기 기술</a></strong> 을 이용해 클라이언트로부터 요청을 받은 후 실제 작업은 작업 스레드 풀에 위임하고 현재의 서블릿 스레드는 서블릿 스레드 풀에 반환 후, 다음 요청이 들어올 경우 바로 사용할 수 있게 효율적으로 처리하도록 만들었습니다.<br>그러나 아직 문제가 있습니다. </p><p>아주 빠르게 무언가를 계산하고 해당 처리를 끝내는 경우라면 굳이 비동기 MVC(서블릿)를 사용하지 않아도 문제가 없지만, <strong>하나의 요청에 대한 처리를 수행하면서 외부의 서비스들을 호출하는 작업이 많이 있는 경우, 문제는 단순히 비동기를 서블릿을 사용하는 것만으로 해결할 수 없는 경우가 많이 있습니다.</strong> (서블릿 요청은 바로 사용 가능하더라도 워커 스레드가 I/O 같은 작업으로 인해 블록되기 때문입니다.)</p><p><strong><code>Thread Pool Hell</code>이란 풀 안에 있는 스레드에 대한 사용 요청이 급격하게 증가해 추가적인 요청이 들어올 때, 사용 가능한 스레드 풀의 스레드가 없기 때문에 대기 상태에 빠져 요청에 대한 응답이 느려지게 되는 상태를 말합니다.</strong><br><img src="/images/post/2019-04-13/thread_pool_hell.png" alt="thread pool hell"></p><p>최근 서비스들은 아래의 그럼처럼 하나의 요청을 처리함에 있어 다른 서버로의 요청(Network I/O)이 많아졌습니다. 조금전 설명한 것처럼 비동기 서블릿을 사용하더라도 하나의 요청을 처리하는 동안 하나의 작업(워커) 스레드는 그 시간동안 대기상태에 빠지게 되어 결국에는 스레드 풀의 가용성이 떨어지게 됩니다. 이번 포스팅에서는 해당 문제를 해결해가는 과정을 다루고 있습니다.</p><p><img src="/images/post/2019-04-13/service_oriented_architecture.png" alt="service oriented architecture"></p><h1 id="upgrade-client-for-load-test"><a href="#Upgrade-Client-For-Load-Test" class="headerlink" title="Upgrade Client (For Load Test)"></a>Upgrade Client (For Load Test)</h1><p>지난 번에 작성했던 Client를 조금 수정하도록 합니다. 기존의 Client는 100개의 스레드를 순차적으로 만들면서 서버로의 Request를 만들었던 문제가 있었습니다. 이제는 100개의 스레드를 만들고 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CyclicBarrier.html" target="_blank" rel="noopener">CyclicBarrier</a>를 이용해 100개의 스레드에서 동시에 Request를 만들도록 변경해보겠습니다. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/rest?idx=&#123;idx&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">101</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// submit이 받는 callable은 return을 가질 수 있으며, exception도 던질 수 있다.</span></span><br><span class="line">            es.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">int</span> idx = counter.addAndGet(<span class="number">1</span>);</span><br><span class="line">                log.info(<span class="string">"Thread &#123;&#125;"</span>, idx);</span><br><span class="line">                barrier.await();</span><br><span class="line"></span><br><span class="line">                StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">                sw.start();</span><br><span class="line"></span><br><span class="line">                String res = rt.getForObject(url, String.class, idx);</span><br><span class="line"></span><br><span class="line">                sw.stop();</span><br><span class="line">                log.info(<span class="string">"idx: &#123;&#125;, Elapsed: &#123;&#125; -&gt; res: &#123;&#125;"</span>, idx, sw.getTotalTimeSeconds(), res);</span><br><span class="line">                <span class="comment">// IDE가 funtional interface가 callable임을 인식할 수 있도록 의미없는 return을 넣어준다.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// await을 만난 스레드가 101번째가 될 때, 모든 스레드들도 await에서 풀려나 이후 로직을 수행한다. </span></span><br><span class="line">        <span class="comment">// 메인 스레드 1개, Executors.newFixedThreadPool로 생성한 스레드 100개</span></span><br><span class="line">        barrier.await();</span><br><span class="line">        StopWatch main = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        main.start();</span><br><span class="line"></span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="comment">// 지정된 시간이 타임아웃 걸리기 전이라면 대기작업이 진행될 때까지 기다린다.</span></span><br><span class="line">        <span class="comment">// (100초안에 작업이 끝날때까지 기다리거나, 100초가 초과되면 종료)</span></span><br><span class="line">        es.awaitTermination(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        main.stop();</span><br><span class="line">        log.info(<span class="string">"Total: &#123;&#125;"</span>, main.getTotalTimeSeconds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="외부-서비스-호출-테스트"><a href="#외부-서비스-호출-테스트" class="headerlink" title="외부 서비스 호출 테스트"></a>외부 서비스 호출 테스트</h1><p>클라이언트의 요청을 받아 외부 서비스를 호출하고 해당 결과를 이용해서 응답을 돌려주는 테스트를 진행합니다. 테스트를 진행하기 위해서는 2개의 스프링 애플리케이션이 필요합니다. 2개의 스프링 애플리케이션의 설정은 다음과 같습니다.</p><ul><li>Main Application<ul><li>port: 8080</li><li>tomcat-max-thread-count: 1</li></ul></li><li>Remote Application <ul><li>port: 8081</li><li>tomcat-max-thread-count: 1000</li></ul></li></ul><h2 id="main-application"><a href="#Main-Application" class="headerlink" title="Main Application"></a>Main Application</h2><p>먼저 하나의 스프링 애플리케이션에 컨트롤러를 하나 준비합니다. 이 컨트롤러는 클라이언트로부터 요청을 받아 해당 요청으로부터 받은 값을 이용해 다른 외부 서비스(<a href="http://localhost:8081/service?req={req})를" target="_blank" rel="noopener">http://localhost:8081/service?req={req})를</a> 호출합니다.</p><p><strong>결국 해당 서블릿은 클라이언트 요청을 처리하면서 외부 서비스로의 Networking I/O 작업을 수행하기 때문에 외부 서비스로부터의 요청에 대한 응답을 받기 전까지는 blocking 상태가 됩니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            String res = rt.getForObject(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);        </span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>application.properties</code> 파일에서 다음과 같이 Tomcat의 스레드 개수를 1개로 설정합니다.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.tomcat.max-threads=1</span></span><br></pre></td></tr></table></figure></p><h2 id="remote-application"><a href="#Remote-Application" class="headerlink" title="Remote Application"></a>Remote Application</h2><p>다른 하나의 스프링 애플리케이션을 생성하고 이전에 만들었던 스프링 애플리케이션의 컨트롤러 내부에서 만들었던 요청을 받아 처리할 수 있도록 컨트롤러 추가합니다. 8080 포트가 아닌 8081 포트를 사용하고 tomcat 스레드를 1000개로 설정합니다. RemoteApplication은 application.properties의 값을 사용하게 하지 않고 직접 프로퍼티를 설정해줍니다. </p><p>아래와 같이 설정하면 Intellij를 이용해서 하나의 프로젝트에서 2개의 스프링 애플리케이션을 실행할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="결과-확인"><a href="#결과-확인" class="headerlink" title="결과 확인"></a>결과 확인</h2><p>MainApplication과 RemoteApplication을 각각 실행하고 Client를 이용한 테스트 결과는 다음과 같습니다.<br>100개의 클라이언트 요청을 처리하는데 0.4초 정도의 시간이 걸렸습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] INFO com.example.study.LoadTest - idx: <span class="number">40</span>, Elapsed: <span class="number">0.4</span> -&gt; res: hello40/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] INFO com.example.study.LoadTest - idx: <span class="number">77</span>, Elapsed: <span class="number">0.401</span> -&gt; res: hello77/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] INFO com.example.study.LoadTest - idx: <span class="number">48</span>, Elapsed: <span class="number">0.403</span> -&gt; res: hello48/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.546</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] INFO com.example.study.LoadTest - idx: <span class="number">8</span>, Elapsed: <span class="number">0.407</span> -&gt; res: hello8/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">0.409</span> -&gt; res: hello33/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">0.407</span></span><br></pre></td></tr></table></figure></p><p>이번에는 RemoteApplication의 요청 처리 부분에 2초간 Thread sleep을 주고 다시 한 번 클라이언트를 이용해 테스트를 진행해봅니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RemoteApplication</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Thread sleep을 추가하고 다시 테스트를 해보면 결과는 다음과 같습니다. 100개의 요청을 약 0.4초만에 모두 처리하던 이전과 달리 매 요청을 처리하는데 약 2초의 시간이 증가하고 있습니다. 결국 마지막 요청은 약 2 * 100 = 200초 후에서야 응답을 받을 수 있기 때문에 모든 요청에 대한 처리는 200초 정도 걸릴 것 입니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.056</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.058</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.061</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] INFO com.example.study.LoadTest - idx: <span class="number">32</span>, Elapsed: <span class="number">2.233</span> -&gt; res: hello32/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] INFO com.example.study.LoadTest - idx: <span class="number">56</span>, Elapsed: <span class="number">4.231</span> -&gt; res: hello56/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">6.238</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">8.249</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.081</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] INFO com.example.study.LoadTest - idx: <span class="number">20</span>, Elapsed: <span class="number">10.254</span> -&gt; res: hello20/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] INFO com.example.study.LoadTest - idx: <span class="number">46</span>, Elapsed: <span class="number">12.26</span> -&gt; res: hello46/service</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>이런 결과가 나오게 된 이유는 클라이언트로부터의 요청을 받아 처리하는 Main Application의 tomcat thread가 1개이고, 1개의 서블릿 스레드를 이용해 클라이언트의 요청을 처리하는 과정에서 Remote Application에 대한 요청(Network I/O)에서 응답을 받기까지 약 2초간 스레드가 block되기 때문입니다.</p><h1 id="asyncresttemplate"><a href="#AsyncRestTemplate" class="headerlink" title="AsyncRestTemplate"></a>AsyncRestTemplate</h1><p><strong>위의 문제는 MainApplication의 tomcat 스레드는 클라이언트의 요청을 처리하며 외부 서비스(RemoteApplication)로 요청(Network I/O)을 보낸 후, 응답이 올 때까지 대기하고 있는 상태라는 점입니다. 해당 시간동안 CPU는 아무 일을 처리하지 않기때문에 자원이 소모되고 있습니다.</strong></p><p><strong>이 문제를 해결하기 위해서는 API를 호출하는 작업을 비동기적으로 바꿔야합니다. tomcat 스레드는 요청에 대한 작업을 다 끝내기 전에 반환을 해서 바로 다음 요청을 처리하도록 사용합니다. 그리고 외부 서비스로부터 실제 결과를 받고 클라이언트의 요청에 응답을 보내기 위해서는 새로운 스레드를 할당 받아 사용합니다.</strong> (외부 서비스로부터 실제 결과를 받고 클라이언트에 응답을 보내기 위해서는 새로운 스레드를 할당 받아야 하지만, 외부 API를 호출하는 동안은 스레드(tomcat) 자원을 낭비하고 싶지 않다는 것이 목적이다.)</p><p>스프링 3.x 버전에서는 이 문제를 간단히 해결하기 어려웠지만 스프링 4 부터 제공하는 <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/AsyncRestTemplate.html" target="_blank" rel="noopener">AsyncRestTemplate</a>을 사용하면 이 문제를 쉽게 해결할 수 있습니다. <strong>AsyncRestTemplate은 비동기 클라이언트를 제공하는 클래스이며 ListenableFuture를 반환합니다. 스프링은 컨트롤러에서 ListenableFuture를 리턴하면 해당 스레드는 즉시 반납하고, 스프링 MVC가 자동으로 등록해준 콜백에 의해 결과가 처리됩니다.</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>실행 결과를 살펴보면 100개의 요청을 동시에 처리하는데 약 2.6초의 시간이 걸렸습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.088</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.example.study.LoadTest - idx: <span class="number">4</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello4/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] INFO com.example.study.LoadTest - idx: <span class="number">44</span>, Elapsed: <span class="number">2.659</span> -&gt; res: hello44/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.095</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] INFO com.example.study.LoadTest - idx: <span class="number">66</span>, Elapsed: <span class="number">2.664</span> -&gt; res: hello66/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] INFO com.example.study.LoadTest - idx: <span class="number">16</span>, Elapsed: <span class="number">2.667</span> -&gt; res: hello16/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] INFO com.example.study.LoadTest - idx: <span class="number">57</span>, Elapsed: <span class="number">2.669</span> -&gt; res: hello57/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.example.study.LoadTest - idx: <span class="number">2</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello2/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] INFO com.example.study.LoadTest - idx: <span class="number">15</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello15/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.106</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.673</span></span><br></pre></td></tr></table></figure></p><p>클라이언트의 요청이 들어 올 때, MainApplication의 스레드 상태를 살펴보면, tomcat 스레드는 그대로 1개 입니다.(http-nio-8080-exec-1) 그러나 비동기 작업을 처리하기 위해서 순간적으로 백그라운드에 100개의 스레드 새로 생성되는것을 확인할 수 있습니다.<br><img src="/images/post/2019-04-13/async_rest_template_result.png" alt="async rest template result"></p><h1 id="netty-non-blocking-io"><a href="#Netty-non-blocking-I-O" class="headerlink" title="Netty non-blocking I/O"></a>Netty non-blocking I/O</h1><p>지금까지 Tomcat의 스레드가 1개이지만 요청을 비동기적으로 처리함으로써 Tomcat의 스레드는 바로 반환이되어 다시 그 후의 요청에 Tomcat의 스레드를 이용해 요청을 받을 수 있었습니다. 그러나 결과적으로는 실제 비동기 요청을 처리하는 스레드는 요청의 수 만큼 계속 생성되는 것을 확인할 수 있었습니다.</p><p>이번에는 이렇게 <strong>비동기 요청을 처리하는 스레드의 수도 Netty의 non blocking I/O를 이용함으로써 비동기 요청을 처리하는 스레드도 줄여보고자 합니다.</strong> 그러면 결과적으로 tomcat의 스레드 1개, netty의 non blocking I/O를 이용하기위한 필요한 스레드의 수만큼만 생성되어 클라이언트의 요청을 모두 처리할 수 있을 것 입니다.</p><p>먼저 netty의 dependency를 build.gradle 혹은 pom.xml에 추가합니다. 저는 build.gradle에 의존성을 추가해 주었습니다.<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation <span class="string">'io.netty:netty-all:4.0.4.Final'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>AsyncRestTemplate이 netty의 Netty4ClientHttpRequestFactory를 이용할 수 있도록 다음과 같이 설정합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>다시 서버를 띄우고 테스트를 해보면 클라이언트의 요청을 전부 처리하는데 걸린 시간은 약 2.7초로 이전과 큰 차이가 없습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] INFO com.example.study.LoadTest - idx: <span class="number">65</span>, Elapsed: <span class="number">2.744</span> -&gt; res: hello65/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] INFO com.example.study.LoadTest - idx: <span class="number">59</span>, Elapsed: <span class="number">2.751</span> -&gt; res: hello59/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">2.752</span> -&gt; res: hello14/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">2.754</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] INFO com.example.study.LoadTest - idx: <span class="number">63</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello63/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] INFO com.example.study.LoadTest - idx: <span class="number">19</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello19/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] INFO com.example.study.LoadTest - idx: <span class="number">62</span>, Elapsed: <span class="number">2.756</span> -&gt; res: hello62/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.755</span></span><br></pre></td></tr></table></figure></p><p>스레드를 확인해보면 다음과 같이 tomcat 스레드 1개, netty가 non blocking I/O를 사용하는데 필요로 하는 몇개의 스레드가 추가된 것 말고는 스레드 수가 크게 증가하지 않은것을 확인할 수 있습니다.<br><img src="/images/post/2019-04-13/netty_nio_result.png" alt="async rest template result"></p><h1 id="deferredresult"><a href="#DeferredResult" class="headerlink" title="DeferredResult"></a>DeferredResult</h1><p>이전 포스팅에서 살펴 보았던 <strong>DeferredResult를 사용하면 AsyncRestTemplate을 사용하여 외부 서비스를 호출한 후, 그 결과를 다시 이용해 클라이언트의 요청에 응답하는 추가 로직 부분을 작성할 수 있습니다.</strong></p><p>컨트롤러에서 DeferredResult 오브젝트를 반환하는 시점에는 바로 응답이 가지 않고, 추후 해당 DeferredResult 오브젝트에 값을 set(setResult, setErrorResult) 해줄 때, 클라이언트에게 응답이 가게 됩니다. 이를 이용하려면 ListenableFuture에 콜백을 추가해 해당 콜백 로직 안에서 결과를 이용해 DeferredResult 오브젝트의 set 메서드를 호출하면 됩니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                dr.setResult(s.getBody() + <span class="string">"/work"</span>);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>외부 서비스의 응답을 받아 “/work” 문자열이 추가되어 클라이언트에 전달된것을 확인할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello33/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] INFO com.example.study.LoadTest - idx: <span class="number">79</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello79/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] INFO com.example.study.LoadTest - idx: <span class="number">80</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello80/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] INFO com.example.study.LoadTest - idx: <span class="number">9</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello9/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello60/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] INFO com.example.study.LoadTest - idx: <span class="number">98</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello98/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.346</span></span><br></pre></td></tr></table></figure></p><h1 id="중첩된-remote-service-사용"><a href="#중첩된-Remote-Service-사용" class="headerlink" title="중첩된 Remote Service 사용"></a>중첩된 Remote Service 사용</h1><p>이번에는 외부 서비스를 하나 더 추가해보겠습니다. 외부 서비스의 요청에 대한 결과를 다시 다른 서비스를 호출하는 요청의 파라미터로 사용하면서 콜백의 구조가 복잡해지는 문제가 생기게 되었습니다. 이런 문제를 <strong>콜백 헬</strong>이라고 합니다.</p><p>다음번 포스팅에서는 콜백 헬을 해결할 수 있는 방법에 대해서 알아보도록 하겠습니다.</p><h2 id="remote-application"><a href="#Remote-Application-1" class="headerlink" title="Remote Application"></a>Remote Application</h2><p>“/service2”를 추가합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service2"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service2</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service2"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="main-application"><a href="#Main-Application-1" class="headerlink" title="Main Application"></a>Main Application</h2><p>“/service”를 호출한 결과를 이용해 “/service2”를 호출하도록 합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>, String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity(<span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>, String.class, s.getBody());</span><br><span class="line">                f2.addCallback(s2 -&gt; &#123;</span><br><span class="line">                    dr.setResult(s2.getBody());</span><br><span class="line">                &#125;, e -&gt; &#123;</span><br><span class="line">                    dr.setErrorResult(e.getMessage());</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="결과-확인"><a href="#결과-확인-1" class="headerlink" title="결과 확인"></a>결과 확인</h2><p>100개의 클라이언트 요청을 처리하는데 약 4.3초의 시간이 걸렸습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] INFO com.example.study.LoadTest - idx: <span class="number">17</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello17/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] INFO com.example.study.LoadTest - idx: <span class="number">87</span>, Elapsed: <span class="number">4.337</span> -&gt; res: hello87/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello14/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] INFO com.example.study.LoadTest - idx: <span class="number">74</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello74/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello60/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] INFO com.example.study.LoadTest - idx: <span class="number">38</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello38/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] INFO com.example.study.LoadTest - idx: <span class="number">78</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello78/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.example.study.LoadTest - idx: <span class="number">5</span>, Elapsed: <span class="number">4.342</span> -&gt; res: hello5/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">4.338</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;해당 포스팅은 토비님의 &lt;strong&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=ExUfZkh7Puk&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Async" scheme="https://jongmin92.github.io/tags/Async/"/>
    
      <category term="RestTemplate" scheme="https://jongmin92.github.io/tags/RestTemplate/"/>
    
      <category term="AsyncRestTemplate" scheme="https://jongmin92.github.io/tags/AsyncRestTemplate/"/>
    
      <category term="Netty" scheme="https://jongmin92.github.io/tags/Netty/"/>
    
      <category term="DeferredResult" scheme="https://jongmin92.github.io/tags/DeferredResult/"/>
    
  </entry>
  
  <entry>
    <title>자바와 스프링의 비동기 기술</title>
    <link href="https://jongmin92.github.io/2019/03/31/Java/java-async-1/"/>
    <id>https://jongmin92.github.io/2019/03/31/Java/java-async-1/</id>
    <published>2019-03-31T11:22:00.000Z</published>
    <updated>2019-04-30T10:11:37.288Z</updated>
    
    <content type="html"><![CDATA[<p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=aSTuQiPB4Ns&amp;index=7&amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC" target="_blank" rel="noopener">토비의 봄 TV 8회 스프링 리액티브 프로그래밍 (4) 자바와 스프링의 비동기 기술</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p><p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p><h1 id="자바의-비동기-기술"><a href="#자바의-비동기-기술" class="headerlink" title="자바의 비동기 기술"></a>자바의 비동기 기술</h1><h2 id="executorservice"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h2><p><strong><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html" target="_blank" rel="noopener">ExecutorService</a></strong>는 쉽게 비동기로 작업을 실행할 수 있도록 도와주는 JDK(1.5부터)에서 제공하는 interface입니다. 일반적으로 ExecutorService는 작업 할당을 위한 스레드 풀과 API를 제공합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        es.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">20</span>:<span class="number">35</span>:<span class="number">53.892</span> [main] INFO com.example.study.FutureEx - Exit</span><br><span class="line"><span class="number">20</span>:<span class="number">35</span>:<span class="number">55.888</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br></pre></td></tr></table></figure><h2 id="future"><a href="#Future" class="headerlink" title="Future"></a>Future</h2><p><strong><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html" target="_blank" rel="noopener">Future</a>는 자바 1.5에서 등장한 비동기 계산의 결과를 나타내는 Interface 입니다.</strong> </p><p><strong>비동기적인 작업을 수행한다는 것은 현재 진행하고 있는 스레드가 아닌 별도의 스레드에서 작업을 수행하는 것을 말합니다.</strong> 같은 스레드에서 메서드를 호출할 때는 결과를 리턴 값을 받지만, 비동기적으로 작업을 수행할 때는 결과값을 전달받을 수 있는 무언가의 interface가 필요한데 Future가 그 역할을 합니다.</p><p><strong>비동기 작업에서 결과를 반환하고 싶을 때는 runnable대신 callable interface를 이용하면 결과 값을 return 할 수 있습니다.</strong> 또한 예외가 발생했을 때 해당 예외를 비동기 코드를 처리하는 스레드 안에서 처리하지 않고 밖으로 던질 수 있습니다. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        Future&lt;String&gt; f = es.submit(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.info(f.get());</span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">20</span>:<span class="number">43</span>:<span class="number">11.704</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">20</span>:<span class="number">43</span>:<span class="number">11.706</span> [main] INFO com.example.study.FutureEx - Hello</span><br><span class="line"><span class="number">20</span>:<span class="number">43</span>:<span class="number">11.706</span> [main] INFO com.example.study.FutureEx - Exit</span><br></pre></td></tr></table></figure><p><strong>Future를 통해서 비동기 결과의 값을 가져올 때는 get 메서드를 사용합니다.</strong> 그러나 get 메서드를 호출하게 되면 비동기 작업이 완료될 때까지 해당 스레드가 blocking됩니다.</p><p>Future는 비동기적인 연산 혹은 작업을 수행하고 그 결과를 갖고 있으며, 완료를 기다리고 계산 결과를 반환(get)하는 메소드와 그 외에도 해당 연산이 완료되었는지 확인하는(isDone) 메소드를 제공합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        Future&lt;String&gt; f = es.submit(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        log.info(f.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">00.501</span> [main] INFO com.example.study.FutureEx - <span class="keyword">false</span></span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.502</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.509</span> [main] INFO com.example.study.FutureEx - Exit</span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.509</span> [main] INFO com.example.study.FutureEx - <span class="keyword">true</span></span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.509</span> [main] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure><h2 id="futuretask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h2><p><strong><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/FutureTask.html" target="_blank" rel="noopener">FutureTask</a></strong>는 비동기 작업을 생성합니다. 지금까지 위의 코드는 비동기 작업 생성과 실행을 동시에 했다면 FutureTask는 비동기 작업 생성과 실행을 분리하여 진행할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        FutureTask&lt;String&gt; f = <span class="keyword">new</span> FutureTask&lt;&gt;(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line"></span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        log.info(f.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">39.459</span> [main] INFO com.example.study.FutureEx - <span class="keyword">false</span></span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.461</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.467</span> [main] INFO com.example.study.FutureEx - Exit</span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.467</span> [main] INFO com.example.study.FutureEx - <span class="keyword">true</span></span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.467</span> [main] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure><p><strong>비동기 작업의 결과를 가져오는 방법은 Future와 같은 결과를 다루는 <code>handler</code>를 이용하거나 <code>callback</code>을 이용하는 2가지 방법이 있습니다.</strong><br>아래의 예시 코드는 FutureTask의 비동기 작업이 완료될 경우 호출되는 done() 메서드를 재정의하여 callback을 이용하는 방법입니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        FutureTask&lt;String&gt; f = <span class="keyword">new</span> FutureTask&lt;String&gt;(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.done();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(get());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line">        es.shutdown();</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">"EXIT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">01</span>:<span class="number">03</span>:<span class="number">04.153</span> [main] INFO com.example.study.FutureEx - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">03</span>:<span class="number">06.153</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">01</span>:<span class="number">03</span>:<span class="number">06.153</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure><p>위 예시 코드의 callback 관련 부분을 FutureTask를 상속받아 done() 메서드를 재정의함으로써, 비동기 코드와 그 결과를 갖고 작업을 수행하는 callback을 좀 더 가독성이 좋게 작성할 수 있습니다. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">SuccessCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackFutureTask</span> <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        SuccessCallback sc;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CallbackFutureTask</span><span class="params">(Callable&lt;String&gt; callable, SuccessCallback sc)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(callable);</span><br><span class="line">            <span class="keyword">this</span>.sc = Objects.requireNonNull(sc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.done();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.sc.onSuccess(get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        CallbackFutureTask f = <span class="keyword">new</span> CallbackFutureTask(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;, log::info);</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">01</span>:<span class="number">05</span>:<span class="number">01.978</span> [main] INFO com.example.study.FutureEx - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">05</span>:<span class="number">03.977</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">01</span>:<span class="number">05</span>:<span class="number">03.978</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure><p>위 예시 코드에 SuccessCallback을 추가한 것처럼 ExceptionCallback을 추가하여 비동기 코드에서 예외가 발생할 경우, 해당 예외를 처리하는 callback도 추가할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">SuccessCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ExceptionCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackFutureTask</span> <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        SuccessCallback sc;</span><br><span class="line">        ExceptionCallback ec;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CallbackFutureTask</span><span class="params">(Callable&lt;String&gt; callable, SuccessCallback sc, ExceptionCallback ec)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(callable);</span><br><span class="line">            <span class="keyword">this</span>.sc = Objects.requireNonNull(sc);</span><br><span class="line">            <span class="keyword">this</span>.ec = Objects.requireNonNull(ec);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.done();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.sc.onSuccess(get());</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 InterruptedException은 예외긴 예외이지만, 현재 작업을 수행하지 말고 중단해라 라고 메시지를 보내는 용도이다.</span></span><br><span class="line"><span class="comment">                 따라서 현재 스레드에 interrupt를 체크하고 종료한다.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                <span class="comment">// 래핑된 에러를 빼내어 전달한다.</span></span><br><span class="line">                ec.onError(e.getCause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        CallbackFutureTask f = <span class="keyword">new</span> CallbackFutureTask(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> == <span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Async ERROR!!!"</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">                s -&gt; log.info(<span class="string">"Result: &#123;&#125;"</span>, s),</span><br><span class="line">                e -&gt; log.info(<span class="string">"Error: &#123;&#125;"</span>, e.getMessage()));</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line">        es.shutdown();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"EXIT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">01</span>:<span class="number">11</span>:<span class="number">53.460</span> [main] INFO com.example.study.FutureEx - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">11</span>:<span class="number">55.463</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Error: Async ERROR!!!</span><br></pre></td></tr></table></figure><h1 id="스프링의-비동기-기술"><a href="#스프링의-비동기-기술" class="headerlink" title="스프링의 비동기 기술"></a>스프링의 비동기 기술</h1><h2 id="async"><a href="#Async" class="headerlink" title="@Async"></a>@Async</h2><p>Spring MVC 3.2 부터 Servlet 3.0 기반의 비동기 요청 처리가 가능해졌습니다. <strong><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/scheduling/annotation/Async.html" target="_blank" rel="noopener">@Async</a> 어노테이션을 추가해 해당 메서드를 비동기적으로 호출할 수 있습니다.</strong> 해당 메서드를 호출한 호출자(caller)는 즉시 리턴하고 메소드의 실제 실행은 Spring TaskExecutor에 의해서 실행됩니다. 비동기로 실행되는 메서드는 Future 형식의 값을 리턴하고, 호출자는 해당 Future의 get() 메서드를 호출하기 전에 다른 작업을 수행할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         내부적으로 AOP를 이용해 복잡한 로직이 실행된다.</span></span><br><span class="line"><span class="comment">         비동기 작업은 return값으로 바로 결과를 줄 수 없다. (Future 혹은 Callback을 이용해야 한다.)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"hello()"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// try with resource 블록을 이용해 빈이 다 준비된 후 종료되도록 설정</span></span><br><span class="line">        <span class="keyword">try</span> (ConfigurableApplicationContext c = SpringApplication.run(StudyApplication.class, args)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 모든 빈이 다 준비된 후 실행됨 (현재는 일종의 컨트롤러라고 생각)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ApplicationRunner <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"run()"</span>);</span><br><span class="line">            Future&lt;String&gt; res = myService.hello();</span><br><span class="line">            log.info(<span class="string">"exit: &#123;&#125;"</span>, res.isDone());</span><br><span class="line">            log.info(<span class="string">"result: &#123;&#125;"</span>, res.get());</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">31.960</span>  INFO <span class="number">41618</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">31.960</span>  INFO <span class="number">41618</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">928</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">32.161</span>  INFO <span class="number">41618</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">32.337</span>  INFO <span class="number">41618</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.341  INFO 41618 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 1.631 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.101</span>)</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.343  INFO 41618 --- [           main] com.example.study.StudyApplication       : <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.346  INFO 41618 --- [           main] com.example.study.StudyApplication       : exit: <span class="keyword">false</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.350  INFO 41618 --- [         task-1] com.example.study.StudyApplication       : <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:33.351  INFO 41618 --- [           main] com.example.study.StudyApplication       : result: Hello</span></span><br><span class="line"><span class="function">2019-04-04 23:29:33.354  INFO 41618 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'</span></span><br></pre></td></tr></table></figure><h2 id="listenablefuture"><a href="#ListenableFuture" class="headerlink" title="ListenableFuture"></a>ListenableFuture</h2><p>스프링 4.0 부터 제공하는 Future 인터페이스를 확장한 <strong><a href="https://docs.spring.io/autorepo/docs/spring-framework/4.0.5.RELEASE/javadoc-api/org/springframework/util/concurrent/ListenableFuture.html" target="_blank" rel="noopener">ListenableFuture</a>를 이용하면 비동기 처리의 결과 값을 사용할 수 있는 callback을 추가할 수 있습니다.</strong><br>@Async 어노테이션을 사용하는 메서드에서 스프링 4.1 부터 제공하는 ListenableFuture 인터페이스를 구현한 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/AsyncResult.html" target="_blank" rel="noopener">AsyncResult</a>를 반환하면 됩니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"hello()"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// try with resource 블록을 이용해 빈이 다 준비된 후 종료되도록 설정</span></span><br><span class="line">        <span class="keyword">try</span> (ConfigurableApplicationContext c = SpringApplication.run(StudyApplication.class, args)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ApplicationRunner <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"run()"</span>);</span><br><span class="line">            ListenableFuture&lt;String&gt; f = myService.hello();</span><br><span class="line">            f.addCallback(s -&gt; log.info(s), e-&gt; log.info(e.getMessage()));</span><br><span class="line">            log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.348</span>  INFO <span class="number">44559</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.348</span>  INFO <span class="number">44559</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">959</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.557</span>  INFO <span class="number">44559</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.736</span>  INFO <span class="number">44559</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.740  INFO 44559 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 1.779 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.306</span>)</span></span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.742  INFO 44559 --- [           main] com.example.study.StudyApplication       : <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.748  INFO 44559 --- [           main] com.example.study.StudyApplication       : exit</span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.751  INFO 44559 --- [         task-1] com.example.study.StudyApplication       : <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:42:47.752  INFO 44559 --- [         task-1] com.example.study.StudyApplication       : Hello</span></span><br><span class="line"><span class="function">2019-04-04 23:42:48.757  INFO 44559 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'</span></span><br></pre></td></tr></table></figure><h2 id="threadpooltaskexecutor"><a href="#ThreadPoolTaskExecutor" class="headerlink" title="ThreadPoolTaskExecutor"></a>ThreadPoolTaskExecutor</h2><p><strong>@Async 어노테이션을 사용해 해당 메서드를 비동기적으로 호출할 경우 ThreadPool을 명시적으로 선언하지 않으면, 기본적으로 <a href="https://docs.spring.io/spring/docs/3.1.x/javadoc-api/org/springframework/core/task/SimpleAsyncTaskExecutor.html" target="_blank" rel="noopener">SimpleAsyncTaskExecutor</a>를 사용합니다.</strong> SimpleAsyncTaskExecutor는 각 비동기 호출마다 계속 새로운 스레드를 만들어 사용하기 때문에 비효율적입니다. 이 경우 ThreadPoolTaskExecutor를 직접 만들어 사용하는게 효율적입니다.</p><p><strong><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html" target="_blank" rel="noopener">ThreadPoolTaskExecutor</a>는 CorePool, QueueCapacity, MaxPoolSize를 직접 설정할 수 있습니다.</strong> 각 값에 대한 설명은 코드에 추가했습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         기본적으로 SimpleAsyncTaskExecutor를 사용한다. 스레드를 계속 새로 만들어 사용하기 때문에 비효율적이다.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="comment">// @Async("tp") ThreadPool이 여러개일 경우 직접 지정 가능하다.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"hello()"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ThreadPoolTaskExecutor <span class="title">tp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        <span class="comment">// 1) 스레드 풀을 해당 개수까지 기본적으로 생성함. 처음 요청이 들어올 때 poll size만큼 생성한다.</span></span><br><span class="line">        te.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 2) 지금 당장은 Core 스레드를 모두 사용중일때, 큐에 만들어 대기시킨다.</span></span><br><span class="line">        te.setQueueCapacity(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">// 3) 대기하는 작업이 큐에 꽉 찰 경우, 풀을 해당 개수까지 더 생성한다.</span></span><br><span class="line">        te.setMaxPoolSize(<span class="number">100</span>);</span><br><span class="line">        te.setThreadNamePrefix(<span class="string">"myThread"</span>);</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// try with resource 블록을 이용해 빈이 다 준비된 후 종료되도록 설정</span></span><br><span class="line">        <span class="keyword">try</span> (ConfigurableApplicationContext c = SpringApplication.run(StudyApplication.class, args)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 모든 빈이 다 준비된 후 실행됨 (현재는 일종의 컨트롤러라고 생각)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ApplicationRunner <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"run()"</span>);</span><br><span class="line">            ListenableFuture&lt;String&gt; f = myService.hello();</span><br><span class="line">            f.addCallback(s -&gt; log.info(s), e-&gt; log.info(e.getMessage()));</span><br><span class="line">            log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.304</span>  INFO <span class="number">47863</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.304</span>  INFO <span class="number">47863</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">1061</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.367</span>  INFO <span class="number">47863</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'tp'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.677</span>  INFO <span class="number">47863</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.680  INFO 47863 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 1.751 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.208</span>)</span></span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.681  INFO 47863 --- [           main] com.example.study.StudyApplication       : <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.686  INFO 47863 --- [           main] com.example.study.StudyApplication       : exit</span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.687  INFO 47863 --- [      myThread1] com.example.study.StudyApplication       : <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-05 00:03:12.691  INFO 47863 --- [      myThread1] com.example.study.StudyApplication       : Hello</span></span><br></pre></td></tr></table></figure><h2 id="servlet-async"><a href="#Servlet-Async" class="headerlink" title="Servlet Async"></a>Servlet Async</h2><p>@Async 어노테이션을 설명할 때 말했던 것처럼, Spring MVC 3.2 부터 Servlet 3.0 기반의 비동기 요청 처리가 가능해졌습니다. <strong>기존 Controller 메서드를 <a href="https://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Callable.html" target="_blank" rel="noopener">Callable</a>로 변경함으로써 비동기로 만들 수 있습니다.</strong><br>Controller 메서드를 비동기로 변경해도 해당 처리가 서블릿 스레드가 아닌 다른 스레드에서 발생한다는 점을 제외하면 기존 Controller 메서드의 동작 방식과는 큰 차이가 없습니다.<br>(참고 : <a href="https://spring.io/blog/2012/05/10/spring-mvc-3-2-preview-making-a-controller-method-asynchronous" target="_blank" rel="noopener">Spring MVC 3.2 Preview: Making a Controller Method Asynchronous</a>)</p><blockquote><p>Servlet 3.0 &amp; 3.1</p><ul><li>Servlet 3.0: 비동기 서블릿<ul><li>HTTP connection은 이미 논블록킹 IO</li><li>서블릿 요청 읽기, 응답 쓰기는 블록킹</li><li>비동기 작업 시작 즉시 서블릿 스레드 반납</li><li>비동기 작업이 완료되면 서블릿 스레드 재할당</li><li>비동기 서블릿 컨텍스트 이용 (AsyncContext)</li></ul></li><li>Servlet 3.1: 논블록킹 IO<ul><li>논블록킹 서블릿 요청, 응답 처리</li><li>Callback</li></ul></li></ul><p>스레드가 블록되는 상황은 CPU와 메모리 자원을 많이 소모합니다. 컨텍스트 스위칭이 일어나기 때문입니다. 기본적으로 스레드가 블로킹되면 wating 상태로 변경되면서 컨텍스트 스위칭이 일어나고 추후 I/O 작업이 끝나 running 상태로 변경되면서 다시 컨텍스트 스위칭이 일어나 총 2번의 컨텍스트 스위칭이 일어납니다.<br>Java InputStream과 OutputStream은 블록킹 방식이다. RequestHttpServletRequest, RequestHttpServletResponse는 InputSream과 OutputStream을 사용하기 때문에 서블릿은 기본적으로 블로킹 IO 방식이다.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/callable"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">callable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            log.info(<span class="string">"callable"</span>);</span><br><span class="line">            <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">"async"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">41.761</span>  INFO <span class="number">69216</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">41.762</span>  INFO <span class="number">69216</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">1206</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">41.993</span>  INFO <span class="number">69216</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">42.182</span>  INFO <span class="number">69216</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-06 01:12:42.186  INFO 69216 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 2.073 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.807</span>)</span></span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.161  INFO 69216 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.162  INFO 69216 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.169  INFO 69216 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 7 ms</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.190  INFO 69216 --- [nio-8080-exec-1] com.example.study.StudyApplication       : callable</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.198  INFO 69216 --- [         task-1] com.example.study.StudyApplication       : async</span></span><br></pre></td></tr></table></figure><p>실제로 비동기 서블릿은 아래의 그림처럼 동작합니다.<br><img src="/images/post/2019-03-31/async_servlet_structure.png" alt="비동기 서블릿 구조"></p><h3 id="client-for-load-test"><a href="#Client-For-Load-Test" class="headerlink" title="Client (For Load Test)"></a>Client (For Load Test)</h3><p>지금부터는 Spring에서 Sync Servlet을 이용할 때와 Async Servlet을 이용했을 때의 차이점을 알아보기 위해 테스트를 할 수 있도록, 먼저 여러 Request를 동시에 생성하는 Client를 작성해봅니다.<br>Spring에서 제공하는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html" target="_blank" rel="noopener">RestTemplate</a>을 이용해 100개의 Request를 동시에 호출합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/callable"</span>;</span><br><span class="line"></span><br><span class="line">        StopWatch main = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        main.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            es.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">int</span> idx = counter.addAndGet(<span class="number">1</span>);</span><br><span class="line">                log.info(<span class="string">"Thread &#123;&#125;"</span>, idx);</span><br><span class="line"></span><br><span class="line">                StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">                sw.start();</span><br><span class="line"></span><br><span class="line">                rt.getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">                sw.stop();</span><br><span class="line">                log.info(<span class="string">"Elapsed: &#123;&#125; -&gt; &#123;&#125;"</span>, idx, sw.getTotalTimeSeconds());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="comment">// 지정된 시간이 타임아웃 걸리기 전이라면 대기작업이 진행될 때까지 기다린다.</span></span><br><span class="line">        <span class="comment">// (100초안에 작업이 끝날때까지 기다리거나, 100초가 초과되면 종료)</span></span><br><span class="line">        es.awaitTermination(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        main.stop();</span><br><span class="line">        log.info(<span class="string">"Total: &#123;&#125;"</span>, main.getTotalTimeSeconds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="change-tomcat-thread-count"><a href="#Change-Tomcat-Thread-Count" class="headerlink" title="Change Tomcat Thread Count"></a>Change Tomcat Thread Count</h3><p><strong>위의 비동기 서블릿 그림에서 볼 수 있듯이, Async Servlet은 클라이언트로부터 요청을 받은 후 실제 작업은 작업 스레드 풀에 위임하고 현재의 서블릿 스레드는 서블릿 스레드 풀에 반환 후, 다음 요청이 들어올 경우 사용할 수 있도록 합니다. 이에 반해, Sync Servlet은 요청을 받은 서블릿 스레드에서 실제 작업까지 전부 진행하기 때문에 요청에 대한 응답을 반환하기 전까지는 새로운 요청을 처리할 수 없는 상태입니다.</strong></p><p>실제 이처럼 동작하는지 확인하기 위해서 <code>application.properties</code> 파일에서 다음과 같이 Tomcat의 스레드 개수를 1개로 설정합니다.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.tomcat.max-threads=1</span></span><br></pre></td></tr></table></figure></p><h3 id="sync-vs-async"><a href="#Sync-vs-Async" class="headerlink" title="Sync vs Async"></a>Sync vs Async</h3><h4 id="sync"><a href="#Sync" class="headerlink" title="Sync"></a>Sync</h4><p>먼저 아래와 같이 Sync Servlet을 이용해 서버를 띄운 후 위의 Client 코드를 이용해 테스트를 진행합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/callable"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">callable</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"sync"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>해당 서버를 띄우고 Client(LoadTest) 코드를 사용해 테스트를 진행하면 결과는 다음과 같습니다. Tomcat의 스레드가 하나이며 Sync 방식으로 동작하기 때문에 한 번에 하나의 클라이언트 요청만 처리할 수 있습니다. 서버 로그를 확인하면 <strong>nio-8080-exec-1</strong> 라는 이름을 가진 한개의 스레드가 요청을 처리하고 있습니다.<br><img src="/images/post/2019-03-31/sync_servlet.png" alt="동기 서블릿 테스트 결과"></p><p>이번에는 <code>JMC(Java Mission Control)</code>를 이용해 실제 서버의 스레드 상황을 살펴보겠습니다.</p><blockquote><p>JMC를 이용하기 위해서는 서버를 실행할 때 다음과 같은 JVM 옵션을 추가합니다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockCommercialFeatures</span><br><span class="line">-XX:+FlightRecorder</span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span></span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span></span><br><span class="line">-Djava.rmi.server.hostname=localhost</span><br></pre></td></tr></table></figure></p></blockquote><p>JMC를 이용해 클라이언트 요청이 들어올 때, Thread 상태를 보면 다음과 같습니다. 동시에 100개의 클라이언트 요청이 들어왔지만, 스레드 수는 그대로 유지되고 있으며, 여러 스레드 목록 중에 <strong>nio-8080-exec-1</strong> 스레드가 존재하고 있는것을 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/sync_servlet_thread.png" alt="동기 서블릿 테스트 결과 - 스레드"></p><h4 id="async"><a href="#Async-1" class="headerlink" title="Async"></a>Async</h4><p>이번에는 서버 코드를 아래와 같이 Async Servlet을 이용하도록 수정한 후 서버를 띄워 Client 코드를 이용해 테스트를 진행합니다. (작업 스레드 풀은 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.html" target="_blank" rel="noopener">WebMvcConfigurer</a>를 통해 설정해줍니다.)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/callable"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">callable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">"async"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">WebMvcConfigurer <span class="title">configurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="comment">// 워커 스레드 풀 설정</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAsyncSupport</span><span class="params">(AsyncSupportConfigurer configurer)</span> </span>&#123;</span><br><span class="line">                ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">                te.setCorePoolSize(<span class="number">100</span>);</span><br><span class="line">                te.setQueueCapacity(<span class="number">50</span>);</span><br><span class="line">                te.setMaxPoolSize(<span class="number">200</span>);</span><br><span class="line">                te.setThreadNamePrefix(<span class="string">"workThread"</span>);</span><br><span class="line">                te.initialize();</span><br><span class="line">                configurer.setTaskExecutor(te);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Client(LoadTest) 코드를 사용해 테스트를 진행하면 결과는 다음과 같습니다. Tomcat의 스레드가 하나이지만 Async 방식으로 동작하기 때문에 해당 요청에 대한 실제 처리는 워커 스레드 풀에서 사용되고 있지 않은 스레드를 이용해 처리합니다. 서버 로그를 확인하면 <strong>nio-8080-exec-1</strong> 라는 이름을 가진 한개의 Tomcat 스레드와 <strong>workThreadX</strong>라는 이름을 가진 100개의 워커 스레드를 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/async_servlet.png" alt="비동기 서블릿 테스트 결과"></p><p>이번에도 역시 <code>JMC(Java Mission Control)</code>를 이용해 실제 서버의 스레드 상황을 살펴보겠습니다.</p><p><strong>nio-8080-exec-1</strong> 라는 이름을 가진 한개의 Tomcat 스레드와 <strong>workThreadX</strong>라는 이름을 가진 100개의 워커 스레드를 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/async_servlet_thread.png" alt="비동기 서블릿 테스트 결과 - 스레드"></p><h3 id="deferredresult"><a href="#DeferredResult" class="headerlink" title="DeferredResult"></a>DeferredResult</h3><p><strong><a href="https://docs.spring.io/spring/docs/5.0.4.BUILD-SNAPSHOT/javadoc-api/org/springframework/web/context/request/async/DeferredResult.html" target="_blank" rel="noopener">DeferredResult</a>는 Spring 3.2 부터 사용 가능합니다.</strong> 비동기 요청 처리를 위해 사용하는 Callable의 대안을 제공합니다. “지연된 결과”를 의미하며 외부의 이벤트 혹은 클라이언트 요청에 의해서 지연되어 있는 HTTP 요청에 대한 응답을 나중에 써줄 수 있는 기술입니다. <strong>별도로 워커 스레드를 만들어 대기하지 않고도 처리가 가능합니다.</strong></p><p><img src="/images/post/2019-03-31/deferredresult_structure.png" alt="DeferredResult 구조"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        Queue&lt;DeferredResult&lt;String&gt;&gt; results = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/dr"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">dr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            log.info(<span class="string">"dr"</span>);</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">            results.add(dr);</span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/dr/count"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">drCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(results.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/dr/event"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">drEvent</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (DeferredResult&lt;String&gt; dr : results) &#123;</span><br><span class="line">                dr.setResult(<span class="string">"Hello "</span> + msg);</span><br><span class="line">                results.remove(dr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LoadTest 코드를 이용해 /dr로 100개의 요청을 보내고, 크롬에서 /dr/count로 DeferredResult가 담겨있는 큐의 사이즈를 확인해봅니다. 그리고 마지막으로 /dr/event로 큐에 담긴 DeferredResult 객체에 setResult로 결과를 반환합니다.<br>100개의 요청이 동시에 완료되는 것을 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/deferredresult.png" alt="DeferredResult 결과"></p><h3 id="responsebodyemitter"><a href="#ResponseBodyEmitter" class="headerlink" title="ResponseBodyEmitter"></a>ResponseBodyEmitter</h3><p><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/ResponseBodyEmitter.html" target="_blank" rel="noopener">ResponseBodyEmitter</a>는 Spring 4.2 부터 사용 가능합니다. <strong>비동기 요청 처리의 결과로 하나 이상의 응답을 위해 사용되는 리턴 값 Type 입니다.</strong> DeferredResult가 하나의 결과를 생성해 요청을 처리했다면, ResponseBodyEmitter는 여러개의 결과를 만들어 요청을 처리할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/emitter"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ResponseBodyEmitter <span class="title">emitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ResponseBodyEmitter emitter = <span class="keyword">new</span> ResponseBodyEmitter();</span><br><span class="line"></span><br><span class="line">            Executors.newSingleThreadExecutor().submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">                        emitter.send(<span class="string">"&lt;p&gt;Stream "</span> + i + <span class="string">"&lt;/p&gt;"</span>);</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> emitter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/post/2019-03-31/emitter_1.png" alt="ResponseBodyEmitter 결과_1"><br><img src="/images/post/2019-03-31/emitter_2.png" alt="ResponseBodyEmitter 결과_2"></p><h1 id="후기"><a href="#후기" class="headerlink" title="후기"></a>후기</h1><p><strong><a href="http://woowabros.github.io/experience/2019/03/05/2019DR.html" target="_blank" rel="noopener">우하한형제들 - 스프링 리액티브 프로그래밍</a> 세미나를 다녀온 후 <a href="https://www.youtube.com/watch?v=8fenTR3KOJo&amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC&amp;index=10" target="_blank" rel="noopener">토비의 봄 TV 스프링 리액티브 프로그래밍 시리즈</a>를 전부 보고있습니다.</strong></p><p>토비님은 매 라이브 코딩마다 말씀하시길 단순히 코드를 보는 것과 실행 후 결과를 실제로 확인해보는 것은 또 다른 차이가 있을 수 있다고 말씀하십니다. 매우 공감합니다!</p><p>위의 내용들은 모두 라이브 코딩에 포함되어 있는 내용이지만 실제로 따라해보면서 해당 내용들을 정리하는 차원으로 작성해보았습니다. 따라하며 토비님이 라이브 코딩을 진행하셨을 때와 달라진 몇 가지를 수정한 부분도 있고, 서버의 스레드를 직접 확인해보고자 처음에는 VisualVM을 사용하려 했지만 계속 실패해 JMC을 이용해 진행했습니다.</p><p>라이브 코딩을 보며 자바와 스프링의 비동기 기술에 대해 개인적으로 궁금했던 부분들이 많이 해소되었습니다!! 앞으로 남은 내용들도 따라하며 정리해 보도록 하겠습니다.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;해당 포스팅은 토비님의 &lt;strong&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=aSTuQiPB4Ns&amp;amp;index=7&amp;amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC&quot; target
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="Java" scheme="https://jongmin92.github.io/tags/Java/"/>
    
      <category term="Async" scheme="https://jongmin92.github.io/tags/Async/"/>
    
      <category term="DeferredResult" scheme="https://jongmin92.github.io/tags/DeferredResult/"/>
    
      <category term="ExecutorService" scheme="https://jongmin92.github.io/tags/ExecutorService/"/>
    
      <category term="Future" scheme="https://jongmin92.github.io/tags/Future/"/>
    
      <category term="FutureTask" scheme="https://jongmin92.github.io/tags/FutureTask/"/>
    
      <category term="ListenableFuture" scheme="https://jongmin92.github.io/tags/ListenableFuture/"/>
    
      <category term="ResponseBodyEmitter" scheme="https://jongmin92.github.io/tags/ResponseBodyEmitter/"/>
    
  </entry>
  
  <entry>
    <title>[번역] Java Reactor Pattern</title>
    <link href="https://jongmin92.github.io/2019/03/05/Java/java-reactor-pattern/"/>
    <id>https://jongmin92.github.io/2019/03/05/Java/java-reactor-pattern/</id>
    <published>2019-03-05T14:00:00.000Z</published>
    <updated>2019-03-09T15:43:30.030Z</updated>
    
    <content type="html"><![CDATA[<p>해당 글은 아래의 Reactor Pattern Explained 시리즈를 번역하였습니다.</p><ul><li><a href="http://jeewanthad.blogspot.com/2013/02/reactor-pattern-explained-part-1.html" target="_blank" rel="noopener">Reactor Pattern Explained - Part 1</a></li><li><a href="http://jeewanthad.blogspot.com/2013/02/reactor-pattern-explained-part-2.html" target="_blank" rel="noopener">Reactor Pattern Explained - Part 2</a></li><li><a href="http://jeewanthad.blogspot.com/2013/03/reacter-pattern-explained-part-3.html" target="_blank" rel="noopener">Reactor Pattern Explained - Part 3</a></li></ul><h1 id="part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h1><p>서버가 동시에 요청(이벤트)을 받을 때, 보통 요청을 처리하기 위한 이벤트 리스너를 각 스레드마다 할당해 처리하곤 합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket ss = <span class="keyword">new</span> ServerSocket(PORT);</span><br><span class="line">        <span class="keyword">while</span> (!Thread.interrupted())</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Handler(ss.accept())).start();</span><br><span class="line">            <span class="comment">// or, single-threaded, or a thread pool</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Socket socket;</span><br><span class="line">    Handler(Socket s) &#123; socket = s; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] input = <span class="keyword">new</span> <span class="keyword">byte</span>[MAX_INPUT];</span><br><span class="line">            socket.getInputStream().read(input);</span><br><span class="line">            <span class="keyword">byte</span>[] output = process(input);</span><br><span class="line">            socket.getOutputStream().write(output);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] process(<span class="keyword">byte</span>[] cmd) &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>요청마다 처리를 위해 이벤트 리스너를 별도의 스레드로 만들어 사용하는 것의 단점은 <code>컨텍스트 전환(context switching)의 오버 헤드</code>가 크다는 것입니다. 최악의 경우, 데이터를 자주 읽거나 쓰지 않는 이벤트 리스너를 처리하는 일부 스레드는 유용한 작업을 하지 않고 주기적으로 컨텍스트를 전환할 것입니다. 스케줄러가 이러한 스레드를 CPU에 디스패치(dispatch) 할 때마다 I/O 이벤트가 발생할 때까지 스레드는 차단되어 I/O 이벤트를 기다리는 데 소비되는 모든 시간이 낭비됩니다.</p><p>위의 코드에서 <code>ss.accept()</code>는 클라이언트가 연결될 때까지 서버 스레드를 차단하는 블로킹 호출입니다. 서버 스레드는 <code>ss.accept()</code> 호출이 반환 될 때까지 이벤트 리스너를 위한 새로운 스레드의 <code>start()</code> 메서드를 호출 할 수 없습니다. 불필요한 컨텍스트 전환으로 인한 CPU 시간 낭비를 줄이기 위해 non-blocking I/O 개념이 탄생했습니다.</p><p><strong><code>Reactor Pattern</code></strong>은 이 문제를 해결하기 위한 <strong>이벤트 처리(event handling) 디자인 패턴</strong>입니다. 하나의 Reactor가 계속 이벤트를 찾고 이벤트가 발생(trigger)하면 해당 이벤트 처리기(event handler)에게 이를 알립니다.</p><p>자바는 non-blocking 시스템을 설계하는 데 사용할 수 있는 <strong>표준 API (java.nio)</strong>를 제공합니다. 클라이언트가 서버로 이름(데이터)을 보내면 서버는 Hello 메시지로 응답하는 간단한 예제를 통해 Reactor 패턴에 대해서 알아보겠습니다.</p><p>Reactor 패턴의 아키텍처에는 두 가지 중요한 참여자가 있습니다.</p><ol><li><strong><code>Reactor</code></strong><br>: Reactor는 별도의 스레드에서 실행되며 발생한 I/O 이벤트는 dispatching되어 해당 이벤트 처리기로 보내 처리합니다.</li><li><strong><code>Handlers</code></strong><br>: Handler는 Reactor로부터 I/O 이벤트를 받아 실제 작업을 수행합니다.</li></ol><p>java.nio 패키지를 이용해서 Reactor 패턴을 구현할 것이기 때문에 nio 패키지에 속한 몇가지 class에 대한 이해가 필요합니다.</p><ul><li><strong><code>Channels</code></strong><br>: 소켓을 통해 non-blocking read를 할 수 있도록 지원하는 connection.</li><li><strong><code>Buffers</code></strong><br>: 채널에 의해 직접 read되거나 write될 수 있는 배열과 같은 객체.</li><li><strong><code>Selectors</code></strong><br>: Selector 는 어느 channel set 이 IO event 를 가지고 있는지를 알려준다. Selector.select() 는 I/O 이벤트가 발생한 채널 set을 return한다. return할 channel이 없다면 계속 기다리게(block) 된다. 이 block된 것을 바로 return 시켜주는 것이 Selector.wakeup()이다.<br>Selector.selectedKeys()는 Selection Key 를 return 해 준다. Reactor는 이 Selection Key를 보고 어떤 handler로 넘겨줄 지를 결정한다.</li><li><strong><code>Selection Keys</code></strong><br>: Selector와 Channel간의 관계를 표현해주는 객체이다. Selector가 제공한 Selection Key를 이용해 Reactor는 채널에서 발생하는 I/O 이벤트로 수행할 작업을 선택할 수 있다. ServerSocketChannel에 selector를 등록하면 key를 준다. 이 key가 SelectionKey 이다.</li></ul><p><img src="/images/post/2019-03-05/reactor_pattern_1.png" alt="Reactor pattern"></p><p><strong>Selector는 계속해서 I/O 이벤트가 발생하기를 대기합니다. Reactor가 Selector.select() 메소드를 호출하면 Selector는 등록된 채널에 대해서 발생한 이벤트 정보가 들어있는 SelectionKey Set을 반환합니다.</strong> (SelectionKey는 해당 채널과 Selector와의 관계에 대한 모든 정보를 갖고 있습니다. 또한 Handler에 대한 정보도 갖고 있습니다.)</p><p>Selector에 등록된 하나의 ServerSocketChannel이 있습니다. ServerSocketChannel은 클라이언트에서 들어오는 연결 요청으로부터 이벤트를 수신해야합니다. 클라이언트가 연결을 요청할 때, ServerSocketChhannel은 I/O 이벤트를 받아 클라이언트에 SocketChannel을 할당해야 합니다. SelectionKey0은 ServerSocketChannel을 가지고 무엇을 해야하는지에 대한 이벤트 정보를 갖고 있습니다. SocketChhannel을 만들기 위해서는 Reactor가 SelectionKey0의 이벤트를 Acceptor에 전달해 Acceptor가 클라이언트와의 연결 요청을 수락하고 SocketChannel을 만들도록 해야합니다.</p><p>Acceptor가 클라이언트1의 연결을 수락하면 클라이언트1에 대한 SocketChannel이 생성됩니다. 이 SocketChannel역시 Selector에 등록되고 해당 채널에서 이벤트가 발생하면 해당 이벤트에 대한 정보를 포함한 SelectionKey1을 반환합니다. 이 SelectionKey1을 이용해서 해당 채널로부터 데이터를 읽고 쓸 수 있습니다. 따라서 SelectionKey1은 읽기와 쓰기를 처리하는 Handler1 객체에 바인딩 됩니다.</p><p>이후로 Reactor가 Selector.selector()를 호출했을 때 반환된 SelectionKey Set에 SelectionKey1이 있으면 SocketChannel1이 이벤트와 함께 트리거됨을 의미합니다. 이제 SelectionKey1을 보면, Reactor는 Handler1이 SelectionKey1에 바인딩되어 있으므로 Handler1에 이벤트를 전달해야한다는 것을 알고 있습니다. 반환 된 SelectionKey Set에 SelectionKey0이 있으면 ServerSocketChannel이 다른 클라이언트에서 이벤트를 수신했으며 SelectionKey0을 보고 Reactor는 해당 이벤트를 다시 Acceptor에 전달해야 함을 알고 있습니다. 이벤트가 Acceptor에 전달되면 클라이언트2에 대해 SocketChannel2를 만들고 SelectionKey2로 Selector로 SocketChannel2를 등록합니다.</p><p><img src="/images/post/2019-03-05/selection_key_table.png" alt="Selection Key table"></p><p>따라서 이 시나리오에서는 3가지 유형의 이벤트에 관심이 있습니다.</p><ol><li>accept 해야하는 ServerSocketChannel에서 트리거되는 연결 요청 이벤트.</li><li>클라이언트로 부터 송신된 데이터를 수신할 수 있을 때, SocketChannel로부터 트리거 되는 이벤트.</li><li>서버에서 클라이언트로 데이터를 송신할 때, 송신할 수 있는 준비가 되면 SocketChannel로부터 트리거 되는 이벤트.</li></ol><p>그럼 스레드 풀은 이 작업과 어떤 관련이 있을까요? non-blocking 아키텍처의 장점은 클라이언트의 모든 요청을 처리하는 동시에 단일 스레드에서 실행되도록 서버를 작성할 수 있다는 것입니다. 서버를 설계하는 데 동시성 개념을 적용하지 않으면 이벤트에 대한 반응성이 떨어집니다. 단일 스레드일 때는 reactor가 이벤트를 handler에 전달해 처리될 때 까지는 다른 이벤트에 응답할 수 없기 때문입니다. 왜냐하면 하나의 스레드를 사용하여 모든 이벤트를 처리하기 때문입니다.</p><p>위의 아키텍처에 동시성을 추가해서 시스템의 응답 속도를 향상시킬 수 있습니다. <strong>Reactor가 이벤트를 Handler에 전달하고 새로운 Thread에서 Handler를 이용해 이벤트를 처리하면 Reacgtor는 계속해서 다른 이벤트에 응답할 수 있습니다.</strong> 또한 스레드 풀을 이용하면 시스템의 스레드 수를 제한하면서 더 효율적으로 사용할 수 있을 것 입니다.</p><h1 id="part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h1><p>간단한 Reactor 패턴의 예시를 살펴보겠습니다. 클라이언트는 서버로 이름을 넣은 메시지를 전송하고 서버는 클라이언트에 Hello 메시지로 응답합니다. 스레드 풀은 Part3에서 살펴보겠습니다.</p><p>클라이언트는 java.nio를 사용하여 Socket을 생성하지 않고 java.net.Socket을 사용합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    String hostIp;</span><br><span class="line">    <span class="keyword">int</span> hostPort;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">(String hostIp, <span class="keyword">int</span> hostPort)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hostIp = hostIp;</span><br><span class="line">        <span class="keyword">this</span>.hostPort = hostPort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Socket clientSocket = <span class="keyword">null</span>;</span><br><span class="line">        PrintWriter out = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader in = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clientSocket = <span class="keyword">new</span> Socket(hostIp, hostPort);</span><br><span class="line">            out = <span class="keyword">new</span> PrintWriter(clientSocket.getOutputStream(), <span class="keyword">true</span>);</span><br><span class="line">            in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(clientSocket.getInputStream()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Unknown host: "</span> + hostIp);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Couldn't connect to: "</span> + hostIp);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BufferedReader stdIn = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">        String userInput;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Client connected to host : "</span> + hostIp + <span class="string">" port: "</span> + hostPort);</span><br><span class="line">        System.out.println(<span class="string">"Type (\"Bye\" to quit)"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Tell what your name is to the Server....."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((userInput = stdIn.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            out.println(userInput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Break when client says Bye.</span></span><br><span class="line">            <span class="keyword">if</span> (userInput.equalsIgnoreCase(<span class="string">"Bye"</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"Server says: "</span> + in.readLine());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.close();</span><br><span class="line">        in.close();</span><br><span class="line">        stdIn.close();</span><br><span class="line">        clientSocket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Client client = <span class="keyword">new</span> Client(<span class="string">"127.0.0.1"</span>, <span class="number">9900</span>);</span><br><span class="line">        client.runClient();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>서버는 Reactor 패턴을 이용해 구현합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reactor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Selector selector;</span><br><span class="line">    <span class="keyword">final</span> ServerSocketChannel serverSocketChannel;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isWithThreadPool;</span><br><span class="line"></span><br><span class="line">    Reactor(<span class="keyword">int</span> port, <span class="keyword">boolean</span> isWithThreadPool) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.isWithThreadPool = isWithThreadPool;</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">        serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">        serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        SelectionKey selectionKey0 = serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        selectionKey0.attach(<span class="keyword">new</span> Acceptor());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Server listening to port: "</span> + serverSocketChannel.socket().getLocalPort());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!Thread.interrupted()) &#123;</span><br><span class="line">                selector.select();</span><br><span class="line">                Set selected = selector.selectedKeys();</span><br><span class="line">                Iterator it = selected.iterator();</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    dispatch((SelectionKey) (it.next()));</span><br><span class="line">                &#125;</span><br><span class="line">                selected.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(SelectionKey k)</span> </span>&#123;</span><br><span class="line">        Runnable r = (Runnable) (k.attachment());</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line">                <span class="keyword">if</span> (socketChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isWithThreadPool)</span><br><span class="line">                        <span class="keyword">new</span> HandlerWithThreadPool(selector, socketChannel);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">new</span> Handler(selector, socketChannel);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Connection Accepted by Reactor"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Reactor는 Runnable을 구현하고 있으며, run() 메서드에서는 while 루프를 돌며 selector.select()를 호출하여 처리할 수 있는 이벤트 정보가 담긴 SelectionKey Set을 가져옵니다. SelectionKey에 바인드 되어있는 Handler를 가져와 dispatch합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SocketChannel socketChannel;</span><br><span class="line">    <span class="keyword">final</span> SelectionKey selectionKey;</span><br><span class="line">    ByteBuffer input = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READING = <span class="number">0</span>, SENDING = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> state = READING;</span><br><span class="line">    String clientName = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    Handler(Selector selector, SocketChannel c) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        socketChannel = c;</span><br><span class="line">        c.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        selectionKey = socketChannel.register(selector, <span class="number">0</span>);</span><br><span class="line">        selectionKey.attach(<span class="keyword">this</span>);</span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">        selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (state == READING) &#123;</span><br><span class="line">                read();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SENDING) &#123;</span><br><span class="line">                send();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readCount = socketChannel.read(input);</span><br><span class="line">        <span class="keyword">if</span> (readCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            readProcess(readCount);</span><br><span class="line">        &#125;</span><br><span class="line">        state = SENDING;</span><br><span class="line">        <span class="comment">// Interested in writing</span></span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Processing of the read message. This only prints the message to stdOut.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> readCount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">readProcess</span><span class="params">(<span class="keyword">int</span> readCount)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        input.flip();</span><br><span class="line">        <span class="keyword">byte</span>[] subStringBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readCount];</span><br><span class="line">        <span class="keyword">byte</span>[] array = input.array();</span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, subStringBytes, <span class="number">0</span>, readCount);</span><br><span class="line">        <span class="comment">// Assuming ASCII (bad assumption but simplifies the example)</span></span><br><span class="line">        sb.append(<span class="keyword">new</span> String(subStringBytes));</span><br><span class="line">        input.clear();</span><br><span class="line">        clientName = sb.toString().trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Saying hello to "</span> + clientName);</span><br><span class="line">        ByteBuffer output = ByteBuffer.wrap((<span class="string">"Hello "</span> + clientName + <span class="string">"\n"</span>).getBytes());</span><br><span class="line">        socketChannel.write(output);</span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">        state = READING;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Handler에는 READING, SENDING 2가지 상태가 있습니다. 채널은 한 번에 하나의 작업만 지원하기 때문에 동시에 처리할 수 없습니다. Handler가 SelectionKey에 어떻게 attach 되는지와 관심있는 연산이 OP_READ로 설정되는 부분에 유의해야합니다. Selector는 Read 이벤트가 발생할 때만 SelectionKey를 select해야 합니다. READ 프로세스가 완료되면 Handler는 상태를 SENDING으로 변경하고 관심 대상 연산을 OP_WRITE로 변경합니다. 이제 Selector는 채널이 데이터를 전송할 준비가 되었을 때 SelectionKey를 select 합니다. Write 이벤트가 Handler에 dispatch될 때, 상태가 SENDING이므로 Hello 메시지를 출력 버퍼에 씁니다. 전송이 완료되면 관심있는 작업을 OP_READ로 다시 변경하면서 Handler의 상태가 READING으로 변경됩니다.</p><p>결과적으로 서버는 단일 스레드에서 실행되지만 서버에 연결하는 클라이언트 수에 상관없이 응답합니다.</p><h1 id="part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a>Part 3</h1><p>이번 파트에서는 Handler의 스레드 풀에 대해서 설명합니다. HandlerWithThreadPool은 Handler 클래스의 확장 버전입니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerWithThreadPool</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ExecutorService pool = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESSING = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerWithThreadPool</span><span class="params">(Selector sel, SocketChannel c)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(sel, c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readCount = socketChannel.read(input);</span><br><span class="line">        <span class="keyword">if</span> (readCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            state = PROCESSING;</span><br><span class="line">            pool.execute(<span class="keyword">new</span> Processer(readCount));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We are interested in writing back to the client soon after read processing is done.</span></span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start processing in a new Processer Thread and Hand off to the reactor thread.</span></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">processAndHandOff</span><span class="params">(<span class="keyword">int</span> readCount)</span> </span>&#123;</span><br><span class="line">        readProcess(readCount);</span><br><span class="line">        <span class="comment">// Read processing done. Now the server is ready to send a message to the client.</span></span><br><span class="line">        state = SENDING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Processer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readCount;</span><br><span class="line">        Processer(<span class="keyword">int</span> readCount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.readCount =  readCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            processAndHandOff(readCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PROCESSING이 새로 도입되었으며 read() 메서드가 override 되었습니다. 이제 Read 이벤트가 Handler에 dispatch되면 데이터를 읽지만 상태를 SENDING으로 변경하지는 않습니다. 메시지를 처리하고 스레드 풀의 다른 스레드에서 실행하고 관련 작업을 OP_WRITE로 설정하는 Processer를 생성합니다. 이 시점에서 채널에 Write 준비가 되어 있더라도 Handler는 아직 PROCESSING 상태이기 때문에 write하지 않습니다.</p><h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><p><a href="http://i5on9i.blogspot.com/2013/11/reactor-pattern.html" target="_blank" rel="noopener">Reactor Pattern 에 대해 알아보자</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;해당 글은 아래의 Reactor Pattern Explained 시리즈를 번역하였습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://jeewanthad.blogspot.com/2013/02/reactor-pattern-explained-
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="nio" scheme="https://jongmin92.github.io/tags/nio/"/>
    
      <category term="select" scheme="https://jongmin92.github.io/tags/select/"/>
    
      <category term="multiplexing" scheme="https://jongmin92.github.io/tags/multiplexing/"/>
    
      <category term="non-blocking io" scheme="https://jongmin92.github.io/tags/non-blocking-io/"/>
    
      <category term="reactor" scheme="https://jongmin92.github.io/tags/reactor/"/>
    
  </entry>
  
  <entry>
    <title>Java NIO와 멀티플렉싱 기반의 다중 접속 서버</title>
    <link href="https://jongmin92.github.io/2019/03/03/Java/java-nio/"/>
    <id>https://jongmin92.github.io/2019/03/03/Java/java-nio/</id>
    <published>2019-03-03T04:00:00.000Z</published>
    <updated>2019-03-09T04:50:29.892Z</updated>
    
    <content type="html"><![CDATA[<p>자바 NIO에 대한 소개와 NIO와 함께 도입된 자바에서 I/O 멀티플렉싱(multiplexing)을 구현한 selector에 대해 알아봅니다. I/O 멀티플렉싱(multiplexing)에 대한 개념에 대해 아직 잘 이해하지 못하고 있다면 먼저 <a href="https://jongmin92.github.io/2019/02/28/Java/java-with-non-blocking-io/"><strong>&lt;멀티플렉싱 기반의 다중 접속 서버로 가기까지&gt;</strong></a> 포스팅을 읽어주세요.</p><h1 id="overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p><strong>자바 NIO (New IO)는 기존의 자바 IO API를 대체하기 위해 자바 1.4부터 도입이 되었습니다.</strong> 새롭게 변화된 부분에 대해서 간략히 요약해보면 다음과 같습니다. </p><ul><li><strong><code>Channels and Buffers</code></strong><br>기존 IO API에서는 byte streams character streams 사용했지만, NIO에서는 channels(채널)과 buffers(버퍼)를 사용합니다. 데이터는 항상 채널에서 버퍼로 읽히거나 버퍼에서 채널로 쓰여집니다.</li><li><strong><code>Non-blocking IO</code></strong><br>자바 NIO에서는 non-blocking IO를 사용할 수 있습니다. 예를 들면, 하나의 스레드는 버퍼에 데이터를 읽도록 채널에 요청할 수 있습니다. 채널이 버퍼로 데이터를 읽는 동안 스레드는 다른 작업을 수행할 수 있습니다. 데이터가 채널에서 버퍼로 읽어지면, 스레드는 해당 버퍼를 이용한 processing(처리)를 계속 할 수 있습니다. 데이터를 채널에 쓰는 경우도 non-blocking이 가능합니다.</li><li><strong><code>Selectors</code></strong><br>자바 NIO에는 “selectors” 개념을 포함하고 있습니다. selector는 여러개의 채널에서 이벤트(연결이 생성됨, 데이터가 도착함)를 모니터링할 수 있는 객체입니다. 그래서 하나의 스레드에서 여러 채널에 대해 모니터링이 가능합니다.</li></ul><p>자바 NIO는 다음과 같은 핵심 컴포넌트로 구성되어있습니다.</p><ul><li><strong>Channels</strong></li><li><strong>Buffers</strong></li><li><strong>Selectors</strong></li></ul><p>실제로는 더 많은 클래스와 컴포넌트가 있지만 채널, 버퍼, 셀렉터가 API의 핵심을 구성합니다.</p><h1 id="channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h1><p><strong>일반적으로 NIO의 모든 IO는 채널로 시작합니다. 채널 데이터를 버퍼로 읽을 수 있고, 버퍼에서 채널로 데이터를 쓸 수 있습니다.</strong><br><img src="/images/post/2019-03-03/channel_buffer.png" alt="channel and buffer"></p><p>채널은 스트림(stream)과 유사하지만 몇가지 차이점이 있습니다.</p><ul><li>채널을 통해서는 읽고 쓸 수 있지만, 스트림은 일반적으로 단방향(읽기 혹은 쓰기)으로만 가능합니다.</li><li>채널은 비동기적(asynchronously)으로 읽고 쓸 수 있습니다.</li><li>채널은 항상 버퍼에서 부터 읽거나 버퍼로 씁니다.</li></ul><p>채널에는 여러가지 타입이 있습니다. 다음은 자바 NIO에 기본적으로 구현되어 있는 목록입니다.</p><ul><li>Channels<ul><li>FileChannel<br>: 파일에 데이터를 읽고 쓴다.</li><li>DatagramChannel<br>: UDP를 이용해 네트워크를 통해 데이터를 읽고 쓴다.</li><li><strong>SocketChannel</strong><br>: TCP를 이용해 네트워크를 통해 데이터를 읽고 쓴다.</li><li><strong>ServerSocketChannel</strong><br>: 들어오는 TCP 연결을 수신(listening)할 수 있다. 들어오는 연결마다 SocketChannel이 만들어진다.</li></ul></li></ul><h1 id="buffers"><a href="#Buffers" class="headerlink" title="Buffers"></a>Buffers</h1><p><strong>NIO의 버퍼는 채널과 상호작용할 때 사용됩니다. 데이터는 채널에서 버퍼로 읽혀지거나, 버퍼에서 읽혀 채널로 쓰여집니다.</strong></p><p>버퍼에는 여러가지 타입이 있습니다. 다음은 자바 NIO에 기본적으로 구현되어 있는 목록입니다.</p><ul><li>Buffers<ul><li>ByteBuffer</li><li>MappedByteBuffer</li><li>CharBuffer</li><li>ShortBuffer</li><li>IntBuffer</li><li>LongBuffer</li><li>FloatBuffer</li><li>DoubleBuffer</li></ul></li></ul><p>일반적으로 버퍼를 사용하여 데이터를 읽고 쓰는 것은 4단계 프로세스를 가집니다.</p><ol><li>버퍼에 데이터 쓰기</li><li>buffer.flip() 호출</li><li>버퍼에서 데이터 읽기</li><li>buffer.clear() 혹은 buffer.compact() 호출</li></ol><p>버퍼에 데이터를 쓸 때 버퍼는 쓰여진 데이터의 양을 기록합니다. 만약 데이터를 읽어야한다면 flip() 메서드를 호출해서 버퍼를 쓰기 모드에서 읽기 모드로 전환해야 합니다. 읽기 모드에서 버퍼를 사용하면 버퍼에 쓰여진 모든 데이터를 읽을 수 있습니다.<br>모든 데이터를 읽은 후에는 버퍼를 지우고 다시 쓸 준비를 해야합니다. clear() 혹은 compact()를 호출함으로써 전체 버퍼를 지울 수 있습니다. (clear() 메서드는 버퍼 전체를 지우고, compact() 메서드는 이미 읽은 데이터만 지웁니다.)</p><h1 id="selectors"><a href="#Selectors" class="headerlink" title="Selectors"></a>Selectors</h1><p><strong>셀렉터를 사용하면 하나의 스레드가 여러 채널을 처리(handle)할 수 있습니다.</strong><br><img src="/images/post/2019-03-03/selector.png" alt="selector"><br>셀렉터는 사용을 위해 하나 이상의 채널을 셀렉터에 등록하고 <strong>select()</strong> 메서드를 호출해 등록 된 채널 중 이벤트 준비가 완료된 하나 이상의 채널이 생길 때까지 봉쇄(block)됩니다. 메서드가 반환(return)되면 스레드는 채널에 준비 완료된 이벤트를 처리할 수 있습니다. 즉, 하나의 스레드에서 여러 채널을 관리할 수 있으므로 여러 네트워크 연결을 관리할 수 있습니다. (SocketChannel, ServerSocketChannel)</p><h2 id="selector-생성"><a href="#Selector-생성" class="headerlink" title="Selector 생성"></a>Selector 생성</h2><p><strong><code>Selector.open()</code> 메서드를 통해 셀렉터를 생성할 수 있습니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Selector selector = Selector.open();</span><br></pre></td></tr></table></figure></p><h2 id="channels-등록"><a href="#Channels-등록" class="headerlink" title="Channels 등록"></a>Channels 등록</h2><p><strong>생성한 셀렉터에 채널을 등록하기 위해서는 다음과 같이 채널의 <code>register()</code> 메서드를 호출합니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">channel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">SelectionKey key = channel.register(selector, SelectionKey.OP_READ);</span><br></pre></td></tr></table></figure></p><p>셀렉터에 채널을 등록하기 위해서는 반드시 해당 채널이 non-blocking 모드로 변환되어야 합니다. (FileChannel은 non-blocking 모드로 변경이 불가능하기 때문에 셀렉터에 등록이 불가능합니다.)</p><p><strong>register() 메서드의 두 번째 매개 변수는 셀렉터를 통해 채널에서 발생하는 이벤트 중 확인(알림)하고자 하는 이벤트의 집합을 의미합니다.<br>이벤트에는 4가지 종류가 있으며, 이 4가지 이벤트는 <code>SelectionKey</code> 상수로 표시됩니다.</strong></p><ul><li>SelectionKey.OP_CONNECT</li><li>SelectionKey.OP_ACCEPT</li><li>SelectionKey.OP_READ</li><li>SelectionKey.OP_WRITE</li></ul><p>둘 이상의 이벤트 상수는 다음과 같이 사용 가능합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interestSet = SelectionKey.OP_READ | SelectionKey.OP_WRITE</span><br></pre></td></tr></table></figure></p><h2 id="selectionkey"><a href="#SelectionKey" class="headerlink" title="SelectionKey"></a>SelectionKey</h2><p>register() 메서드를 이용해 채널을 셀렉터에 등록하면 SelectionKey 객체가 반환됩니다. 이 SelectionKey 객체에는 몇 가지 속성들이 있습니다.</p><ul><li>The interest set</li><li>The ready set</li><li>The Channel</li><li>The Selector</li><li>An attached object (optional)</li></ul><h3 id="interest-set"><a href="#interest-Set" class="headerlink" title="interest Set"></a>interest Set</h3><p>interest set은 셀렉터에 등록된 채널이 확인하고자 하는 이벤트 집합(세트)입니다. 다음과 같이 SelectionKey를 이용해 해당 interest set을 확인할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interestSet = selectionKey.interestOps();</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> isInterestedInAccept  = interestSet &amp; SelectionKey.OP_ACCEPT;</span><br><span class="line"><span class="keyword">boolean</span> isInterestedInConnect = interestSet &amp; SelectionKey.OP_CONNECT;</span><br><span class="line"><span class="keyword">boolean</span> isInterestedInRead    = interestSet &amp; SelectionKey.OP_READ;</span><br><span class="line"><span class="keyword">boolean</span> isInterestedInWrite   = interestSet &amp; SelectionKey.OP_WRITE;</span><br></pre></td></tr></table></figure></p><h3 id="ready-set"><a href="#Ready-Set" class="headerlink" title="Ready Set"></a>Ready Set</h3><p>ready set은 셀렉터에 등록된 채널에서 준비되어 처리(handle) 가능한 이벤트의 집합입니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> readySet = SelectionKey.readyOps();</span><br></pre></td></tr></table></figure></p><p>위와 같이 interest Set과 동일한 방식으로 확인할 수도 있지만 아래와 같이 4가지 메소드를 이용해서 확인할 수도 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">selectionKey.isAcceptable();</span><br><span class="line">selectionKey.isConnectable();</span><br><span class="line">selectionKey.isReadable();</span><br><span class="line">selectionKey.isWritable();</span><br></pre></td></tr></table></figure></p><h3 id="channel-selector"><a href="#Channel-Selector" class="headerlink" title="Channel + Selector"></a>Channel + Selector</h3><p>SelectionKey를 이용해 채널과 셀렉터에 쉽게 접근할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Channel  channel  = selectionKey.channel();</span><br><span class="line"></span><br><span class="line">Selector selector = selectionKey.selector();</span><br></pre></td></tr></table></figure></p><h3 id="attaching-objects"><a href="#Attaching-Objects" class="headerlink" title="Attaching Objects"></a>Attaching Objects</h3><p>SelectionKey에 객체를 첨부(attach)할 수 있습니다. 이 방법을 이용하면 채널에 추가 정보나 채널에서 사용하는 버퍼와 같은 객체들을 쉽게 첨부할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selectionKey.attach(theObject);</span><br><span class="line"></span><br><span class="line">Object attachedObj = selectionKey.attachment();</span><br></pre></td></tr></table></figure></p><p>selectionKey를 통해 직접 attach 하는 것 뿐만 아니라 셀렉터에 채널을 등록하면서 객체를 첨부할 수도 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SelectionKey key = channel.register(selector, SelectionKey.OP_READ, theObject);</span><br></pre></td></tr></table></figure></p><h2 id="셀렉터를-이용해-채널-선택"><a href="#셀렉터를-이용해-채널-선택" class="headerlink" title="셀렉터를 이용해 채널 선택"></a>셀렉터를 이용해 채널 선택</h2><p><strong>셀렉터에 하나 이상의 채널을 등록한 후에는 <code>select()</code> 메소드를 호출할 수 있습니다. select() 메소드는 accept, connect, read, write 이벤트에 대해 준비(ready) 되어 있는 채널을 반환합니다.</strong> select() 메소드는 다음과 같이 3가지 방식으로 사용 가능합니다.</p><ul><li><strong>select()</strong><br>: 등록한 이벤트에 대해 하나 이상의 채널이 준비 될 때까지 봉쇄(block)됩니다. 몇개의 채널이 준비되었는지 준비된 채널의 수를 반환합니다. (마지막으로 select()를 호출한 이후 준비된 채널 수 입니다.)</li><li><strong>select(long timeout)</strong><br>: 최대 timeout(ms) 동안만 봉쇄한다는 점을 제외하면 select()와 동일합니다.</li><li><strong>selectNow()</strong><br>: select와 달리 봉쇄하지 않습니다. 준비된 채널이 있으면 즉시 반환됩니다.</li></ul><h3 id="selectedkeys"><a href="#selectedKeys" class="headerlink" title="selectedKeys()"></a>selectedKeys()</h3><p><strong>select() 메서드를 통해 하나 이상의 준비된 채널이 발생하면, <code>selectedKeys()</code> 메서드를 사용해 준비된 채널의 집합을 반환 받습니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br></pre></td></tr></table></figure></p><p>반환된 SelectionKey set을 반복해 준비된 채널에 접근할 수 있습니다. 채널의 이벤트 처리가 끝나면 keyIterator.remove()를 통해 키 세트에서 제거해야 합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(keyIterator.hasNext()) &#123;</span><br><span class="line">    </span><br><span class="line">    SelectionKey key = keyIterator.next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(key.isAcceptable()) &#123;</span><br><span class="line">        <span class="comment">// a connection was accepted by a ServerSocketChannel.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">        <span class="comment">// a connection was established with a remote server.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">        <span class="comment">// a channel is ready for reading</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">        <span class="comment">// a channel is ready for writing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    keyIterator.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="serversocketchannel"><a href="#ServerSocketChannel" class="headerlink" title="ServerSocketChannel"></a>ServerSocketChannel</h1><p><strong>NIO ServerSocketChannel은 표준 자바 네트워킹의 ServerSocket과 마찬가지로 들어오는 TCP 연결을 수신 대기 할 수 있는 채널입니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9999</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">    SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do something with socketChannel...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="non-blocking-mode"><a href="#Non-blocking-Mode" class="headerlink" title="Non-blocking Mode"></a>Non-blocking Mode</h2><p><strong>ServerSocketChannel은 non-blocking 모드로 설정이 가능합니다.</strong> non-blocking 모드에서는 accept() 메서드가 즉시 반환되므로 들어오는 연결이 없으면 null을 반환할 수 있습니다. 이에 따라 반환 된 ServerSocketChannel이 null인지 확인해야합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9999</span>));</span><br><span class="line">serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">    SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (socketChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// do something with socketChannel...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="socketchannel"><a href="#SocketChannel" class="headerlink" title="SocketChannel"></a>SocketChannel</h1><p><strong>NIO SocketChannel은 TCP 네트워크 소켓에 연결된 채널입니다. 표준 자바 네트워킹의 Socket과 역할이 같습니다.</strong></p><h2 id="non-blocking-mode"><a href="#Non-blocking-Mode-1" class="headerlink" title="Non-blocking Mode"></a>Non-blocking Mode</h2><p><strong>ServerSocketChannel과 마찬가지로 SocketChannel을 non-blocking 모드로 설정할 수 있습니다.</strong> non-blocking 모드에서는 connect(), read(), write()를 호출할 수 있습니다.</p><h3 id="connect"><a href="#connect" class="headerlink" title="connect()"></a>connect()</h3><p>SocketChannel이 non-blocking 모드일 때, connect()를 호출하면 메서드가 연결이 설정되기 전에 반환될 수 있습니다. 연결이 설정되었는지 확인하기 위해서 finishConnect() 메서드를 이용할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">socketChannel.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"http://naver.com"</span>, <span class="number">80</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!socketChannel.finishConnect()) &#123;</span><br><span class="line">    <span class="comment">// wait, or do something else...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="read"><a href="#read" class="headerlink" title="read()"></a>read()</h3><p>non-blocking 모드일 때, read() 메서드는 데이터를 전혀 읽지 않고 반환 될 수 있습니다. 따라서 반환 된 결과(int)를 갖고 판단해야 합니다. 반환 된 결과(int)는 읽은 바이트 수를 나타냅니다.</p><h1 id="멀티플렉싱-기반의-다중-접속-서버"><a href="#멀티플렉싱-기반의-다중-접속-서버" class="headerlink" title="멀티플렉싱 기반의 다중 접속 서버"></a>멀티플렉싱 기반의 다중 접속 서버</h1><p>지금까지 살펴본 Channel, Buffer, Selector를 이용해 간단한 echo 서버를 만들어 보았습니다.</p><h2 id="echoserverjava"><a href="#EchoServer-java" class="headerlink" title="EchoServer.java"></a>EchoServer.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXIT = <span class="string">"EXIT"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Selector selector = Selector.open();</span><br><span class="line">        ServerSocketChannel serverSocket = ServerSocketChannel.open();</span><br><span class="line">        serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">3000</span>));</span><br><span class="line">        serverSocket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        serverSocket.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = selectedKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">                SelectionKey key = iter.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    register(selector, serverSocket);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    answerWithEcho(buffer, key);</span><br><span class="line">                &#125;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">answerWithEcho</span><span class="params">(ByteBuffer buffer, SelectionKey key)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        SocketChannel client = (SocketChannel) key.channel();</span><br><span class="line">        client.read(buffer);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> String(buffer.array()).trim().equals(EXIT)) &#123;</span><br><span class="line">            client.close();</span><br><span class="line">            System.out.println(<span class="string">"Not accepting client messages anymore"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buffer.flip();</span><br><span class="line">        client.write(buffer);</span><br><span class="line">        buffer.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Selector selector, ServerSocketChannel serverSocket)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        SocketChannel client = serverSocket.accept();</span><br><span class="line">        client.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        System.out.println(<span class="string">"new client connected..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행-결과"><a href="#실행-결과" class="headerlink" title="실행 결과"></a>실행 결과</h2><p><img src="/images/post/2019-03-03/echo_server_with_select.gif" alt="echo_server_with_select"></p><h1 id="java-nio-vs-io"><a href="#Java-NIO-vs-IO" class="headerlink" title="Java NIO vs IO"></a>Java NIO vs IO</h1><h2 id="stream-oriented-vs-buffer-oriented"><a href="#Stream-Oriented-vs-Buffer-Oriented" class="headerlink" title="Stream Oriented vs Buffer Oriented"></a>Stream Oriented vs Buffer Oriented</h2><p><strong>스트림 지향의 IO는 스트림에서 한 번에 하나 이상의 바이트를 읽는 것을 의미합니다.</strong> 읽은 바이트를 이용해 유저가 데이터를 처리해야 하며 읽힌 바이트는 따로 캐시되지 않습니다. 또한 스트림의 데이터는 임의로 유저가 앞뒤로 이동할 수 없습니다. 스트림에서 읽은 데이터를 앞뒤로 이동해야 하는 경우는 먼저 스트림의 데이터를 읽어 버퍼에 캐시해야합니다.</p><p><strong>버퍼 지향의 NIO 방식은 조금 다릅니다. 데이터는 나중에 처리되는 임의의 버퍼로 읽어집니다.</strong> 필요에 따라 버퍼에서 앞뒤로 이동할 수 있습니다. 이로 인해 버퍼를 이용한 처리 과정에서 좀 더 유연한 사용이 가능합니다. 그러나 버퍼를 이용해 완전히 처리하려면 필요한 모든 데이터가 버퍼에 들어있는지 확인해야합니다. 또한 버퍼에 더 많은 데이터를 읽을 때, 아직 처리하지 않은 버퍼의 데이터를 덮어 쓰지 않도록 주의해야합니다.</p><h2 id="blocking-vs-non-blocking-io"><a href="#Blocking-vs-Non-blocking-IO" class="headerlink" title="Blocking vs Non-blocking IO"></a>Blocking vs Non-blocking IO</h2><p><strong>자바 IO의 스트림을 이용하면 봉쇄(block)됩니다.</strong> 즉, 스레드가 read() 혹은 write()를 호출하면 읽은 데이터가 있거나 데이터가 완전히 쓰여질 때까지 해당 스레드가 차단되어 그 동안 스레드는 아무 것도 할 수 없습니다.</p><p><strong>자바 NIO의 Non-blocking 모드는 스레드가 채널에서 데이터 읽기를 요청할 때, 현재 사용할 수 있는 데이터가 없는 경우 사용 가능한 데이터가 준비될 때까지 기다리지 않습니다.</strong> 때문에 해당 스레드는 봉쇄되지 않고 계속 진행될 수 있습니다. 쓰기 작업 또한 마찬가지 입니다. 스레드는 일부 데이터를 채널에 쓰도록 요청할 수 있지만 완전히 쓰여지기를 기다리지는 않습니다.</p><h2 id="selectos"><a href="#Selectos" class="headerlink" title="Selectos"></a>Selectos</h2><p><strong>자바 NIO의 셀렉터는 하나의 스레드에서 다중 입력 채널을 관리할 수 있습니다.</strong> 이 멀티플렉싱 메커니즘을 사용하면 단일 스레드에서 여러 채널의 입출력을 쉽게 관리할 수 있습니다.</p><h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul><li><a href="http://tutorials.jenkov.com/java-nio/index.html" target="_blank" rel="noopener">Java NIO Tutorial</a></li><li><a href="https://www.baeldung.com/java-nio-selector" target="_blank" rel="noopener">Introduction to the Java NIO Selector</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;자바 NIO에 대한 소개와 NIO와 함께 도입된 자바에서 I/O 멀티플렉싱(multiplexing)을 구현한 selector에 대해 알아봅니다. I/O 멀티플렉싱(multiplexing)에 대한 개념에 대해 아직 잘 이해하지 못하고 있다면 먼저 
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="nio" scheme="https://jongmin92.github.io/tags/nio/"/>
    
      <category term="select" scheme="https://jongmin92.github.io/tags/select/"/>
    
      <category term="multiplexing" scheme="https://jongmin92.github.io/tags/multiplexing/"/>
    
  </entry>
  
  <entry>
    <title>멀티플렉싱 기반의 다중 접속 서버로 가기까지</title>
    <link href="https://jongmin92.github.io/2019/02/28/Java/java-with-non-blocking-io/"/>
    <id>https://jongmin92.github.io/2019/02/28/Java/java-with-non-blocking-io/</id>
    <published>2019-02-27T15:33:00.000Z</published>
    <updated>2019-03-09T04:50:29.893Z</updated>
    
    <content type="html"><![CDATA[<h1 id="소켓이란"><a href="#소켓이란" class="headerlink" title="소켓이란?"></a>소켓이란?</h1><p><code>소켓</code>은 네트워크 상에서 서버와 클라이언트 두개의 프로그램이 특정 포트를 통해 양방향 통신이 가능하도록 만들어주는 추상화된 장치입니다. <strong>메모리의 유저 공간에 존재하는 프로세스(서버, 클라이언트)는 커널 공간에 생성된 소켓을 통해 데이터를 송수신할 수 있습니다.</strong><br><img src="/images/post/2019-02-21/socket_1.png" alt="socket"></p><p>소켓은 아래와 같이 지역(로컬) IP 주소, Port 번호와 상대방의 IP 주소와 Port 번호, 그리고 <code>수신 버퍼</code>와 <code>송신 버퍼</code>가 존재합니다. <strong>서버와 클라이언트의 소켓이 서로 연결된 후, 데이터가 들어오면 수신 버퍼로 수신 데이터가 쓰이고, 반대로 데이터를 내 보낼 때는 송신 버퍼에 데이터가 쓰입니다.</strong><br><img src="/images/post/2019-02-21/socket_2.png" alt="socket"></p><h1 id="c언어로-간단한-서버-amp-클라이언트-구현"><a href="#C언어로-간단한-서버-amp-클라이언트-구현" class="headerlink" title="C언어로 간단한 서버 &amp; 클라이언트 구현"></a>C언어로 간단한 서버 &amp; 클라이언트 구현</h1><p>C언어를 이용해 linux와 window에서 간단하게 소켓을 이용해 echo server와 client를 만들어 보겠습니다.<br><strong>코드 한줄 한줄을 전부 해석하기 보다는 주석을 참고해 server와 client에서 어떤 순서로 소켓이 만들어지고 통신이 이루어지는지에 중점을 두어 보겠습니다.</strong></p><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><p><a href="https://en.wikipedia.org/wiki/Everything_is_a_file" target="_blank" rel="noopener">“Everything is a File”</a>라는 말이 있습니다. linux에서는 소켓도 하나의 파일(File), 더 정확히는 <a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank" rel="noopener">파일 디스크립터(File descriptor)</a>로 생성되어 관리됩니다. 그러므로 저 수준 파일 입출력 함수를 기반으로 소켓 기반의 데이터 송수신이 가능합니다.</p><blockquote><p><code>파일 디스크립터(File descriptor)</code></p><ul><li>운영체제가 만든 파일을 구분하기 위한 일종의 숫자</li><li>저 수준 파일 입출력 함수는 입출력을 목적으로 파일 디스크립터를 요구한다.</li><li>저 수준 파일 입출력 함수에 소켓의 파일 디스크립터를 전달하면, 소켓을 대상으로 입출력을 진행한다.</li></ul></blockquote><h3 id="echo_serverc"><a href="#echo-server-c" class="headerlink" title="echo_server.c"></a>echo_server.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 파일 디스크립터를 위한 변수</span></span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">    <span class="keyword">int</span> str_len, i;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clnt_adr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> clnt_adr_sz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. socket 하나를 생성한다.</span></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (serv_sock == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. socket에 IP와 Port 번호를 할당한다.</span></span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr*)&amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. server socket(listen socket)을 통해 클라이언트의 접속 요청을 대기한다.</span></span><br><span class="line">    <span class="comment">//    5개의 수신 대기열(큐)을 생성한다.</span></span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    clnt_adr_sz=<span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 4. 클라이언트 접속 요청을 수락한다. (클라이언트와 연결된 새로운 socket이 생성된다.)</span></span><br><span class="line">        clnt_sock = accept(serv_sock, (struct sockaddr*)&amp;clnt_adr, &amp;clnt_adr_sz);</span><br><span class="line">        <span class="keyword">if</span> (clnt_sock == <span class="number">-1</span>)</span><br><span class="line">            error_handling(<span class="string">"accept() error"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Connected client %d \n"</span>, i+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 클라이언트와 연결된 socket을 통해 데이터를 송수신한다.</span></span><br><span class="line">        <span class="keyword">while</span>((str_len=read(clnt_sock, message, BUF_SIZE)) != <span class="number">0</span>)</span><br><span class="line">            write(clnt_sock, message, str_len);</span><br><span class="line"></span><br><span class="line">        close(clnt_sock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="echo_clientc"><a href="#echo-client-c" class="headerlink" title="echo_client.c"></a>echo_client.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 파일 디스크립터를 위한 변수</span></span><br><span class="line">    <span class="keyword">int</span> sock;</span><br><span class="line">    <span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">    <span class="keyword">int</span> str_len;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. socket 하나를 생성한다.</span></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. socket을 이용해 server의 server socket(listen socket)에 연결을 요청한다.</span></span><br><span class="line">    <span class="keyword">if</span> (connect(sock, (struct sockaddr*)&amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"connect() error!"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Connected..........."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"Input message(Q to quit): "</span>, <span class="built_in">stdout</span>);</span><br><span class="line">        fgets(message, BUF_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(message,<span class="string">"q\n"</span>) || !<span class="built_in">strcmp</span>(message,<span class="string">"Q\n"</span>))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 연결된 socket을 통해 server로부터 데이터를 송수신한다.</span></span><br><span class="line">        write(sock, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">        str_len = read(sock, message, BUF_SIZE<span class="number">-1</span>);</span><br><span class="line">        message[str_len] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Message from server: %s"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="결과-확인"><a href="#결과-확인" class="headerlink" title="결과 확인"></a>결과 확인</h3><p>gcc로 컴파일 후 실행하면 결과는 다음과 같습니다.<br><img src="/images/post/2019-02-21/echo_result.gif" alt="linux_simple_socket_result"></p><h2 id="window"><a href="#window" class="headerlink" title="window"></a>window</h2><p>window는 linux와 달리 파일이 아닌 별도의 소켓 구조체가 존재합니다. 별도의 소켓 구조체를 이용한 함수를 기반으로 소켓 기반의 데이터 송수신이 가능합니다.<br>window 코드의 결과는 위의 linux 코드의 결과와 같으므로 생략합니다.</p><h3 id="echo_server_winc"><a href="#echo-server-win-c" class="headerlink" title="echo_server_win.c"></a>echo_server_win.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">// window socket</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET hServSock, hClntSock;</span><br><span class="line">    <span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">    <span class="keyword">int</span> strLen, i;</span><br><span class="line"></span><br><span class="line">    SOCKADDR_IN servAdr, clntAdr;</span><br><span class="line">    <span class="keyword">int</span> clntAdrSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">        ErrorHandling(<span class="string">"WSAStartup() error!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. socket 하나를 생성한다.</span></span><br><span class="line">    hServSock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hServSock == INVALID_SOCKET)</span><br><span class="line">        ErrorHandling(<span class="string">"socket() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;servAdr, <span class="number">0</span>, <span class="keyword">sizeof</span>(servAdr));</span><br><span class="line">    servAdr.sin_family = AF_INET;</span><br><span class="line">    servAdr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    servAdr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 생성한 socket을 server socket(listen socket)으로 등록한다.</span></span><br><span class="line">    <span class="keyword">if</span> (bind(hServSock, (SOCKADDR*)&amp;servAdr, <span class="keyword">sizeof</span>(servAdr)) == SOCKET_ERROR)</span><br><span class="line">        ErrorHandling(<span class="string">"bind() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. server socket을 통해 클라이언트의 접속 요청을 확인한다.</span></span><br><span class="line">    <span class="keyword">if</span> (listen(hServSock, <span class="number">5</span>) == SOCKET_ERROR)</span><br><span class="line">        ErrorHandling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    clntAdrSize=<span class="keyword">sizeof</span>(clntAdr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 4. 클라이언트 접속 요청 대기 및 허락 (클라이언트와 연결된 새로운 socket이 생성된다.)</span></span><br><span class="line">        hClntSock = accept(hServSock, (SOCKADDR*)&amp;clntAdr, &amp;clntAdrSize);</span><br><span class="line">        <span class="keyword">if</span> (hClntSock == <span class="number">-1</span>)</span><br><span class="line">            ErrorHandling(<span class="string">"accept() error"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Connected client %d \n"</span>, i+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 클라이언트와 연결된 socket을 통해 데이터를 송수신한다.</span></span><br><span class="line">        <span class="keyword">while</span>((strLen=recv(hClntSock, message, BUF_SIZE, <span class="number">0</span>)) != <span class="number">0</span>)</span><br><span class="line">            send(hClntSock, message, strLen, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        closesocket(hClntSock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    closesocket(hServSock);</span><br><span class="line">    WSACleanup();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="echo_client_winc"><a href="#echo-client-win-c" class="headerlink" title="echo_client_win.c"></a>echo_client_win.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">// window socket</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET hSocket;</span><br><span class="line">    <span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">    <span class="keyword">int</span> strLen;</span><br><span class="line">    SOCKADDR_IN servAdr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">        ErrorHandling(<span class="string">"WSAStartup() error!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. socket 하나를 생성한다.</span></span><br><span class="line">    hSocket = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSocket == INVALID_SOCKET)</span><br><span class="line">        ErrorHandling(<span class="string">"socket() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;servAdr, <span class="number">0</span>, <span class="keyword">sizeof</span>(servAdr));</span><br><span class="line">    servAdr.sin_family = AF_INET;</span><br><span class="line">    servAdr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">    servAdr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. socket을 이용해 server의 server socket(listen socket)에 연결을 요청한다.</span></span><br><span class="line">    <span class="keyword">if</span> (connect(hSocket, (SOCKADDR*)&amp;servAdr, <span class="keyword">sizeof</span>(servAdr)) == SOCKET_ERROR)</span><br><span class="line">        ErrorHandling(<span class="string">"connect() error!"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Connected..........."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"Input message(Q to quit): "</span>, <span class="built_in">stdout</span>);</span><br><span class="line">        fgets(message, BUF_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(message,<span class="string">"q\n"</span>) || !<span class="built_in">strcmp</span>(message,<span class="string">"Q\n"</span>))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 연결된 socket을 통해 server로부터 데이터를 송수신한다.</span></span><br><span class="line">        send(hSocket, message, <span class="built_in">strlen</span>(message), <span class="number">0</span>);</span><br><span class="line">        strLen = recv(hSocket, message, BUF_SIZE<span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        message[strLen] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Message from server: %s"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    closesocket(hSocket);</span><br><span class="line">    WSACleanup();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="고찰"><a href="#고찰" class="headerlink" title="고찰"></a>고찰</h2><p>linux와 window의 서버 &amp; 클라이언트 소켓 생성과 연결 과정은 다음과 같습니다.<br><img src="/images/post/2019-02-21/server_client_socket.png" alt="server_client_socket"></p><ul><li>서버<ul><li>클라이언트로부터의 연결요청도 일종의 데이터 전송입니다. 따라서 연결 요청을 받아들이기 위해서도 하나의 소켓이 필요하고, 이 소켓을 가리켜 <code>서버소켓</code> 또는 <code>리스닝 소켓</code>이라고 합니다. listen 함수의 호출은 소켓을 리스닝 소켓으로 만듭니다.</li><li>accept 함수의 결과로 서버소켓을 통해 클라이언트로부터의 연결요청을 받으면, 연결요청 정보를 참조하여 <strong>클라이언트 소켓과의 통신을 위한 별도의 소켓을 추가로 하나 더 생성합니다. 그리고 이렇게 생성된 소켓을 대상으로 데이터의 송수신이 진행됩니다.</strong></li></ul></li><li>클라이언트<ul><li>소켓을 생성하고 연결 요청을 위해서 connect 함수를 호출하는 것이 전부입니다.</li><li>서버의 listen 함수호출 이후에야(서버소켓이 준비된 이후) connect 함수 호출이 유효합니다.</li></ul></li></ul><h3 id="문제점"><a href="#문제점" class="headerlink" title="문제점"></a>문제점</h3><p><img src="/images/post/2019-02-21/echo_result_problem.gif" alt="linux_simple_socket_result"><br>위 예제의 경우 반복적(Iterable)으로 accept 함수를 호출하면, 계속해서 클라이언트의 연결요청을 수락할 수 있습니다. 그러나, 동시에 둘 이상의 클라이언트에게 서비스를 제공할 수 있는 상태는 아닙니다. (처음 소켓 연결을 맺은 클라이언트가 종료하기 전까지는 다른 클라이언트의 연결은 listen 큐에 들어가 대기해야합니다.)</p><p><strong>이 문제를 해결하기 위해 둘 이상의 클라이언트들이 동시에 접속해 서버로부터 서비스를 제공받을 수 있는 여러 <code>다중 접속 서버</code>의 구현 방법들에 대해 알아보겠습니다.</strong></p><blockquote><p>다중 접속 서버 구현 방법</p><ul><li><strong>멀티프로세스 기반 서버</strong> : 다수의 프로세스를 생성하는 방식으로 서비스를 제공한다.</li><li><strong>멀티스레드 기반 서버</strong> : 클라이언트의 수만큼 스레드를 생성하는 방식으로 서비스를 제공한다.</li><li><strong>멀티플렉싱 기반 서버</strong> : 입출력 대상을 묶어서 관리하는 방식으로 서비스를 제공한다.</li></ul></blockquote><h1 id="멀티프로세스-기반의-다중-접속-서버"><a href="#멀티프로세스-기반의-다중-접속-서버" class="headerlink" title="멀티프로세스 기반의 다중 접속 서버"></a>멀티프로세스 기반의 다중 접속 서버</h1><p><strong><code>멀티프로세스 기반의 다중 접속 서버</code>는 다수의 프로세스를 생성하는 방식으로 서비스를 제공합니다.</strong><br><img src="/images/post/2019-02-21/multi_process_server.png" alt="multi_process_server"></p><ol><li>부모 프로세스는 <code>리스닝 소켓</code>으로 accept 함수 호출을 통해서 연결요청을 수락합니다. </li><li>이때 얻게 되는 소켓의 파일 디스크립터(<code>클라이언트와 연결된 연결 소켓</code>)를 자식 프로세스를 생성해 넘겨줍니다.</li><li>자식 프로세스는 전달받은 파일 디스크립터를 바탕으로 서비스를 제공합니다.</li></ol><p>핵심은 연결이 하나 생성될 때마다 프로세스를 생성해서 해당 클라이언트에 대해 서비스를 제공하는 것입니다.</p><h2 id="echo_multi_process_serverc"><a href="#echo-multi-process-server-c" class="headerlink" title="echo_multi_process_server.c"></a>echo_multi_process_server.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_childproc</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> adr_sz;</span><br><span class="line">    <span class="keyword">int</span> str_len, state;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    act.sa_handler = read_childproc;</span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags = <span class="number">0</span>;</span><br><span class="line">    state = sigaction(SIGCHLD, &amp;act, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 1. socket 하나를 생성한다.</span></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. socket에 IP와 Port 번호를 할당한다.</span></span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr*) &amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">    <span class="comment">// 3. 생성한 socket을 server socket(listen socket)으로 등록한다.</span></span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        adr_sz = <span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">        <span class="comment">// 4. 부모 프로세스는 리스닝 소켓으로 accept 함수 호출을 통해서 연결요청을 수락한다.</span></span><br><span class="line">        clnt_sock = accept(serv_sock, (struct sockaddr*)&amp;clnt_adr, &amp;adr_sz);</span><br><span class="line">        <span class="keyword">if</span> (clnt_sock == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"new client connected..."</span>);</span><br><span class="line">        <span class="comment">// 5. 이때 얻게 되는 소켓의 파일 디스크립터(클라이언트와 연결된 연결 소켓)를 자식 프로세스를 생성해 넘겨준다.</span></span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            close(clnt_sock);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            close(serv_sock);</span><br><span class="line">            <span class="comment">// 6. 자식 프로세스는 전달받은 파일 디스크립터를 바탕으로 서비스를 제공한다.</span></span><br><span class="line">            <span class="keyword">while</span>((str_len = read(clnt_sock, buf, BUF_SIZE)) != <span class="number">0</span>)</span><br><span class="line">                write(clnt_sock, buf, str_len);</span><br><span class="line"></span><br><span class="line">            close(clnt_sock);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"client disconnected..."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            close(clnt_sock);</span><br><span class="line">    &#125;</span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_childproc</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"removed proc id: %d \n"</span>, pid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="결과-확인"><a href="#결과-확인-1" class="headerlink" title="결과 확인"></a>결과 확인</h2><p><img src="/images/post/2019-02-21/echo_result_multi_process.gif" alt="echo_result_multi_process"><br>위에서 Iterable하게 구현했을때 발생했던 문제를 각 클라이언트 요청마다 별도의 프로세스를 생성함으로써 문제를 해결한 것을 확인할 수 있습니다.</p><h2 id="고찰"><a href="#고찰-1" class="headerlink" title="고찰"></a>고찰</h2><ul><li>장점<ul><li>프로그램 흐름이 단순하기 때문에 이해하기 쉽습니다.</li><li>안정적인 동작이 가능합니다. 운영체제에서 프로세스는 서로 독립된 실행 객체로 존재합니다. 서로 독립된 메모리 공간을 갖고 서로 다른 프로세스끼리 서로 영향을 미치지 않고 독립적으로 수행이 가능합니다.</li></ul></li><li>단점<ul><li>프로세스 복사에 따른 성능 문제가 있습니다.</li><li>병렬 처리해야 하는 만큼의 프로세스를 생성해야 합니다.</li><li>fork에 의해 자식 프로세스가 생성될 경우, 부모 프로세스의 자원이 복사됩니다. (코드, 소켓을 포함한 모든 열린 파일들(파일 디스크립터)) 부모 프로세스로부터 accept되어 생성된 하나의 소켓에 대해 부모 프로세스와 자식 프로세스 모두에서 한 소켓에 대한 파일 디스크립터가 존재합니다. 따라서 두 파일 디스크립터를 모두 종료해야 해당 소켓을 제거할 수 있습니다.</li><li>서로 다른 독립적인 메모리 공간을 갖기 때문에 프로세스간 정보 교환이 어렵다.</li></ul></li></ul><p>위의 단점들은 각 클라이언트의 요청마다 프로세스가 아닌 스레드를 생성함으로써 해결할 수 있습니다.<br>다음으로 멀티프로세스 기반의 다중 접속 서버의 단점을 개선할 수 있는 멀티스레드 기반의 다중 접속 서버에 대해 알아보겠습니다.</p><h1 id="멀티스레드-기반의-다중-접속-서버"><a href="#멀티스레드-기반의-다중-접속-서버" class="headerlink" title="멀티스레드 기반의 다중 접속 서버"></a>멀티스레드 기반의 다중 접속 서버</h1><p><strong><code>멀티스레드 기반의 다중 접속 서버</code>는 다수의 스레드를 생성하는 방식으로 서비스를 제공합니다.</strong><br><img src="/images/post/2019-02-21/multi_thread_server.png" alt="multi_thread_server"></p><ol><li>메인 스레드는 <code>리스닝 소켓</code>으로 accept 함수 호출을 통해서 연결요청을 수락합니다. </li><li>이때 얻게 되는 소켓의 파일 디스크립터(<code>클라이언트와 연결된 연결 소켓</code>)를 별도의 워커 스레드를 생성해 넘겨줍니다.</li><li>워커 스레드는 전달받은 파일 디스크립터를 바탕으로 서비스를 제공합니다.</li></ol><p>핵심은 연결이 하나 생성될 때마다 프로세스가 아닌 스레드를 생성해서 해당 클라이언트에 대해 서비스를 제공하는 것입니다.</p><h2 id="echo_multi_thread_serverc"><a href="#echo-multi-thread-server-c" class="headerlink" title="echo_multi_thread_server.c"></a>echo_multi_thread_server.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">handle_clnt</span><span class="params">(<span class="keyword">void</span> * arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> * msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> t_id;</span><br><span class="line">    <span class="keyword">socklen_t</span> adr_sz;</span><br><span class="line">    <span class="keyword">int</span> str_len, state;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. socket 하나를 생성한다.</span></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. socket에 IP와 Port 번호를 할당한다.</span></span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr*) &amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">    <span class="comment">// 3. 생성한 socket을 server socket(listen socket)으로 등록한다.</span></span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        adr_sz = <span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">        <span class="comment">// 4. 메인 스레드는 리스닝 소켓으로 accept 함수 호출을 통해서 연결요청을 수락한다.</span></span><br><span class="line">        clnt_sock = accept(serv_sock, (struct sockaddr*)&amp;clnt_adr, &amp;adr_sz);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clnt_sock == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"new client connected..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 클라이언트와 연결된 소켓의 파일 디스크립터를 워커 스레드를 생성해 넘겨준다.</span></span><br><span class="line">        pthread_create(&amp;t_id, <span class="literal">NULL</span>, handle_clnt, (<span class="keyword">void</span>*)&amp;clnt_sock);</span><br><span class="line">        pthread_detach(t_id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">handle_clnt</span><span class="params">(<span class="keyword">void</span> * arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> clnt_sock=*((<span class="keyword">int</span>*)arg);</span><br><span class="line">    <span class="keyword">int</span> str_len=<span class="number">0</span>, i;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 워커 스레드는 전달받은 파일 디스크립터를 바탕으로 서비스를 제공한다.</span></span><br><span class="line">    <span class="keyword">while</span>((str_len = read(clnt_sock, buf, BUF_SIZE)) != <span class="number">0</span>)</span><br><span class="line">        write(clnt_sock, buf, str_len);</span><br><span class="line"></span><br><span class="line">    close(clnt_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> * msg)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(msg, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="결과-확인"><a href="#결과-확인-2" class="headerlink" title="결과 확인"></a>결과 확인</h2><p><img src="/images/post/2019-02-21/echo_result_multi_thread.gif" alt="echo_result_multi_thread"><br>처음 Iterable하게 구현했을때 발생했던 문제를 각 클라이언트 요청마다 별도의 스레드를 생성함으로써 문제를 해결했으며, 클라이언트의 요청마다 각 프로세스를 할당해서 해결한 방법보다 스레드를 생성해 할당함으로써 리소스 소모를 줄였습니다.</p><h2 id="고찰"><a href="#고찰-2" class="headerlink" title="고찰"></a>고찰</h2><ul><li>장점<ul><li>프로세스 복사에 따른 비용보다 스레드 생성에 대한 비용이 적다.</li><li>스레드간 서로 공유하는 메모리를 갖기 때문에, 스레드간 정보 교환이 쉽다.</li></ul></li><li>단점<ul><li>하나의 프로세스 내의 다수의 스레드가 존재하기 때문에 하나의 스레드에서 문제가 생긴다면 프로세스에 영향을 미쳐 나머지 다수의 스레드에도 영향을 끼칠 수 있다.</li></ul></li></ul><p>각 클라이언트 요청마다 별도의 스레드를 생성함으로써 프로세스를 생성하던 방법보다 리소스의 비용을 줄일 수 있었고, 스레드들이 서로 공유하는 메모리를 가질 수 있는 환경이 되었습니다.<br>그러나 <strong><code>I/O 멀티플렉싱(multiplexing)</code> 기법을 사용한다면, 각 클라이언트 마다 별도의 스레드를 생성하는 것이 아닌 하나의 스레드에서 다수의 클라이언트에 연결된 소켓(파일 디스크립터)을 괸리하고 소켓에 이벤트(read/write)가 발생할 경우에만 별도의 스레드를 만들어 해당 이벤트를 처리하도록 구현할 수 있습니다.</strong></p><h1 id="멀티플렉싱-기반의-다중-접속-서버"><a href="#멀티플렉싱-기반의-다중-접속-서버" class="headerlink" title="멀티플렉싱 기반의 다중 접속 서버"></a>멀티플렉싱 기반의 다중 접속 서버</h1><p><code>입출력 다중화</code>란 하나의 프로세스 혹은 스레드에서 입력과 출력을 모두 다룰 수 있는 기술을 말합니다. 커널(kernel)에서는 <strong>하나의 스레드가 여러 개의 소켓(파일)을 핸들링 할 수 있는 <code>select</code>, <code>poll</code>, <code>epoll</code>과 같은 시스템 콜(system call)을 제공하고 있습니다.</strong></p><p>한개의 프로세스 혹은 스레드에서 한개의 클라이언트에 대한 입출력만 처리할 수 있었던 이유는 입출력 함수가 봉쇄(block)되었기 때문에, 입출력 데이터가 준비될때까지 무한정 봉쇄되어 여러 클라이언트의 입출력을 처리할 수 없었기 때문입니다.</p><p><strong>그러나 I/O 멀티플렉싱 기법을 사용하면 입출력 다중화에서도 입출력 함수는 여전히 봉쇄로 작동하지만, 입출력 함수를 호출하기전에 어떤 파일에서 입출력이 준비가 되었는지 확인할 수가 있습니다.</strong></p><blockquote><p><strong>봉쇄 (block)</strong></p><p>봉쇄를 이해하기 위해 먼저 두가지 짚고 넘어가야할 사항이 있습니다.</p><ol><li>애플리케이션에서 I/O 작업을 하는 경우, 스레드는 데이터 준비가 완료될 때까지 대기합니다. 예를 들어 소켓을 통해 read(recvfrom)를 수행하는 경우 데이터가 네트워크를 통해 도착하는 것을 기다립니다. 패킷이 네트워크를 통해 도착하면 커널 내의 버퍼에 복사됩니다. (처음에 커널 공간에 생성된 소켓의 구조에서 송신 버퍼와 수신 버퍼가 있는 것을 보았습니다.)</li><li>커널 내의 버퍼에 복사된 데이터를 애플리케이션에서 사용하기 위해서는 <code>커널 버퍼(kernel space)</code>에서 <code>유저 버퍼(user space)</code>로 복사 후 이용해야 합니다. 애플리케이션은 유버 모드에서 유저 버퍼에만 접근이 가능하기 때문입니다.</li></ol><p><strong>Blocking I/O Model</strong><br><img src="/images/post/2019-02-21/blocking_io_model.png" alt="blocking_io_model"><br>프로세스(스레드)는 하나의 소켓에 대해 recvfrom을 호출하고 데이터가 kernel space 도착해 user space의 프로세스 버퍼에 복사 될 때까지 시스템 호출이 반환되지 않습니다. <strong>즉 recvfrom은 kernel space에 데이터가 도착하길 기다리는것 부터 시작됩니다.</strong> 프로세스는 recvfrom을 호출할 때부터 반환 할 때까지 전체 프로세스가 봉쇄됩니다.</p></blockquote><p><strong>I/O Multiplexing Model</strong><br><img src="/images/post/2019-02-21/multiplexing_io_model.png" alt="multiplexing_io_model"><br>멀티플렉싱 모델에서는 select 함수를 호출해, 여러개의 소켓들 중 recvfrom이 가능한 소켓이 생길 때까지 대기합니다. select의 결과로 recvfrom을 호출할 수 있는 소켓의 목록이 반환되면, 해당 소켓들에 대해 recvfrom을 호출합니다.</p><p>봉쇄 모델(Blocking I/O model)에서는 하나의 프로세스(스레드)에서 하나의 소켓(파일 디스크립터)에 대해 recvfrom을 호출해 데이터가 kernel space에 도착했는지 확인하고 현재 읽을 수 있는 데이터가 없다면 봉쇄되어 대기했다면, <strong>멀티플렉싱 모델(I/O Multiplexing Model)에서는 하나 이상의 소켓(파일 디스크립터)이 준비 될 때까지 대기할 수 있습니다.</strong></p><h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><p><strong><code>select</code> 방식은 이벤트(입력|출력|에러) 별로 감시할 파일들을 fd_set 이라는 파일 상태 테이블(fd 비트 배열)에 등록하고, 등록된 파일(파일 디스크립터)에 어떠한 이벤트가 발생했을 경우 fd_set을 확인하는 방식으로 동작합니다.</strong><br><img src="/images/post/2019-02-21/select_model.png" alt="select_model"><br>예를 들어 위와 같이 6개의 파일을 다루어야 한다고 했을 때, 6개의 파일에 대해 입출력 데이터가 준비될 때까지 이벤트를 기다리는 파일 상태 테이블을 준비합니다. 그 후 6개의 파일 중 입출력이 준비된 파일에 대해서 이벤트가 발생하면 이벤트가 발생한 파일 디스크립터의 수를 반환합니다. 이후 이벤트가 준비된 파일에 대해 입출력을 수행하는데 이미 데이터가 준비된 파일에 대해 입출력을 수행하기 때문에 봉쇄가 발생하지 않을 것이라는게 보장됩니다.</p><blockquote><p>int select(int nfds, fd_set <em>readfds, fd_set </em>writefds, fd_set <em>exceptfds, struct timeval </em>timeout)</p><ul><li>nfds: 검사 대상이 되는 파일 디스크립터의 수</li><li>readfs: 읽기 이벤트를 검사할 파일 디스크립터의 목록</li><li>writefds: 쓰기 이벤트를 검사할 파일 디스크립터의 목록</li><li>exceptfds: 예외 이벤트를 검사할 파일 디스크립터의 목록</li><li>timeout: 이벤트를 기다릴 시간 제한</li><li>반환 값: <strong>이벤트가 발생한 파일의 갯수</strong></li></ul><p>반환 값이 이벤트가 발생한 파일의 디스크립터 목록이 아닌 파일의 갯수임에 주의해야합니다. </p></blockquote><h3 id="echo_select_serverc"><a href="#echo-select-server-c" class="headerlink" title="echo_select_server.c"></a>echo_select_server.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 100</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    <span class="comment">// 파일 상태 테이블 선언</span></span><br><span class="line">    fd_set reads, cpy_reads;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> adr_sz;</span><br><span class="line">    <span class="keyword">int</span> fd_max, str_len, fd_num, i;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr*) &amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    FD_ZERO(&amp;reads); <span class="comment">// fd_set 테이블을 초기화한다.</span></span><br><span class="line">    FD_SET(serv_sock, &amp;reads); <span class="comment">// 서버 소켓(리스닝 소켓)의 이벤트 검사를 위해 fd_set 테이블에 추가한다.</span></span><br><span class="line">    fd_max = serv_sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        cpy_reads = reads;</span><br><span class="line">        timeout.tv_sec = <span class="number">5</span>;</span><br><span class="line">        timeout.tv_usec = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// result</span></span><br><span class="line">        <span class="comment">// -1: 오류 발생</span></span><br><span class="line">        <span class="comment">// 0: 타임 아웃</span></span><br><span class="line">        <span class="comment">// 1 이상 : 등록된 파일 디스크립터에 해당 이벤트가 발생하면 이벤트가 발생한 파일 디스크립터의 수를 반환한다.</span></span><br><span class="line">        <span class="keyword">if</span> ((fd_num = select(fd_max+<span class="number">1</span>, &amp;cpy_reads, <span class="number">0</span>, <span class="number">0</span>, &amp;timeout)) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd_num == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;fd_max+<span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(i, &amp;cpy_reads)) &#123; <span class="comment">// fd_set 테이블을 검사한다.</span></span><br><span class="line">                <span class="comment">// 서버 소켓(리스닝 소켓)에 이벤트(연결 요청) 발생</span></span><br><span class="line">                <span class="keyword">if</span> (i == serv_sock) &#123;     <span class="comment">// connection request!</span></span><br><span class="line">                    adr_sz = <span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">                    clnt_sock= accept(serv_sock, (struct sockaddr*)&amp;clnt_adr, &amp;adr_sz);</span><br><span class="line">                    FD_SET(clnt_sock, &amp;reads); <span class="comment">// fd_set 테이블에 클라이언트 소켓 디스크립터를 추가한다.</span></span><br><span class="line">                    <span class="keyword">if</span> (fd_max &lt; clnt_sock)</span><br><span class="line">                        fd_max = clnt_sock;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"connected client: %d \n"</span>, clnt_sock);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 클라이언트와 연결된 소켓에 이벤트 발생</span></span><br><span class="line">                <span class="keyword">else</span> &#123;   <span class="comment">// read message!</span></span><br><span class="line">                    str_len = read(i, buf, BUF_SIZE);</span><br><span class="line">                    <span class="keyword">if</span> (str_len == <span class="number">0</span>) &#123;   <span class="comment">// close request!</span></span><br><span class="line">                        FD_CLR(i, &amp;reads); <span class="comment">// fd_set 테이블에서 파일 디스크립터를 삭제한다.</span></span><br><span class="line">                        close(i);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"closed client: %d \n"</span>, i);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        write(i, buf, str_len);    <span class="comment">// echo!</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *buf)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(buf, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="결과-확인"><a href="#결과-확인-3" class="headerlink" title="결과 확인"></a>결과 확인</h3><p><img src="/images/post/2019-02-21/echo_result_select.gif" alt="echo_result_select"></p><h3 id="고찰"><a href="#고찰-3" class="headerlink" title="고찰"></a>고찰</h3><ul><li>장점<ul><li>단일 프로세스(스레드)에서 여러 파일의 입출력 처리가 가능합니다.</li><li>지원 하는 OS가 많아 이식성이 좋습니다. (POSIX 표준)</li></ul></li><li>단점<ul><li>커널에 의해서 완성되는 기능이 아닌, 순수하게 함수에 의해 완성되는 기능이다. </li><li>select 함수의 호출을 통해서 전달된 정보는 커널에 등록되지 않은 것이며, 그래서 select 함수를 호출할 때마다 매번 관련 정보를 전달해야 합니다. </li><li>select 함수의 호출 결과가 이벤트가 발생한 파일 디스크립터의 개수이기 때문에 어떤 파일 디스크립터에서 이벤트가 발생했는지 확인하기 위해서는 fd_set 테이블 전체를 검사해야 합니다. (속도가 느립니다)</li><li>검사할 수 있는 fd 개수에 제한이 있습니다. (최대 1024개)</li><li>select 호출 때마다 데이터를 복사해야합니다. (select 함수를 호출한 후 이벤트를 처리할 때 fd_set 테이블 변경이 필요하기 때문에 미리 복사가 필요합니다)</li></ul></li></ul><blockquote><p><a href="https://ko.wikipedia.org/wiki/POSIX" target="_blank" rel="noopener">POSIX란?</a></p><p>POSIX(Portable Operating System Interface)는 이식 가능 운영 체제 인터페이스의 약자로, 서로 다른 UNIX OS의 공통 API를 정리하여 이식성이 높은 유닉스 응용 프로그램을 개발하기 위한 목적으로 IEEE가 책정한 애플리케이션 인터페이스 규격입니다.</p></blockquote><h2 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h2><p>poll도 select와 마찬가지로 멀티플렉싱을 구현하기 위한 방법입니다. poll이 여러 개의 파일을 다루는 방법은 select와 마찬가지로 fd(파일 디스크립터)의 이벤트를 기다리다가 이벤트가 발생하면, poll에서의 block이 해제되고, 다음 루틴에서 어떤 fd에 이벤트가 발생했는지 검사하는 방식을 사용합니다.</p><p>poll의 동작 원리는 select와 비슷하므로 생략합니다. 간단히 select와 비교해 차이점에 대해서만 알아보겠습니다.</p><ul><li>장점<ul><li>select와 단일 프로세스(스레드)에서 여러 파일의 입출력 처리가 가능합니다.</li><li>select 방식처럼 표준 입력|출력|에러을 따로 감시할 필요가 없습니다.</li><li>select는 timeval이라는 구조체를 사용해 타임아웃 값을 세팅하지만, poll은 별다른 구조체 없이 타임아웃 기능을 지원합니다. </li></ul></li><li>단점<ul><li>일부 unix 시스템에서는 poll을 지원하지 않습니다.</li></ul></li></ul><h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>epoll은 select 함수의 단점 극복을 위해 <strong>커널 레벨멀티플렉싱을 지원해줍니다.</strong> 커널에 관찰대상에 대한 정보를 한 번만 전달하고, 관찰대상의 범위, 또는 내용에 변경이 있을 때만 변경 사항을 알려줍니다. <strong>리눅스에서는 <code>epoll</code>, 윈도우에서는 <code>IOCP</code>, 맥에서는 <code>Kqueue</code>가 이에 해당합니다.</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int epoll_create(int size); //size는 epoll_fd의 크기정보를 전달한다.</span><br><span class="line">// 반환 값 : 실패 시 -1, 일반적으로 epoll_fd의 값을 리턴</span><br><span class="line"></span><br><span class="line">int epoll_ctl(int epoll_fd,             // epoll_fd</span><br><span class="line">              int operate_enum,         // 어떤 변경을 할지 결정하는 enum값</span><br><span class="line">              int enroll_fd,            // 등록할 fd</span><br><span class="line">              struct epoll_event* event // 관찰 대상의 관찰 이벤트 유형</span><br><span class="line">              ); </span><br><span class="line">// 반환 값 : 실패 시 -1, 성공시 0</span><br><span class="line"></span><br><span class="line">int epoll_wait(int epoll_fd,              // epoll_fd</span><br><span class="line">               struct epoll_event* event, // event 버퍼의 주소</span><br><span class="line">               int maxevents,             // 버퍼에 들어갈 수 있는 구조체 최대 개수</span><br><span class="line">               int timeout                // select의 timeout과 동일 단위는 1/1000</span><br><span class="line">               );</span><br><span class="line">// 성공시 이벤트 발생한 파일 디스크립터 개수 반환, 실패시 -1 반환</span><br></pre></td></tr></table></figure><blockquote><ul><li>epoll_create : epoll 파일 디스크립터 저장소 생성</li><li>epoll_ctl : 저장소에 파일 디스크립터 등록 및 삭제</li><li>epoll_wait : select 함수와 마찬가지로 파일 디스크립터의 변화를 대기한다.</li></ul><p>epoll_create를 통해 생성된 epoll 인스턴스에 관찰대상을 저장 및 삭제하는 함수가 epoll_ctl이고, epoll 인스턴스에 등록된 파일 디스크립터를 대상으로 이벤트의 발생 유무를 확인하는 함수가 epoll_wait이다.</p></blockquote><h3 id="echo_epoll_serverc"><a href="#echo-epoll-server-c" class="headerlink" title="echo_epoll_server.c"></a>echo_epoll_server.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="comment">// 리눅스에서만 사용 가능</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EPOLL_SIZE 50</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> adr_sz;</span><br><span class="line">    <span class="keyword">int</span> str_len, i;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> *<span class="title">ep_events</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="keyword">int</span> epfd, event_cnt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr*) &amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 커널이 관리하는 epoll 인스턴스라 불리는 파일 디스크립터의 저장소 생성</span></span><br><span class="line">    <span class="comment">// 성공 시 epoll 파일 디스크립터, 실패시 -1 반환</span></span><br><span class="line">    epfd = epoll_create(EPOLL_SIZE);</span><br><span class="line">    ep_events = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct epoll_event)*EPOLL_SIZE);</span><br><span class="line"></span><br><span class="line">    event.events = EPOLLIN;</span><br><span class="line">    event.data.fd = serv_sock;</span><br><span class="line">    <span class="comment">// 파일 디스크립터(serv_sock)를 epoll 인스턴스에 등록한다. (관찰대상의 관찰 이벤트 유형은 EPOLLIN)</span></span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_ADD, serv_sock, &amp;event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 성공 시 이벤트가 발생한 파일 디스크립터이ㅡ 수, 실패 시 -1 반환</span></span><br><span class="line">        <span class="comment">// 두 번째 인자로 전달된 주소의 메모리 공간에 이벤트 발생한 파일 디스크립터에 대한 정보가 들어있다.</span></span><br><span class="line">        event_cnt = epoll_wait(epfd, ep_events, EPOLL_SIZE, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (event_cnt == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"epoll_wait() error"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;event_cnt; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ep_events[i].data.fd == serv_sock) &#123;</span><br><span class="line">                adr_sz = <span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">                clnt_sock= accept(serv_sock, (struct sockaddr*)&amp;clnt_adr, &amp;adr_sz);</span><br><span class="line">                event.events = EPOLLIN;</span><br><span class="line">                event.data.fd = clnt_sock;</span><br><span class="line">                <span class="comment">// 파일 디스크립터(clnt_sock)를 epoll 인스턴스에 등록한다. (관찰대상의 관찰 이벤트 유형은 EPOLLIN)</span></span><br><span class="line">                epoll_ctl(epfd, EPOLL_CTL_ADD, clnt_sock, &amp;event);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"connected client: %d \n"</span>, clnt_sock);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                str_len = read(ep_events[i].data.fd, buf, BUF_SIZE);</span><br><span class="line">                <span class="keyword">if</span> (str_len == <span class="number">0</span>) &#123; <span class="comment">// close request!</span></span><br><span class="line">                    epoll_ctl(epfd, EPOLL_CTL_DEL, ep_events[i].data.fd, <span class="literal">NULL</span>);</span><br><span class="line">                    close(ep_events[i].data.fd);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"closed client: %d \n"</span>, ep_events[i].data.fd);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    write(ep_events[i].data.fd, buf, str_len);    <span class="comment">// echo!</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    close(serv_sock);</span><br><span class="line">    close(epfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *buf)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(buf, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="결과-확인"><a href="#결과-확인-4" class="headerlink" title="결과 확인"></a>결과 확인</h3><p><img src="/images/post/2019-02-21/echo_result_epoll.gif" alt="echo_result_epoll"></p><h3 id="고찰"><a href="#고찰-4" class="headerlink" title="고찰"></a>고찰</h3><ul><li>장점<ul><li>상태변화의 확인을 위한, 전체 파일 디스크립터를 대상으로 하는 반복문이 필요 없습니다.</li><li>select 함수에 대응하는 epoll_wait 함수호출 시, 커널에서 상태정보를 유지하기 때문에 관찰대상의 정보를 매번 전달할 필요가 없습니다.</li></ul></li><li>단점<ul><li>리눅스의 select 기반 서버를 윈도우의 select 기반 서버로 변경하는 것은 간단하나, 리눅스의 epoll 기반의 서버를 윈도우의 IOCP 기반으로 변경하는 것은 select를 이용하는 것보다 번거롭습니다.</li></ul></li></ul><h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul><li><a href="http://www.masterraghu.com/subjects/np/introduction/unix_network_programming_v1.3/ch06lev1sec2.html" target="_blank" rel="noopener">I/O Models</a></li><li><a href="https://notes.shichao.io/unp/ch6/" target="_blank" rel="noopener">I/O Multiplexing: The select and poll Functions</a> </li><li><a href="http://www.hanbit.co.kr/store/books/look.php?p_code=B2142415021" target="_blank" rel="noopener">뇌를 자극하는 TCP/IP 소켓 프로그래밍</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;소켓이란&quot;&gt;&lt;a href=&quot;#소켓이란&quot; class=&quot;headerlink&quot; title=&quot;소켓이란?&quot;&gt;&lt;/a&gt;소켓이란?&lt;/h1&gt;&lt;p&gt;&lt;code&gt;소켓&lt;/code&gt;은 네트워크 상에서 서버와 클라이언트 두개의 프로그램이 특정 포트를 통해 양방향 
      
    
    </summary>
    
      <category term="Programming" scheme="https://jongmin92.github.io/categories/Programming/"/>
    
      <category term="Java" scheme="https://jongmin92.github.io/categories/Programming/Java/"/>
    
    
      <category term="select" scheme="https://jongmin92.github.io/tags/select/"/>
    
      <category term="multiplexing" scheme="https://jongmin92.github.io/tags/multiplexing/"/>
    
      <category term="socket" scheme="https://jongmin92.github.io/tags/socket/"/>
    
      <category term="nonblocking" scheme="https://jongmin92.github.io/tags/nonblocking/"/>
    
      <category term="poll" scheme="https://jongmin92.github.io/tags/poll/"/>
    
      <category term="epoll" scheme="https://jongmin92.github.io/tags/epoll/"/>
    
  </entry>
  
</feed>

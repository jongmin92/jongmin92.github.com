<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">

<meta name="generator" content="Hexo 3.9.0">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>92Hz</title>

<!-- For SEO -->
<link rel="canonical" href="https://jongmin92.github.io/archives/4/">


    <meta property="og:type" content="website">
<meta property="og:title" content="92Hz">
<meta property="og:url" content="https://jongmin92.github.io/archives/4/index.html">
<meta property="og:site_name" content="92Hz">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https://jongmin92.github.io/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="92Hz">
<meta name="twitter:image" content="https://jongmin92.github.io/images/og_image.png">





<link rel="alternative" href="rss2.xml" title="92Hz" type="application/atom+xml">



<link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90389042-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-90389042-1');
</script>

    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.png" alt="92Hz" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="검색" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main">
    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-30T10:15:00.000Z">2019-04-30</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Spring/">Spring</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6분 읽기 (대략 863 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/30/Spring/spring-bean-lite-mode/">@Bean Lite Mode &amp; inter-bean references</a>
            
        </h1>
        <div class="content">
            <h1 id="bean-methods-in-configuration-classes"><a href="#Bean-Methods-in-Configuration-Classes" class="headerlink" title="@Bean Methods in @Configuration Classes"></a>@Bean Methods in @Configuration Classes</h1><p>일반적으로 <strong><code>@Bean</code></strong> 어노테이션은 <strong><code>@Configuration</code></strong> 어노테이션이 사용된 클래스 내의 메서드에 선언이 됩니다. 이 경우 <strong>@Bean 어노테이션을 사용하는 메서드는 같은 클래스의 다른 @Bean 메소드를 직접 호출하여 참조할 수 있습니다. 이렇게하면 bean 간의 참조(reference)가 강하게 만들어집니다.</strong></p>
<p>아래 코드의 실행 후 로그를 통해 a() 메서드의 결과로 생성되는 A 클래스의 빈은 b() 와 c() 메서드에서 a() 메서드를 직접 호출해 참조가 되는 것을 확인할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = SpringApplication.run(TestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> A <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> A();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> B <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> B();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> C <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> C();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 샐행 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">04.837</span>  INFO <span class="number">24509</span> --- [           main] com.example.test.TestApplication         : Starting TestApplication on AL01297960.local with PID <span class="number">24509</span> (/Users/user/work/test/build/classes/java/main started by user in /Users/user/work/test)</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">04.841</span>  INFO <span class="number">24509</span> --- [           main] com.example.test.TestApplication         : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">06.229</span>  INFO <span class="number">24509</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.262  INFO 24509 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.262  INFO 24509 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.17]</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.353  INFO 24509 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.353  INFO 24509 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1441 ms</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@42163c37</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@42163c37</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.620  INFO 24509 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.846  INFO 24509 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-30 19:41:06.850  INFO 24509 --- [           main] com.example.test.TestApplication         : Started TestApplication in 2.489 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">3.45</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>이러한 관계를 <strong><code>빈 간의 참조(inter-bean references)</code></strong>라 부릅니다. 이러한 빈 간의 참조는 @Configuration 클래스의 @Bean이 cglib wrapper에 의해 래핑되기 때문에 동작하게 됩니다.(@Bean 메서드에 대한 호출을 가로채고 Bean 인스턴스를 컨텍스트에서 반환하게 됩니다.)</p>
<h1 id="bean-lite-mode"><a href="#Bean-Lite-Mode" class="headerlink" title="@Bean Lite Mode"></a>@Bean Lite Mode</h1><p>처음 알게된 분도 계실 수 있을텐데요, <strong>@Bean 메소드는 @Configuration으로 주석을 달지 않은 클래스 내에서도 선언 될 수도 있습니다.</strong> 이런 경우, @Bean 메서드는 <strong><code>lite mode</code></strong>로 처리됩니다.</p>
<p><strong>lite mode의 Bean 메서드는 스프링 컨테이너에 의해 일반 팩토리 메서드로 처리됩니다. 그렇기 때문에, lite mode에서는 빈 간의 참조가 지원되지 않습니다.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = SpringApplication.run(TestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> A <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> A();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> B <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> B();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> C <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            A a = a();</span><br><span class="line">            System.out.println(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> C();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 실행 결과</span></span><br><span class="line">```java</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">20</span>:<span class="number">02</span>:<span class="number">17.530</span>  INFO <span class="number">65524</span> --- [           main] com.example.test.TestApplication         : Starting TestApplication on AL01297960.local with PID <span class="number">65524</span> (/Users/user/work/test/build/classes/java/main started by user in /Users/user/work/test)</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">20</span>:<span class="number">02</span>:<span class="number">17.534</span>  INFO <span class="number">65524</span> --- [           main] com.example.test.TestApplication         : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">20</span>:<span class="number">02</span>:<span class="number">18.857</span>  INFO <span class="number">65524</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.891  INFO 65524 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.891  INFO 65524 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.17]</span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.973  INFO 65524 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2019-04-30 20:02:18.973  INFO 65524 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1368 ms</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@919d542c</span></span><br><span class="line"><span class="function">com.example.test.TestApplication$A@414fc49c</span></span><br><span class="line"><span class="function">2019-04-30 20:02:19.240  INFO 65524 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2019-04-30 20:02:19.471  INFO 65524 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-30 20:02:19.474  INFO 65524 --- [           main] com.example.test.TestApplication         : Started TestApplication in 2.406 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">3.2</span>)</span></span></span><br></pre></td></tr></table></figure>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-25T15:30:00.000Z">2019-04-26</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13분 읽기 (대략 1978 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/26/Java/java-async-3/">AsyncRestTemplate의 콜백 헬과 중복 작업 문제</a>
            
        </h1>
        <div class="content">
            <p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=Tb43EyWTSlQ" rel="external nofollow noopener noreferrer" target="_blank">토비의 봄 TV 10회 스프링 리액티브 프로그래밍 (6) AsyncRestTemplate의 콜백 헬과 중복 작업 문제</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p>
<p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p>
<p>이번에는 포스팅에서는 지난번 ListenableFuture를 사용하면서 발생한 콜백헬을 어떻게 개선할지에 대해서 이야기합니다. <strong>ListenableFuture를 Wrapping 하는 Completion이라는 클래스를 만들어, chainable하게 사용할 수 있는 방식으로 코드를 만들어봅니다.</strong><br>콜백헬의 문제로는 에러를 처리하는 코드가 중복이 된다는 것도 있는데, 이 부분도 해결해봅니다.</p>
<h1 id="completion-클래스-추가"><a href="#Completion-클래스-추가" class="headerlink" title="Completion 클래스 추가"></a>Completion 클래스 추가</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="andapply-메서드-추가"><a href="#andApply-메서드-추가" class="headerlink" title="andApply 메서드 추가"></a>andApply 메서드 추가</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Completion</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andApply</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.accept(value);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (fn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf = fn.apply(value);</span><br><span class="line">                lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="acceptcompletion-asynccompletion-클래스-추가"><a href="#AcceptCompletion-AsyncCompletion-클래스-추가" class="headerlink" title="AcceptCompletion, AsyncCompletion 클래스 추가"></a>AcceptCompletion, AsyncCompletion 클래스 추가</h1><p>Completion을 결과를 받아서 사용만 하고 끝나는 Accept 처리를 하는 Completion과, 결과를 받아서 또 다른 비동기 작업을 수행하고 그 결과를 반환하는 Apply 용 Completion으로 분리합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptCompletion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncCompletion</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf = fn.apply(value);</span><br><span class="line">            lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andApply</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AsyncCompletion(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AcceptCompletion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="errorcompletion-클래스-추가"><a href="#ErrorCompletion-클래스-추가" class="headerlink" title="ErrorCompletion 클래스 추가"></a>ErrorCompletion 클래스 추가</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andError(e -&gt; dr.setErrorResult(e))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Consumer&lt;ResponseEntity&lt;String&gt;&gt; con;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptCompletion</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Consumer&lt;Throwable&gt; econ;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ErrorCompletion</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.econ = econ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                next.run(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            econ.accept(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCompletion</span> <span class="keyword">extends</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncCompletion</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf = fn.apply(value);</span><br><span class="line">            lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span> </span>&#123;</span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Completion <span class="title">from</span><span class="params">(ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> Completion();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andApply</span><span class="params">(Function&lt;ResponseEntity&lt;String&gt;, ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AsyncCompletion(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion <span class="title">andError</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> ErrorCompletion(econ);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;ResponseEntity&lt;String&gt;&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion c = <span class="keyword">new</span> AcceptCompletion(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(ResponseEntity&lt;String&gt; s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ResponseEntity&lt;String&gt; value)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="generic-적용"><a href="#Generic-적용" class="headerlink" title="Generic 적용"></a>Generic 적용</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        MyService myService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL1 = <span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String URL2 = <span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            Completion</span><br><span class="line">                    .from(rt.getForEntity(URL1, String.class, <span class="string">"hello"</span> + idx))</span><br><span class="line">                    .andApply(s -&gt; rt.getForEntity(URL2, String.class, s.getBody()))</span><br><span class="line">                    .andApply(s -&gt; myService.work(s.getBody()))</span><br><span class="line">                    .andError(e -&gt; dr.setErrorResult(e.toString()))</span><br><span class="line">                    .andAccept(s -&gt; dr.setResult(s));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity("http://localhost:8081/service?req=&#123;req&#125;", String.class, "hello" + idx);</span></span><br><span class="line"><span class="comment">            f1.addCallback(s -&gt; &#123;</span></span><br><span class="line"><span class="comment">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity("http://localhost:8081/service2?req=&#123;req&#125;", String.class, s.getBody());</span></span><br><span class="line"><span class="comment">                f2.addCallback(s2 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    ListenableFuture&lt;String&gt; f3 = myService.work(s2.getBody());</span></span><br><span class="line"><span class="comment">                    f3.addCallback(s3 -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setResult(s3);</span></span><br><span class="line"><span class="comment">                    &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                        dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                    &#125;);</span></span><br><span class="line"><span class="comment">                &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;);</span></span><br><span class="line"><span class="comment">            &#125;, e -&gt; &#123;</span></span><br><span class="line"><span class="comment">                dr.setErrorResult(e.getMessage());</span></span><br><span class="line"><span class="comment">            &#125;);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletion</span>&lt;<span class="title">S</span>&gt; <span class="keyword">extends</span> <span class="title">Completion</span>&lt;<span class="title">S</span>, <span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        Consumer&lt;S&gt; con;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptCompletion</span><span class="params">(Consumer&lt;S&gt; con)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.con = con;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(S value)</span> </span>&#123;</span><br><span class="line">            con.accept(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCompletion</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Completion</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Consumer&lt;Throwable&gt; econ;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ErrorCompletion</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.econ = econ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                next.run(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            econ.accept(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCompletion</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Completion</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Function&lt;S, ListenableFuture&lt;T&gt;&gt; fn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncCompletion</span><span class="params">(Function&lt;S, ListenableFuture&lt;T&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fn = fn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(S value)</span> </span>&#123;</span><br><span class="line">            ListenableFuture&lt;T&gt; lf = fn.apply(value);</span><br><span class="line">            lf.addCallback(s -&gt; complete(s), e -&gt; error(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// S는 넘어온 파라미터, T는 결과</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Completion</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Completion next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> &lt;S, T&gt; <span class="function">Completion&lt;S, T&gt; <span class="title">from</span><span class="params">(ListenableFuture&lt;T&gt; lf)</span> </span>&#123;</span><br><span class="line">            Completion&lt;S, T&gt; c = <span class="keyword">new</span> Completion&lt;&gt;();</span><br><span class="line">            lf.addCallback(s -&gt; &#123;</span><br><span class="line">                c.complete(s);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                c.error(e);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> &lt;V&gt; <span class="function">Completion&lt;T, V&gt; <span class="title">andApply</span><span class="params">(Function&lt;T, ListenableFuture&lt;V&gt;&gt; fn)</span> </span>&#123;</span><br><span class="line">            Completion&lt;T, V&gt; c = <span class="keyword">new</span> AsyncCompletion&lt;&gt;(fn);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Completion&lt;T, T&gt; <span class="title">andError</span><span class="params">(Consumer&lt;Throwable&gt; econ)</span> </span>&#123;</span><br><span class="line">            Completion&lt;T, T&gt; c = <span class="keyword">new</span> ErrorCompletion&lt;&gt;(econ);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">andAccept</span><span class="params">(Consumer&lt;T&gt; con)</span> </span>&#123;</span><br><span class="line">            Completion&lt;T, Void&gt; c = <span class="keyword">new</span> AcceptCompletion&lt;&gt;(con);</span><br><span class="line">            <span class="keyword">this</span>.next = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(T s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.run(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(S value)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>) next.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">work</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(req + <span class="string">"/asyncwork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">myThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        te.setCorePoolSize(<span class="number">1</span>);</span><br><span class="line">        te.setMaxPoolSize(<span class="number">1</span>);</span><br><span class="line">        te.initialize();</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-13T14:24:00.000Z">2019-04-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    37분 읽기 (대략 5578 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/13/Java/java-async-2/">비동기 RestTemplate과 비동기 MVC/Serlvet</a>
            
        </h1>
        <div class="content">
            <p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=ExUfZkh7Puk" rel="external nofollow noopener noreferrer" target="_blank">토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p>
<p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p>
<h1 id="thread-pool-hell"><a href="#Thread-Pool-Hell" class="headerlink" title="Thread Pool Hell"></a>Thread Pool Hell</h1><p><strong><a href="https://jongmin92.github.io/2019/03/31/Java/java-async-1/#servlet-async">스프링의 비동기 기술</a></strong> 을 이용해 클라이언트로부터 요청을 받은 후 실제 작업은 작업 스레드 풀에 위임하고 현재의 서블릿 스레드는 서블릿 스레드 풀에 반환 후, 다음 요청이 들어올 경우 바로 사용할 수 있게 효율적으로 처리하도록 만들었습니다.<br>그러나 아직 문제가 있습니다. </p>
<p>아주 빠르게 무언가를 계산하고 해당 처리를 끝내는 경우라면 굳이 비동기 MVC(서블릿)를 사용하지 않아도 문제가 없지만, <strong>하나의 요청에 대한 처리를 수행하면서 외부의 서비스들을 호출하는 작업이 많이 있는 경우, 문제는 단순히 비동기를 서블릿을 사용하는 것만으로 해결할 수 없는 경우가 많이 있습니다.</strong> (서블릿 요청은 바로 사용 가능하더라도 워커 스레드가 I/O 같은 작업으로 인해 블록되기 때문입니다.)</p>
<p><strong><code>Thread Pool Hell</code>이란 풀 안에 있는 스레드에 대한 사용 요청이 급격하게 증가해 추가적인 요청이 들어올 때, 사용 가능한 스레드 풀의 스레드가 없기 때문에 대기 상태에 빠져 요청에 대한 응답이 느려지게 되는 상태를 말합니다.</strong><br><img src="/images/post/2019-04-13/thread_pool_hell.png" alt="thread pool hell"></p>
<p>최근 서비스들은 아래의 그럼처럼 하나의 요청을 처리함에 있어 다른 서버로의 요청(Network I/O)이 많아졌습니다. 조금전 설명한 것처럼 비동기 서블릿을 사용하더라도 하나의 요청을 처리하는 동안 하나의 작업(워커) 스레드는 그 시간동안 대기상태에 빠지게 되어 결국에는 스레드 풀의 가용성이 떨어지게 됩니다. 이번 포스팅에서는 해당 문제를 해결해가는 과정을 다루고 있습니다.</p>
<p><img src="/images/post/2019-04-13/service_oriented_architecture.png" alt="service oriented architecture"></p>
<h1 id="upgrade-client-for-load-test"><a href="#Upgrade-Client-For-Load-Test" class="headerlink" title="Upgrade Client (For Load Test)"></a>Upgrade Client (For Load Test)</h1><p>지난 번에 작성했던 Client를 조금 수정하도록 합니다. 기존의 Client는 100개의 스레드를 순차적으로 만들면서 서버로의 Request를 만들었던 문제가 있었습니다. 이제는 100개의 스레드를 만들고 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CyclicBarrier.html" rel="external nofollow noopener noreferrer" target="_blank">CyclicBarrier</a>를 이용해 100개의 스레드에서 동시에 Request를 만들도록 변경해보겠습니다. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/rest?idx=&#123;idx&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">101</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// submit이 받는 callable은 return을 가질 수 있으며, exception도 던질 수 있다.</span></span><br><span class="line">            es.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">int</span> idx = counter.addAndGet(<span class="number">1</span>);</span><br><span class="line">                log.info(<span class="string">"Thread &#123;&#125;"</span>, idx);</span><br><span class="line">                barrier.await();</span><br><span class="line"></span><br><span class="line">                StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">                sw.start();</span><br><span class="line"></span><br><span class="line">                String res = rt.getForObject(url, String.class, idx);</span><br><span class="line"></span><br><span class="line">                sw.stop();</span><br><span class="line">                log.info(<span class="string">"idx: &#123;&#125;, Elapsed: &#123;&#125; -&gt; res: &#123;&#125;"</span>, idx, sw.getTotalTimeSeconds(), res);</span><br><span class="line">                <span class="comment">// IDE가 funtional interface가 callable임을 인식할 수 있도록 의미없는 return을 넣어준다.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// await을 만난 스레드가 101번째가 될 때, 모든 스레드들도 await에서 풀려나 이후 로직을 수행한다. </span></span><br><span class="line">        <span class="comment">// 메인 스레드 1개, Executors.newFixedThreadPool로 생성한 스레드 100개</span></span><br><span class="line">        barrier.await();</span><br><span class="line">        StopWatch main = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        main.start();</span><br><span class="line"></span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="comment">// 지정된 시간이 타임아웃 걸리기 전이라면 대기작업이 진행될 때까지 기다린다.</span></span><br><span class="line">        <span class="comment">// (100초안에 작업이 끝날때까지 기다리거나, 100초가 초과되면 종료)</span></span><br><span class="line">        es.awaitTermination(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        main.stop();</span><br><span class="line">        log.info(<span class="string">"Total: &#123;&#125;"</span>, main.getTotalTimeSeconds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="외부-서비스-호출-테스트"><a href="#외부-서비스-호출-테스트" class="headerlink" title="외부 서비스 호출 테스트"></a>외부 서비스 호출 테스트</h1><p>클라이언트의 요청을 받아 외부 서비스를 호출하고 해당 결과를 이용해서 응답을 돌려주는 테스트를 진행합니다. 테스트를 진행하기 위해서는 2개의 스프링 애플리케이션이 필요합니다. 2개의 스프링 애플리케이션의 설정은 다음과 같습니다.</p>
<ul>
<li>Main Application<ul>
<li>port: 8080</li>
<li>tomcat-max-thread-count: 1</li>
</ul>
</li>
<li>Remote Application <ul>
<li>port: 8081</li>
<li>tomcat-max-thread-count: 1000</li>
</ul>
</li>
</ul>
<h2 id="main-application"><a href="#Main-Application" class="headerlink" title="Main Application"></a>Main Application</h2><p>먼저 하나의 스프링 애플리케이션에 컨트롤러를 하나 준비합니다. 이 컨트롤러는 클라이언트로부터 요청을 받아 해당 요청으로부터 받은 값을 이용해 다른 외부 서비스(<a href="http://localhost:8081/service?req={req})를" rel="external nofollow noopener noreferrer" target="_blank">http://localhost:8081/service?req={req})를</a> 호출합니다.</p>
<p><strong>결국 해당 서블릿은 클라이언트 요청을 처리하면서 외부 서비스로의 Networking I/O 작업을 수행하기 때문에 외부 서비스로부터의 요청에 대한 응답을 받기 전까지는 blocking 상태가 됩니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            String res = rt.getForObject(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);        </span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>application.properties</code> 파일에서 다음과 같이 Tomcat의 스레드 개수를 1개로 설정합니다.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.tomcat.max-threads=1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="remote-application"><a href="#Remote-Application" class="headerlink" title="Remote Application"></a>Remote Application</h2><p>다른 하나의 스프링 애플리케이션을 생성하고 이전에 만들었던 스프링 애플리케이션의 컨트롤러 내부에서 만들었던 요청을 받아 처리할 수 있도록 컨트롤러 추가합니다. 8080 포트가 아닌 8081 포트를 사용하고 tomcat 스레드를 1000개로 설정합니다. RemoteApplication은 application.properties의 값을 사용하게 하지 않고 직접 프로퍼티를 설정해줍니다. </p>
<p>아래와 같이 설정하면 Intellij를 이용해서 하나의 프로젝트에서 2개의 스프링 애플리케이션을 실행할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="결과-확인"><a href="#결과-확인" class="headerlink" title="결과 확인"></a>결과 확인</h2><p>MainApplication과 RemoteApplication을 각각 실행하고 Client를 이용한 테스트 결과는 다음과 같습니다.<br>100개의 클라이언트 요청을 처리하는데 0.4초 정도의 시간이 걸렸습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] INFO com.example.study.LoadTest - idx: <span class="number">40</span>, Elapsed: <span class="number">0.4</span> -&gt; res: hello40/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] INFO com.example.study.LoadTest - idx: <span class="number">77</span>, Elapsed: <span class="number">0.401</span> -&gt; res: hello77/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] INFO com.example.study.LoadTest - idx: <span class="number">48</span>, Elapsed: <span class="number">0.403</span> -&gt; res: hello48/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.546</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] INFO com.example.study.LoadTest - idx: <span class="number">8</span>, Elapsed: <span class="number">0.407</span> -&gt; res: hello8/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">0.409</span> -&gt; res: hello33/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">0.407</span></span><br></pre></td></tr></table></figure></p>
<p>이번에는 RemoteApplication의 요청 처리 부분에 2초간 Thread sleep을 주고 다시 한 번 클라이언트를 이용해 테스트를 진행해봅니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RemoteApplication</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Thread sleep을 추가하고 다시 테스트를 해보면 결과는 다음과 같습니다. 100개의 요청을 약 0.4초만에 모두 처리하던 이전과 달리 매 요청을 처리하는데 약 2초의 시간이 증가하고 있습니다. 결국 마지막 요청은 약 2 * 100 = 200초 후에서야 응답을 받을 수 있기 때문에 모든 요청에 대한 처리는 200초 정도 걸릴 것 입니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.056</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.058</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.061</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] INFO com.example.study.LoadTest - idx: <span class="number">32</span>, Elapsed: <span class="number">2.233</span> -&gt; res: hello32/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] INFO com.example.study.LoadTest - idx: <span class="number">56</span>, Elapsed: <span class="number">4.231</span> -&gt; res: hello56/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">6.238</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">8.249</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.081</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] INFO com.example.study.LoadTest - idx: <span class="number">20</span>, Elapsed: <span class="number">10.254</span> -&gt; res: hello20/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] INFO com.example.study.LoadTest - idx: <span class="number">46</span>, Elapsed: <span class="number">12.26</span> -&gt; res: hello46/service</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>이런 결과가 나오게 된 이유는 클라이언트로부터의 요청을 받아 처리하는 Main Application의 tomcat thread가 1개이고, 1개의 서블릿 스레드를 이용해 클라이언트의 요청을 처리하는 과정에서 Remote Application에 대한 요청(Network I/O)에서 응답을 받기까지 약 2초간 스레드가 block되기 때문입니다.</p>
<h1 id="asyncresttemplate"><a href="#AsyncRestTemplate" class="headerlink" title="AsyncRestTemplate"></a>AsyncRestTemplate</h1><p><strong>위의 문제는 MainApplication의 tomcat 스레드는 클라이언트의 요청을 처리하며 외부 서비스(RemoteApplication)로 요청(Network I/O)을 보낸 후, 응답이 올 때까지 대기하고 있는 상태라는 점입니다. 해당 시간동안 CPU는 아무 일을 처리하지 않기때문에 자원이 소모되고 있습니다.</strong></p>
<p><strong>이 문제를 해결하기 위해서는 API를 호출하는 작업을 비동기적으로 바꿔야합니다. tomcat 스레드는 요청에 대한 작업을 다 끝내기 전에 반환을 해서 바로 다음 요청을 처리하도록 사용합니다. 그리고 외부 서비스로부터 실제 결과를 받고 클라이언트의 요청에 응답을 보내기 위해서는 새로운 스레드를 할당 받아 사용합니다.</strong> (외부 서비스로부터 실제 결과를 받고 클라이언트에 응답을 보내기 위해서는 새로운 스레드를 할당 받아야 하지만, 외부 API를 호출하는 동안은 스레드(tomcat) 자원을 낭비하고 싶지 않다는 것이 목적이다.)</p>
<p>스프링 3.x 버전에서는 이 문제를 간단히 해결하기 어려웠지만 스프링 4 부터 제공하는 <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/AsyncRestTemplate.html" rel="external nofollow noopener noreferrer" target="_blank">AsyncRestTemplate</a>을 사용하면 이 문제를 쉽게 해결할 수 있습니다. <strong>AsyncRestTemplate은 비동기 클라이언트를 제공하는 클래스이며 ListenableFuture를 반환합니다. 스프링은 컨트롤러에서 ListenableFuture를 리턴하면 해당 스레드는 즉시 반납하고, 스프링 MVC가 자동으로 등록해준 콜백에 의해 결과가 처리됩니다.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>실행 결과를 살펴보면 100개의 요청을 동시에 처리하는데 약 2.6초의 시간이 걸렸습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.088</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.example.study.LoadTest - idx: <span class="number">4</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello4/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] INFO com.example.study.LoadTest - idx: <span class="number">44</span>, Elapsed: <span class="number">2.659</span> -&gt; res: hello44/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.095</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] INFO com.example.study.LoadTest - idx: <span class="number">66</span>, Elapsed: <span class="number">2.664</span> -&gt; res: hello66/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] INFO com.example.study.LoadTest - idx: <span class="number">16</span>, Elapsed: <span class="number">2.667</span> -&gt; res: hello16/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] INFO com.example.study.LoadTest - idx: <span class="number">57</span>, Elapsed: <span class="number">2.669</span> -&gt; res: hello57/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.example.study.LoadTest - idx: <span class="number">2</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello2/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] INFO com.example.study.LoadTest - idx: <span class="number">15</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello15/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.106</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.673</span></span><br></pre></td></tr></table></figure></p>
<p>클라이언트의 요청이 들어 올 때, MainApplication의 스레드 상태를 살펴보면, tomcat 스레드는 그대로 1개 입니다.(http-nio-8080-exec-1) 그러나 비동기 작업을 처리하기 위해서 순간적으로 백그라운드에 100개의 스레드 새로 생성되는것을 확인할 수 있습니다.<br><img src="/images/post/2019-04-13/async_rest_template_result.png" alt="async rest template result"></p>
<h1 id="netty-non-blocking-io"><a href="#Netty-non-blocking-I-O" class="headerlink" title="Netty non-blocking I/O"></a>Netty non-blocking I/O</h1><p>지금까지 Tomcat의 스레드가 1개이지만 요청을 비동기적으로 처리함으로써 Tomcat의 스레드는 바로 반환이되어 다시 그 후의 요청에 Tomcat의 스레드를 이용해 요청을 받을 수 있었습니다. 그러나 결과적으로는 실제 비동기 요청을 처리하는 스레드는 요청의 수 만큼 계속 생성되는 것을 확인할 수 있었습니다.</p>
<p>이번에는 이렇게 <strong>비동기 요청을 처리하는 스레드의 수도 Netty의 non blocking I/O를 이용함으로써 비동기 요청을 처리하는 스레드도 줄여보고자 합니다.</strong> 그러면 결과적으로 tomcat의 스레드 1개, netty의 non blocking I/O를 이용하기위한 필요한 스레드의 수만큼만 생성되어 클라이언트의 요청을 모두 처리할 수 있을 것 입니다.</p>
<p>먼저 netty의 dependency를 build.gradle 혹은 pom.xml에 추가합니다. 저는 build.gradle에 의존성을 추가해 주었습니다.<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation <span class="string">'io.netty:netty-all:4.0.4.Final'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AsyncRestTemplate이 netty의 Netty4ClientHttpRequestFactory를 이용할 수 있도록 다음과 같이 설정합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>다시 서버를 띄우고 테스트를 해보면 클라이언트의 요청을 전부 처리하는데 걸린 시간은 약 2.7초로 이전과 큰 차이가 없습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] INFO com.example.study.LoadTest - idx: <span class="number">65</span>, Elapsed: <span class="number">2.744</span> -&gt; res: hello65/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] INFO com.example.study.LoadTest - idx: <span class="number">59</span>, Elapsed: <span class="number">2.751</span> -&gt; res: hello59/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">2.752</span> -&gt; res: hello14/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">2.754</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] INFO com.example.study.LoadTest - idx: <span class="number">63</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello63/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] INFO com.example.study.LoadTest - idx: <span class="number">19</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello19/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] INFO com.example.study.LoadTest - idx: <span class="number">62</span>, Elapsed: <span class="number">2.756</span> -&gt; res: hello62/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.755</span></span><br></pre></td></tr></table></figure></p>
<p>스레드를 확인해보면 다음과 같이 tomcat 스레드 1개, netty가 non blocking I/O를 사용하는데 필요로 하는 몇개의 스레드가 추가된 것 말고는 스레드 수가 크게 증가하지 않은것을 확인할 수 있습니다.<br><img src="/images/post/2019-04-13/netty_nio_result.png" alt="async rest template result"></p>
<h1 id="deferredresult"><a href="#DeferredResult" class="headerlink" title="DeferredResult"></a>DeferredResult</h1><p>이전 포스팅에서 살펴 보았던 <strong>DeferredResult를 사용하면 AsyncRestTemplate을 사용하여 외부 서비스를 호출한 후, 그 결과를 다시 이용해 클라이언트의 요청에 응답하는 추가 로직 부분을 작성할 수 있습니다.</strong></p>
<p>컨트롤러에서 DeferredResult 오브젝트를 반환하는 시점에는 바로 응답이 가지 않고, 추후 해당 DeferredResult 오브젝트에 값을 set(setResult, setErrorResult) 해줄 때, 클라이언트에게 응답이 가게 됩니다. 이를 이용하려면 ListenableFuture에 콜백을 추가해 해당 콜백 로직 안에서 결과를 이용해 DeferredResult 오브젝트의 set 메서드를 호출하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                dr.setResult(s.getBody() + <span class="string">"/work"</span>);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>외부 서비스의 응답을 받아 “/work” 문자열이 추가되어 클라이언트에 전달된것을 확인할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello33/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] INFO com.example.study.LoadTest - idx: <span class="number">79</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello79/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] INFO com.example.study.LoadTest - idx: <span class="number">80</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello80/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] INFO com.example.study.LoadTest - idx: <span class="number">9</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello9/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello60/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] INFO com.example.study.LoadTest - idx: <span class="number">98</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello98/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.346</span></span><br></pre></td></tr></table></figure></p>
<h1 id="중첩된-remote-service-사용"><a href="#중첩된-Remote-Service-사용" class="headerlink" title="중첩된 Remote Service 사용"></a>중첩된 Remote Service 사용</h1><p>이번에는 외부 서비스를 하나 더 추가해보겠습니다. 외부 서비스의 요청에 대한 결과를 다시 다른 서비스를 호출하는 요청의 파라미터로 사용하면서 콜백의 구조가 복잡해지는 문제가 생기게 되었습니다. 이런 문제를 <strong>콜백 헬</strong>이라고 합니다.</p>
<p>다음번 포스팅에서는 콜백 헬을 해결할 수 있는 방법에 대해서 알아보도록 하겠습니다.</p>
<h2 id="remote-application"><a href="#Remote-Application-1" class="headerlink" title="Remote Application"></a>Remote Application</h2><p>“/service2”를 추가합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service2"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service2</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service2"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="main-application"><a href="#Main-Application-1" class="headerlink" title="Main Application"></a>Main Application</h2><p>“/service”를 호출한 결과를 이용해 “/service2”를 호출하도록 합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>, String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity(<span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>, String.class, s.getBody());</span><br><span class="line">                f2.addCallback(s2 -&gt; &#123;</span><br><span class="line">                    dr.setResult(s2.getBody());</span><br><span class="line">                &#125;, e -&gt; &#123;</span><br><span class="line">                    dr.setErrorResult(e.getMessage());</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="결과-확인"><a href="#결과-확인-1" class="headerlink" title="결과 확인"></a>결과 확인</h2><p>100개의 클라이언트 요청을 처리하는데 약 4.3초의 시간이 걸렸습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] INFO com.example.study.LoadTest - idx: <span class="number">17</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello17/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] INFO com.example.study.LoadTest - idx: <span class="number">87</span>, Elapsed: <span class="number">4.337</span> -&gt; res: hello87/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello14/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] INFO com.example.study.LoadTest - idx: <span class="number">74</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello74/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello60/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] INFO com.example.study.LoadTest - idx: <span class="number">38</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello38/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] INFO com.example.study.LoadTest - idx: <span class="number">78</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello78/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.example.study.LoadTest - idx: <span class="number">5</span>, Elapsed: <span class="number">4.342</span> -&gt; res: hello5/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">4.338</span></span><br></pre></td></tr></table></figure>
        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-03-31T11:22:00.000Z">2019-03-31</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    38분 읽기 (대략 5658 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/03/31/Java/java-async-1/">자바와 스프링의 비동기 기술</a>
            
        </h1>
        <div class="content">
            <p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=aSTuQiPB4Ns&amp;index=7&amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC" rel="external nofollow noopener noreferrer" target="_blank">토비의 봄 TV 8회 스프링 리액티브 프로그래밍 (4) 자바와 스프링의 비동기 기술</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p>
<p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p>
<h1 id="자바의-비동기-기술"><a href="#자바의-비동기-기술" class="headerlink" title="자바의 비동기 기술"></a>자바의 비동기 기술</h1><h2 id="executorservice"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h2><p><strong><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html" rel="external nofollow noopener noreferrer" target="_blank">ExecutorService</a></strong>는 쉽게 비동기로 작업을 실행할 수 있도록 도와주는 JDK(1.5부터)에서 제공하는 interface입니다. 일반적으로 ExecutorService는 작업 할당을 위한 스레드 풀과 API를 제공합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        es.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">20</span>:<span class="number">35</span>:<span class="number">53.892</span> [main] INFO com.example.study.FutureEx - Exit</span><br><span class="line"><span class="number">20</span>:<span class="number">35</span>:<span class="number">55.888</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br></pre></td></tr></table></figure>
<h2 id="future"><a href="#Future" class="headerlink" title="Future"></a>Future</h2><p><strong><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html" rel="external nofollow noopener noreferrer" target="_blank">Future</a>는 자바 1.5에서 등장한 비동기 계산의 결과를 나타내는 Interface 입니다.</strong> </p>
<p><strong>비동기적인 작업을 수행한다는 것은 현재 진행하고 있는 스레드가 아닌 별도의 스레드에서 작업을 수행하는 것을 말합니다.</strong> 같은 스레드에서 메서드를 호출할 때는 결과를 리턴 값을 받지만, 비동기적으로 작업을 수행할 때는 결과값을 전달받을 수 있는 무언가의 interface가 필요한데 Future가 그 역할을 합니다.</p>
<p><strong>비동기 작업에서 결과를 반환하고 싶을 때는 runnable대신 callable interface를 이용하면 결과 값을 return 할 수 있습니다.</strong> 또한 예외가 발생했을 때 해당 예외를 비동기 코드를 처리하는 스레드 안에서 처리하지 않고 밖으로 던질 수 있습니다. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        Future&lt;String&gt; f = es.submit(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.info(f.get());</span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">20</span>:<span class="number">43</span>:<span class="number">11.704</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">20</span>:<span class="number">43</span>:<span class="number">11.706</span> [main] INFO com.example.study.FutureEx - Hello</span><br><span class="line"><span class="number">20</span>:<span class="number">43</span>:<span class="number">11.706</span> [main] INFO com.example.study.FutureEx - Exit</span><br></pre></td></tr></table></figure>
<p><strong>Future를 통해서 비동기 결과의 값을 가져올 때는 get 메서드를 사용합니다.</strong> 그러나 get 메서드를 호출하게 되면 비동기 작업이 완료될 때까지 해당 스레드가 blocking됩니다.</p>
<p>Future는 비동기적인 연산 혹은 작업을 수행하고 그 결과를 갖고 있으며, 완료를 기다리고 계산 결과를 반환(get)하는 메소드와 그 외에도 해당 연산이 완료되었는지 확인하는(isDone) 메소드를 제공합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        Future&lt;String&gt; f = es.submit(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        log.info(f.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">00.501</span> [main] INFO com.example.study.FutureEx - <span class="keyword">false</span></span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.502</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.509</span> [main] INFO com.example.study.FutureEx - Exit</span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.509</span> [main] INFO com.example.study.FutureEx - <span class="keyword">true</span></span><br><span class="line"><span class="number">00</span>:<span class="number">26</span>:<span class="number">02.509</span> [main] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure>
<h2 id="futuretask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h2><p><strong><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/FutureTask.html" rel="external nofollow noopener noreferrer" target="_blank">FutureTask</a></strong>는 비동기 작업을 생성합니다. 지금까지 위의 코드는 비동기 작업 생성과 실행을 동시에 했다면 FutureTask는 비동기 작업 생성과 실행을 분리하여 진행할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        FutureTask&lt;String&gt; f = <span class="keyword">new</span> FutureTask&lt;&gt;(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line"></span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        log.info(<span class="string">"Exit"</span>);</span><br><span class="line">        log.info(String.valueOf(f.isDone()));</span><br><span class="line">        log.info(f.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">39.459</span> [main] INFO com.example.study.FutureEx - <span class="keyword">false</span></span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.461</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.467</span> [main] INFO com.example.study.FutureEx - Exit</span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.467</span> [main] INFO com.example.study.FutureEx - <span class="keyword">true</span></span><br><span class="line"><span class="number">00</span>:<span class="number">28</span>:<span class="number">41.467</span> [main] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure>
<p><strong>비동기 작업의 결과를 가져오는 방법은 Future와 같은 결과를 다루는 <code>handler</code>를 이용하거나 <code>callback</code>을 이용하는 2가지 방법이 있습니다.</strong><br>아래의 예시 코드는 FutureTask의 비동기 작업이 완료될 경우 호출되는 done() 메서드를 재정의하여 callback을 이용하는 방법입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        FutureTask&lt;String&gt; f = <span class="keyword">new</span> FutureTask&lt;String&gt;(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.done();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(get());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line">        es.shutdown();</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">"EXIT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">01</span>:<span class="number">03</span>:<span class="number">04.153</span> [main] INFO com.example.study.FutureEx - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">03</span>:<span class="number">06.153</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">01</span>:<span class="number">03</span>:<span class="number">06.153</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure>
<p>위 예시 코드의 callback 관련 부분을 FutureTask를 상속받아 done() 메서드를 재정의함으로써, 비동기 코드와 그 결과를 갖고 작업을 수행하는 callback을 좀 더 가독성이 좋게 작성할 수 있습니다. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">SuccessCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackFutureTask</span> <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        SuccessCallback sc;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CallbackFutureTask</span><span class="params">(Callable&lt;String&gt; callable, SuccessCallback sc)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(callable);</span><br><span class="line">            <span class="keyword">this</span>.sc = Objects.requireNonNull(sc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.done();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.sc.onSuccess(get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        CallbackFutureTask f = <span class="keyword">new</span> CallbackFutureTask(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;, log::info);</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">01</span>:<span class="number">05</span>:<span class="number">01.978</span> [main] INFO com.example.study.FutureEx - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">05</span>:<span class="number">03.977</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Async</span><br><span class="line"><span class="number">01</span>:<span class="number">05</span>:<span class="number">03.978</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Hello</span><br></pre></td></tr></table></figure>
<p>위 예시 코드에 SuccessCallback을 추가한 것처럼 ExceptionCallback을 추가하여 비동기 코드에서 예외가 발생할 경우, 해당 예외를 처리하는 callback도 추가할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureEx</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">SuccessCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ExceptionCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackFutureTask</span> <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        SuccessCallback sc;</span><br><span class="line">        ExceptionCallback ec;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CallbackFutureTask</span><span class="params">(Callable&lt;String&gt; callable, SuccessCallback sc, ExceptionCallback ec)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(callable);</span><br><span class="line">            <span class="keyword">this</span>.sc = Objects.requireNonNull(sc);</span><br><span class="line">            <span class="keyword">this</span>.ec = Objects.requireNonNull(ec);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.done();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.sc.onSuccess(get());</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 InterruptedException은 예외긴 예외이지만, 현재 작업을 수행하지 말고 중단해라 라고 메시지를 보내는 용도이다.</span></span><br><span class="line"><span class="comment">                 따라서 현재 스레드에 interrupt를 체크하고 종료한다.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                <span class="comment">// 래핑된 에러를 빼내어 전달한다.</span></span><br><span class="line">                ec.onError(e.getCause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        CallbackFutureTask f = <span class="keyword">new</span> CallbackFutureTask(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> == <span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Async ERROR!!!"</span>);</span><br><span class="line">            log.info(<span class="string">"Async"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">                s -&gt; log.info(<span class="string">"Result: &#123;&#125;"</span>, s),</span><br><span class="line">                e -&gt; log.info(<span class="string">"Error: &#123;&#125;"</span>, e.getMessage()));</span><br><span class="line"></span><br><span class="line">        es.execute(f);</span><br><span class="line">        es.shutdown();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"EXIT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">01</span>:<span class="number">11</span>:<span class="number">53.460</span> [main] INFO com.example.study.FutureEx - EXIT</span><br><span class="line"><span class="number">01</span>:<span class="number">11</span>:<span class="number">55.463</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.example.study.FutureEx - Error: Async ERROR!!!</span><br></pre></td></tr></table></figure>
<h1 id="스프링의-비동기-기술"><a href="#스프링의-비동기-기술" class="headerlink" title="스프링의 비동기 기술"></a>스프링의 비동기 기술</h1><h2 id="async"><a href="#Async" class="headerlink" title="@Async"></a>@Async</h2><p>Spring MVC 3.2 부터 Servlet 3.0 기반의 비동기 요청 처리가 가능해졌습니다. <strong><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/scheduling/annotation/Async.html" rel="external nofollow noopener noreferrer" target="_blank">@Async</a> 어노테이션을 추가해 해당 메서드를 비동기적으로 호출할 수 있습니다.</strong> 해당 메서드를 호출한 호출자(caller)는 즉시 리턴하고 메소드의 실제 실행은 Spring TaskExecutor에 의해서 실행됩니다. 비동기로 실행되는 메서드는 Future 형식의 값을 리턴하고, 호출자는 해당 Future의 get() 메서드를 호출하기 전에 다른 작업을 수행할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         내부적으로 AOP를 이용해 복잡한 로직이 실행된다.</span></span><br><span class="line"><span class="comment">         비동기 작업은 return값으로 바로 결과를 줄 수 없다. (Future 혹은 Callback을 이용해야 한다.)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"hello()"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// try with resource 블록을 이용해 빈이 다 준비된 후 종료되도록 설정</span></span><br><span class="line">        <span class="keyword">try</span> (ConfigurableApplicationContext c = SpringApplication.run(StudyApplication.class, args)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 모든 빈이 다 준비된 후 실행됨 (현재는 일종의 컨트롤러라고 생각)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ApplicationRunner <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"run()"</span>);</span><br><span class="line">            Future&lt;String&gt; res = myService.hello();</span><br><span class="line">            log.info(<span class="string">"exit: &#123;&#125;"</span>, res.isDone());</span><br><span class="line">            log.info(<span class="string">"result: &#123;&#125;"</span>, res.get());</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">31.960</span>  INFO <span class="number">41618</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">31.960</span>  INFO <span class="number">41618</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">928</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">32.161</span>  INFO <span class="number">41618</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">32.337</span>  INFO <span class="number">41618</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.341  INFO 41618 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 1.631 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.101</span>)</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.343  INFO 41618 --- [           main] com.example.study.StudyApplication       : <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.346  INFO 41618 --- [           main] com.example.study.StudyApplication       : exit: <span class="keyword">false</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:32.350  INFO 41618 --- [         task-1] com.example.study.StudyApplication       : <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:29:33.351  INFO 41618 --- [           main] com.example.study.StudyApplication       : result: Hello</span></span><br><span class="line"><span class="function">2019-04-04 23:29:33.354  INFO 41618 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'</span></span><br></pre></td></tr></table></figure>
<h2 id="listenablefuture"><a href="#ListenableFuture" class="headerlink" title="ListenableFuture"></a>ListenableFuture</h2><p>스프링 4.0 부터 제공하는 Future 인터페이스를 확장한 <strong><a href="https://docs.spring.io/autorepo/docs/spring-framework/4.0.5.RELEASE/javadoc-api/org/springframework/util/concurrent/ListenableFuture.html" rel="external nofollow noopener noreferrer" target="_blank">ListenableFuture</a>를 이용하면 비동기 처리의 결과 값을 사용할 수 있는 callback을 추가할 수 있습니다.</strong><br>@Async 어노테이션을 사용하는 메서드에서 스프링 4.1 부터 제공하는 ListenableFuture 인터페이스를 구현한 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/AsyncResult.html" rel="external nofollow noopener noreferrer" target="_blank">AsyncResult</a>를 반환하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"hello()"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// try with resource 블록을 이용해 빈이 다 준비된 후 종료되도록 설정</span></span><br><span class="line">        <span class="keyword">try</span> (ConfigurableApplicationContext c = SpringApplication.run(StudyApplication.class, args)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ApplicationRunner <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"run()"</span>);</span><br><span class="line">            ListenableFuture&lt;String&gt; f = myService.hello();</span><br><span class="line">            f.addCallback(s -&gt; log.info(s), e-&gt; log.info(e.getMessage()));</span><br><span class="line">            log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.348</span>  INFO <span class="number">44559</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.348</span>  INFO <span class="number">44559</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">959</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.557</span>  INFO <span class="number">44559</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">46.736</span>  INFO <span class="number">44559</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.740  INFO 44559 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 1.779 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.306</span>)</span></span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.742  INFO 44559 --- [           main] com.example.study.StudyApplication       : <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.748  INFO 44559 --- [           main] com.example.study.StudyApplication       : exit</span></span><br><span class="line"><span class="function">2019-04-04 23:42:46.751  INFO 44559 --- [         task-1] com.example.study.StudyApplication       : <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-04 23:42:47.752  INFO 44559 --- [         task-1] com.example.study.StudyApplication       : Hello</span></span><br><span class="line"><span class="function">2019-04-04 23:42:48.757  INFO 44559 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'</span></span><br></pre></td></tr></table></figure>
<h2 id="threadpooltaskexecutor"><a href="#ThreadPoolTaskExecutor" class="headerlink" title="ThreadPoolTaskExecutor"></a>ThreadPoolTaskExecutor</h2><p><strong>@Async 어노테이션을 사용해 해당 메서드를 비동기적으로 호출할 경우 ThreadPool을 명시적으로 선언하지 않으면, 기본적으로 <a href="https://docs.spring.io/spring/docs/3.1.x/javadoc-api/org/springframework/core/task/SimpleAsyncTaskExecutor.html" rel="external nofollow noopener noreferrer" target="_blank">SimpleAsyncTaskExecutor</a>를 사용합니다.</strong> SimpleAsyncTaskExecutor는 각 비동기 호출마다 계속 새로운 스레드를 만들어 사용하기 때문에 비효율적입니다. 이 경우 ThreadPoolTaskExecutor를 직접 만들어 사용하는게 효율적입니다.</p>
<p><strong><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html" rel="external nofollow noopener noreferrer" target="_blank">ThreadPoolTaskExecutor</a>는 CorePool, QueueCapacity, MaxPoolSize를 직접 설정할 수 있습니다.</strong> 각 값에 대한 설명은 코드에 추가했습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         기본적으로 SimpleAsyncTaskExecutor를 사용한다. 스레드를 계속 새로 만들어 사용하기 때문에 비효율적이다.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Async</span></span><br><span class="line">        <span class="comment">// @Async("tp") ThreadPool이 여러개일 경우 직접 지정 가능하다.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"hello()"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ThreadPoolTaskExecutor <span class="title">tp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        <span class="comment">// 1) 스레드 풀을 해당 개수까지 기본적으로 생성함. 처음 요청이 들어올 때 poll size만큼 생성한다.</span></span><br><span class="line">        te.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 2) 지금 당장은 Core 스레드를 모두 사용중일때, 큐에 만들어 대기시킨다.</span></span><br><span class="line">        te.setQueueCapacity(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">// 3) 대기하는 작업이 큐에 꽉 찰 경우, 풀을 해당 개수까지 더 생성한다.</span></span><br><span class="line">        te.setMaxPoolSize(<span class="number">100</span>);</span><br><span class="line">        te.setThreadNamePrefix(<span class="string">"myThread"</span>);</span><br><span class="line">        <span class="keyword">return</span> te;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// try with resource 블록을 이용해 빈이 다 준비된 후 종료되도록 설정</span></span><br><span class="line">        <span class="keyword">try</span> (ConfigurableApplicationContext c = SpringApplication.run(StudyApplication.class, args)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 모든 빈이 다 준비된 후 실행됨 (현재는 일종의 컨트롤러라고 생각)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">ApplicationRunner <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"run()"</span>);</span><br><span class="line">            ListenableFuture&lt;String&gt; f = myService.hello();</span><br><span class="line">            f.addCallback(s -&gt; log.info(s), e-&gt; log.info(e.getMessage()));</span><br><span class="line">            log.info(<span class="string">"exit"</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.304</span>  INFO <span class="number">47863</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.304</span>  INFO <span class="number">47863</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">1061</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.367</span>  INFO <span class="number">47863</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'tp'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">11.677</span>  INFO <span class="number">47863</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.680  INFO 47863 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 1.751 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.208</span>)</span></span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.681  INFO 47863 --- [           main] com.example.study.StudyApplication       : <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.686  INFO 47863 --- [           main] com.example.study.StudyApplication       : exit</span></span><br><span class="line"><span class="function">2019-04-05 00:03:11.687  INFO 47863 --- [      myThread1] com.example.study.StudyApplication       : <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">2019-04-05 00:03:12.691  INFO 47863 --- [      myThread1] com.example.study.StudyApplication       : Hello</span></span><br></pre></td></tr></table></figure>
<h2 id="servlet-async"><a href="#Servlet-Async" class="headerlink" title="Servlet Async"></a>Servlet Async</h2><p>@Async 어노테이션을 설명할 때 말했던 것처럼, Spring MVC 3.2 부터 Servlet 3.0 기반의 비동기 요청 처리가 가능해졌습니다. <strong>기존 Controller 메서드를 <a href="https://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Callable.html" rel="external nofollow noopener noreferrer" target="_blank">Callable</a>로 변경함으로써 비동기로 만들 수 있습니다.</strong><br>Controller 메서드를 비동기로 변경해도 해당 처리가 서블릿 스레드가 아닌 다른 스레드에서 발생한다는 점을 제외하면 기존 Controller 메서드의 동작 방식과는 큰 차이가 없습니다.<br>(참고 : <a href="https://spring.io/blog/2012/05/10/spring-mvc-3-2-preview-making-a-controller-method-asynchronous" rel="external nofollow noopener noreferrer" target="_blank">Spring MVC 3.2 Preview: Making a Controller Method Asynchronous</a>)</p>
<blockquote>
<p>Servlet 3.0 &amp; 3.1</p>
<ul>
<li>Servlet 3.0: 비동기 서블릿<ul>
<li>HTTP connection은 이미 논블록킹 IO</li>
<li>서블릿 요청 읽기, 응답 쓰기는 블록킹</li>
<li>비동기 작업 시작 즉시 서블릿 스레드 반납</li>
<li>비동기 작업이 완료되면 서블릿 스레드 재할당</li>
<li>비동기 서블릿 컨텍스트 이용 (AsyncContext)</li>
</ul>
</li>
<li>Servlet 3.1: 논블록킹 IO<ul>
<li>논블록킹 서블릿 요청, 응답 처리</li>
<li>Callback</li>
</ul>
</li>
</ul>
<p>스레드가 블록되는 상황은 CPU와 메모리 자원을 많이 소모합니다. 컨텍스트 스위칭이 일어나기 때문입니다. 기본적으로 스레드가 블로킹되면 wating 상태로 변경되면서 컨텍스트 스위칭이 일어나고 추후 I/O 작업이 끝나 running 상태로 변경되면서 다시 컨텍스트 스위칭이 일어나 총 2번의 컨텍스트 스위칭이 일어납니다.<br>Java InputStream과 OutputStream은 블록킹 방식이다. RequestHttpServletRequest, RequestHttpServletResponse는 InputSream과 OutputStream을 사용하기 때문에 서블릿은 기본적으로 블로킹 IO 방식이다.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/callable"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">callable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            log.info(<span class="string">"callable"</span>);</span><br><span class="line">            <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">"async"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 결과</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">41.761</span>  INFO <span class="number">69216</span> --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">41.762</span>  INFO <span class="number">69216</span> --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in <span class="number">1206</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">41.993</span>  INFO <span class="number">69216</span> --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">01</span>:<span class="number">12</span>:<span class="number">42.182</span>  INFO <span class="number">69216</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2019-04-06 01:12:42.186  INFO 69216 --- [           main] com.example.study.StudyApplication       : Started StudyApplication in 2.073 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.807</span>)</span></span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.161  INFO 69216 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.162  INFO 69216 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.169  INFO 69216 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 7 ms</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.190  INFO 69216 --- [nio-8080-exec-1] com.example.study.StudyApplication       : callable</span></span><br><span class="line"><span class="function">2019-04-06 01:12:44.198  INFO 69216 --- [         task-1] com.example.study.StudyApplication       : async</span></span><br></pre></td></tr></table></figure>
<p>실제로 비동기 서블릿은 아래의 그림처럼 동작합니다.<br><img src="/images/post/2019-03-31/async_servlet_structure.png" alt="비동기 서블릿 구조"></p>
<h3 id="client-for-load-test"><a href="#Client-For-Load-Test" class="headerlink" title="Client (For Load Test)"></a>Client (For Load Test)</h3><p>지금부터는 Spring에서 Sync Servlet을 이용할 때와 Async Servlet을 이용했을 때의 차이점을 알아보기 위해 테스트를 할 수 있도록, 먼저 여러 Request를 동시에 생성하는 Client를 작성해봅니다.<br>Spring에서 제공하는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html" rel="external nofollow noopener noreferrer" target="_blank">RestTemplate</a>을 이용해 100개의 Request를 동시에 호출합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/callable"</span>;</span><br><span class="line"></span><br><span class="line">        StopWatch main = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        main.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            es.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">int</span> idx = counter.addAndGet(<span class="number">1</span>);</span><br><span class="line">                log.info(<span class="string">"Thread &#123;&#125;"</span>, idx);</span><br><span class="line"></span><br><span class="line">                StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">                sw.start();</span><br><span class="line"></span><br><span class="line">                rt.getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">                sw.stop();</span><br><span class="line">                log.info(<span class="string">"Elapsed: &#123;&#125; -&gt; &#123;&#125;"</span>, idx, sw.getTotalTimeSeconds());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="comment">// 지정된 시간이 타임아웃 걸리기 전이라면 대기작업이 진행될 때까지 기다린다.</span></span><br><span class="line">        <span class="comment">// (100초안에 작업이 끝날때까지 기다리거나, 100초가 초과되면 종료)</span></span><br><span class="line">        es.awaitTermination(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        main.stop();</span><br><span class="line">        log.info(<span class="string">"Total: &#123;&#125;"</span>, main.getTotalTimeSeconds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="change-tomcat-thread-count"><a href="#Change-Tomcat-Thread-Count" class="headerlink" title="Change Tomcat Thread Count"></a>Change Tomcat Thread Count</h3><p><strong>위의 비동기 서블릿 그림에서 볼 수 있듯이, Async Servlet은 클라이언트로부터 요청을 받은 후 실제 작업은 작업 스레드 풀에 위임하고 현재의 서블릿 스레드는 서블릿 스레드 풀에 반환 후, 다음 요청이 들어올 경우 사용할 수 있도록 합니다. 이에 반해, Sync Servlet은 요청을 받은 서블릿 스레드에서 실제 작업까지 전부 진행하기 때문에 요청에 대한 응답을 반환하기 전까지는 새로운 요청을 처리할 수 없는 상태입니다.</strong></p>
<p>실제 이처럼 동작하는지 확인하기 위해서 <code>application.properties</code> 파일에서 다음과 같이 Tomcat의 스레드 개수를 1개로 설정합니다.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.tomcat.max-threads=1</span></span><br></pre></td></tr></table></figure></p>
<h3 id="sync-vs-async"><a href="#Sync-vs-Async" class="headerlink" title="Sync vs Async"></a>Sync vs Async</h3><h4 id="sync"><a href="#Sync" class="headerlink" title="Sync"></a>Sync</h4><p>먼저 아래와 같이 Sync Servlet을 이용해 서버를 띄운 후 위의 Client 코드를 이용해 테스트를 진행합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/callable"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">callable</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            log.info(<span class="string">"sync"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 서버를 띄우고 Client(LoadTest) 코드를 사용해 테스트를 진행하면 결과는 다음과 같습니다. Tomcat의 스레드가 하나이며 Sync 방식으로 동작하기 때문에 한 번에 하나의 클라이언트 요청만 처리할 수 있습니다. 서버 로그를 확인하면 <strong>nio-8080-exec-1</strong> 라는 이름을 가진 한개의 스레드가 요청을 처리하고 있습니다.<br><img src="/images/post/2019-03-31/sync_servlet.png" alt="동기 서블릿 테스트 결과"></p>
<p>이번에는 <code>JMC(Java Mission Control)</code>를 이용해 실제 서버의 스레드 상황을 살펴보겠습니다.</p>
<blockquote>
<p>JMC를 이용하기 위해서는 서버를 실행할 때 다음과 같은 JVM 옵션을 추가합니다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockCommercialFeatures</span><br><span class="line">-XX:+FlightRecorder</span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span></span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span></span><br><span class="line">-Djava.rmi.server.hostname=localhost</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>JMC를 이용해 클라이언트 요청이 들어올 때, Thread 상태를 보면 다음과 같습니다. 동시에 100개의 클라이언트 요청이 들어왔지만, 스레드 수는 그대로 유지되고 있으며, 여러 스레드 목록 중에 <strong>nio-8080-exec-1</strong> 스레드가 존재하고 있는것을 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/sync_servlet_thread.png" alt="동기 서블릿 테스트 결과 - 스레드"></p>
<h4 id="async"><a href="#Async-1" class="headerlink" title="Async"></a>Async</h4><p>이번에는 서버 코드를 아래와 같이 Async Servlet을 이용하도록 수정한 후 서버를 띄워 Client 코드를 이용해 테스트를 진행합니다. (작업 스레드 풀은 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.html" rel="external nofollow noopener noreferrer" target="_blank">WebMvcConfigurer</a>를 통해 설정해줍니다.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/callable"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">callable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">"async"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">WebMvcConfigurer <span class="title">configurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="comment">// 워커 스레드 풀 설정</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAsyncSupport</span><span class="params">(AsyncSupportConfigurer configurer)</span> </span>&#123;</span><br><span class="line">                ThreadPoolTaskExecutor te = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">                te.setCorePoolSize(<span class="number">100</span>);</span><br><span class="line">                te.setQueueCapacity(<span class="number">50</span>);</span><br><span class="line">                te.setMaxPoolSize(<span class="number">200</span>);</span><br><span class="line">                te.setThreadNamePrefix(<span class="string">"workThread"</span>);</span><br><span class="line">                te.initialize();</span><br><span class="line">                configurer.setTaskExecutor(te);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client(LoadTest) 코드를 사용해 테스트를 진행하면 결과는 다음과 같습니다. Tomcat의 스레드가 하나이지만 Async 방식으로 동작하기 때문에 해당 요청에 대한 실제 처리는 워커 스레드 풀에서 사용되고 있지 않은 스레드를 이용해 처리합니다. 서버 로그를 확인하면 <strong>nio-8080-exec-1</strong> 라는 이름을 가진 한개의 Tomcat 스레드와 <strong>workThreadX</strong>라는 이름을 가진 100개의 워커 스레드를 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/async_servlet.png" alt="비동기 서블릿 테스트 결과"></p>
<p>이번에도 역시 <code>JMC(Java Mission Control)</code>를 이용해 실제 서버의 스레드 상황을 살펴보겠습니다.</p>
<p><strong>nio-8080-exec-1</strong> 라는 이름을 가진 한개의 Tomcat 스레드와 <strong>workThreadX</strong>라는 이름을 가진 100개의 워커 스레드를 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/async_servlet_thread.png" alt="비동기 서블릿 테스트 결과 - 스레드"></p>
<h3 id="deferredresult"><a href="#DeferredResult" class="headerlink" title="DeferredResult"></a>DeferredResult</h3><p><strong><a href="https://docs.spring.io/spring/docs/5.0.4.BUILD-SNAPSHOT/javadoc-api/org/springframework/web/context/request/async/DeferredResult.html" rel="external nofollow noopener noreferrer" target="_blank">DeferredResult</a>는 Spring 3.2 부터 사용 가능합니다.</strong> 비동기 요청 처리를 위해 사용하는 Callable의 대안을 제공합니다. “지연된 결과”를 의미하며 외부의 이벤트 혹은 클라이언트 요청에 의해서 지연되어 있는 HTTP 요청에 대한 응답을 나중에 써줄 수 있는 기술입니다. <strong>별도로 워커 스레드를 만들어 대기하지 않고도 처리가 가능합니다.</strong></p>
<p><img src="/images/post/2019-03-31/deferredresult_structure.png" alt="DeferredResult 구조"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">        Queue&lt;DeferredResult&lt;String&gt;&gt; results = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/dr"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">dr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            log.info(<span class="string">"dr"</span>);</span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">            results.add(dr);</span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/dr/count"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">drCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(results.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/dr/event"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">drEvent</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (DeferredResult&lt;String&gt; dr : results) &#123;</span><br><span class="line">                dr.setResult(<span class="string">"Hello "</span> + msg);</span><br><span class="line">                results.remove(dr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LoadTest 코드를 이용해 /dr로 100개의 요청을 보내고, 크롬에서 /dr/count로 DeferredResult가 담겨있는 큐의 사이즈를 확인해봅니다. 그리고 마지막으로 /dr/event로 큐에 담긴 DeferredResult 객체에 setResult로 결과를 반환합니다.<br>100개의 요청이 동시에 완료되는 것을 확인할 수 있습니다.<br><img src="/images/post/2019-03-31/deferredresult.png" alt="DeferredResult 결과"></p>
<h3 id="responsebodyemitter"><a href="#ResponseBodyEmitter" class="headerlink" title="ResponseBodyEmitter"></a>ResponseBodyEmitter</h3><p><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/ResponseBodyEmitter.html" rel="external nofollow noopener noreferrer" target="_blank">ResponseBodyEmitter</a>는 Spring 4.2 부터 사용 가능합니다. <strong>비동기 요청 처리의 결과로 하나 이상의 응답을 위해 사용되는 리턴 값 Type 입니다.</strong> DeferredResult가 하나의 결과를 생성해 요청을 처리했다면, ResponseBodyEmitter는 여러개의 결과를 만들어 요청을 처리할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/emitter"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ResponseBodyEmitter <span class="title">emitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ResponseBodyEmitter emitter = <span class="keyword">new</span> ResponseBodyEmitter();</span><br><span class="line"></span><br><span class="line">            Executors.newSingleThreadExecutor().submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">                        emitter.send(<span class="string">"&lt;p&gt;Stream "</span> + i + <span class="string">"&lt;/p&gt;"</span>);</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> emitter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StudyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/post/2019-03-31/emitter_1.png" alt="ResponseBodyEmitter 결과_1"><br><img src="/images/post/2019-03-31/emitter_2.png" alt="ResponseBodyEmitter 결과_2"></p>
<h1 id="후기"><a href="#후기" class="headerlink" title="후기"></a>후기</h1><p><strong><a href="http://woowabros.github.io/experience/2019/03/05/2019DR.html" rel="external nofollow noopener noreferrer" target="_blank">우하한형제들 - 스프링 리액티브 프로그래밍</a> 세미나를 다녀온 후 <a href="https://www.youtube.com/watch?v=8fenTR3KOJo&amp;list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC&amp;index=10" rel="external nofollow noopener noreferrer" target="_blank">토비의 봄 TV 스프링 리액티브 프로그래밍 시리즈</a>를 전부 보고있습니다.</strong></p>
<p>토비님은 매 라이브 코딩마다 말씀하시길 단순히 코드를 보는 것과 실행 후 결과를 실제로 확인해보는 것은 또 다른 차이가 있을 수 있다고 말씀하십니다. 매우 공감합니다!</p>
<p>위의 내용들은 모두 라이브 코딩에 포함되어 있는 내용이지만 실제로 따라해보면서 해당 내용들을 정리하는 차원으로 작성해보았습니다. 따라하며 토비님이 라이브 코딩을 진행하셨을 때와 달라진 몇 가지를 수정한 부분도 있고, 서버의 스레드를 직접 확인해보고자 처음에는 VisualVM을 사용하려 했지만 계속 실패해 JMC을 이용해 진행했습니다.</p>
<p>라이브 코딩을 보며 자바와 스프링의 비동기 기술에 대해 개인적으로 궁금했던 부분들이 많이 해소되었습니다!! 앞으로 남은 내용들도 따라하며 정리해 보도록 하겠습니다.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-03-05T14:00:00.000Z">2019-03-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    22분 읽기 (대략 3292 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/03/05/Java/java-reactor-pattern/">[번역] Java Reactor Pattern</a>
            
        </h1>
        <div class="content">
            <p>해당 글은 아래의 Reactor Pattern Explained 시리즈를 번역하였습니다.</p>
<ul>
<li><a href="http://jeewanthad.blogspot.com/2013/02/reactor-pattern-explained-part-1.html" rel="external nofollow noopener noreferrer" target="_blank">Reactor Pattern Explained - Part 1</a></li>
<li><a href="http://jeewanthad.blogspot.com/2013/02/reactor-pattern-explained-part-2.html" rel="external nofollow noopener noreferrer" target="_blank">Reactor Pattern Explained - Part 2</a></li>
<li><a href="http://jeewanthad.blogspot.com/2013/03/reacter-pattern-explained-part-3.html" rel="external nofollow noopener noreferrer" target="_blank">Reactor Pattern Explained - Part 3</a></li>
</ul>
<h1 id="part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h1><p>서버가 동시에 요청(이벤트)을 받을 때, 보통 요청을 처리하기 위한 이벤트 리스너를 각 스레드마다 할당해 처리하곤 합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket ss = <span class="keyword">new</span> ServerSocket(PORT);</span><br><span class="line">        <span class="keyword">while</span> (!Thread.interrupted())</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Handler(ss.accept())).start();</span><br><span class="line">            <span class="comment">// or, single-threaded, or a thread pool</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Socket socket;</span><br><span class="line">    Handler(Socket s) &#123; socket = s; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] input = <span class="keyword">new</span> <span class="keyword">byte</span>[MAX_INPUT];</span><br><span class="line">            socket.getInputStream().read(input);</span><br><span class="line">            <span class="keyword">byte</span>[] output = process(input);</span><br><span class="line">            socket.getOutputStream().write(output);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] process(<span class="keyword">byte</span>[] cmd) &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>요청마다 처리를 위해 이벤트 리스너를 별도의 스레드로 만들어 사용하는 것의 단점은 <code>컨텍스트 전환(context switching)의 오버 헤드</code>가 크다는 것입니다. 최악의 경우, 데이터를 자주 읽거나 쓰지 않는 이벤트 리스너를 처리하는 일부 스레드는 유용한 작업을 하지 않고 주기적으로 컨텍스트를 전환할 것입니다. 스케줄러가 이러한 스레드를 CPU에 디스패치(dispatch) 할 때마다 I/O 이벤트가 발생할 때까지 스레드는 차단되어 I/O 이벤트를 기다리는 데 소비되는 모든 시간이 낭비됩니다.</p>
<p>위의 코드에서 <code>ss.accept()</code>는 클라이언트가 연결될 때까지 서버 스레드를 차단하는 블로킹 호출입니다. 서버 스레드는 <code>ss.accept()</code> 호출이 반환 될 때까지 이벤트 리스너를 위한 새로운 스레드의 <code>start()</code> 메서드를 호출 할 수 없습니다. 불필요한 컨텍스트 전환으로 인한 CPU 시간 낭비를 줄이기 위해 non-blocking I/O 개념이 탄생했습니다.</p>
<p><strong><code>Reactor Pattern</code></strong>은 이 문제를 해결하기 위한 <strong>이벤트 처리(event handling) 디자인 패턴</strong>입니다. 하나의 Reactor가 계속 이벤트를 찾고 이벤트가 발생(trigger)하면 해당 이벤트 처리기(event handler)에게 이를 알립니다.</p>
<p>자바는 non-blocking 시스템을 설계하는 데 사용할 수 있는 <strong>표준 API (java.nio)</strong>를 제공합니다. 클라이언트가 서버로 이름(데이터)을 보내면 서버는 Hello 메시지로 응답하는 간단한 예제를 통해 Reactor 패턴에 대해서 알아보겠습니다.</p>
<p>Reactor 패턴의 아키텍처에는 두 가지 중요한 참여자가 있습니다.</p>
<ol>
<li><strong><code>Reactor</code></strong><br>: Reactor는 별도의 스레드에서 실행되며 발생한 I/O 이벤트는 dispatching되어 해당 이벤트 처리기로 보내 처리합니다.</li>
<li><strong><code>Handlers</code></strong><br>: Handler는 Reactor로부터 I/O 이벤트를 받아 실제 작업을 수행합니다.</li>
</ol>
<p>java.nio 패키지를 이용해서 Reactor 패턴을 구현할 것이기 때문에 nio 패키지에 속한 몇가지 class에 대한 이해가 필요합니다.</p>
<ul>
<li><strong><code>Channels</code></strong><br>: 소켓을 통해 non-blocking read를 할 수 있도록 지원하는 connection.</li>
<li><strong><code>Buffers</code></strong><br>: 채널에 의해 직접 read되거나 write될 수 있는 배열과 같은 객체.</li>
<li><strong><code>Selectors</code></strong><br>: Selector 는 어느 channel set 이 IO event 를 가지고 있는지를 알려준다. Selector.select() 는 I/O 이벤트가 발생한 채널 set을 return한다. return할 channel이 없다면 계속 기다리게(block) 된다. 이 block된 것을 바로 return 시켜주는 것이 Selector.wakeup()이다.<br>Selector.selectedKeys()는 Selection Key 를 return 해 준다. Reactor는 이 Selection Key를 보고 어떤 handler로 넘겨줄 지를 결정한다.</li>
<li><strong><code>Selection Keys</code></strong><br>: Selector와 Channel간의 관계를 표현해주는 객체이다. Selector가 제공한 Selection Key를 이용해 Reactor는 채널에서 발생하는 I/O 이벤트로 수행할 작업을 선택할 수 있다. ServerSocketChannel에 selector를 등록하면 key를 준다. 이 key가 SelectionKey 이다.</li>
</ul>
<p><img src="/images/post/2019-03-05/reactor_pattern_1.png" alt="Reactor pattern"></p>
<p><strong>Selector는 계속해서 I/O 이벤트가 발생하기를 대기합니다. Reactor가 Selector.select() 메소드를 호출하면 Selector는 등록된 채널에 대해서 발생한 이벤트 정보가 들어있는 SelectionKey Set을 반환합니다.</strong> (SelectionKey는 해당 채널과 Selector와의 관계에 대한 모든 정보를 갖고 있습니다. 또한 Handler에 대한 정보도 갖고 있습니다.)</p>
<p>Selector에 등록된 하나의 ServerSocketChannel이 있습니다. ServerSocketChannel은 클라이언트에서 들어오는 연결 요청으로부터 이벤트를 수신해야합니다. 클라이언트가 연결을 요청할 때, ServerSocketChhannel은 I/O 이벤트를 받아 클라이언트에 SocketChannel을 할당해야 합니다. SelectionKey0은 ServerSocketChannel을 가지고 무엇을 해야하는지에 대한 이벤트 정보를 갖고 있습니다. SocketChhannel을 만들기 위해서는 Reactor가 SelectionKey0의 이벤트를 Acceptor에 전달해 Acceptor가 클라이언트와의 연결 요청을 수락하고 SocketChannel을 만들도록 해야합니다.</p>
<p>Acceptor가 클라이언트1의 연결을 수락하면 클라이언트1에 대한 SocketChannel이 생성됩니다. 이 SocketChannel역시 Selector에 등록되고 해당 채널에서 이벤트가 발생하면 해당 이벤트에 대한 정보를 포함한 SelectionKey1을 반환합니다. 이 SelectionKey1을 이용해서 해당 채널로부터 데이터를 읽고 쓸 수 있습니다. 따라서 SelectionKey1은 읽기와 쓰기를 처리하는 Handler1 객체에 바인딩 됩니다.</p>
<p>이후로 Reactor가 Selector.selector()를 호출했을 때 반환된 SelectionKey Set에 SelectionKey1이 있으면 SocketChannel1이 이벤트와 함께 트리거됨을 의미합니다. 이제 SelectionKey1을 보면, Reactor는 Handler1이 SelectionKey1에 바인딩되어 있으므로 Handler1에 이벤트를 전달해야한다는 것을 알고 있습니다. 반환 된 SelectionKey Set에 SelectionKey0이 있으면 ServerSocketChannel이 다른 클라이언트에서 이벤트를 수신했으며 SelectionKey0을 보고 Reactor는 해당 이벤트를 다시 Acceptor에 전달해야 함을 알고 있습니다. 이벤트가 Acceptor에 전달되면 클라이언트2에 대해 SocketChannel2를 만들고 SelectionKey2로 Selector로 SocketChannel2를 등록합니다.</p>
<p><img src="/images/post/2019-03-05/selection_key_table.png" alt="Selection Key table"></p>
<p>따라서 이 시나리오에서는 3가지 유형의 이벤트에 관심이 있습니다.</p>
<ol>
<li>accept 해야하는 ServerSocketChannel에서 트리거되는 연결 요청 이벤트.</li>
<li>클라이언트로 부터 송신된 데이터를 수신할 수 있을 때, SocketChannel로부터 트리거 되는 이벤트.</li>
<li>서버에서 클라이언트로 데이터를 송신할 때, 송신할 수 있는 준비가 되면 SocketChannel로부터 트리거 되는 이벤트.</li>
</ol>
<p>그럼 스레드 풀은 이 작업과 어떤 관련이 있을까요? non-blocking 아키텍처의 장점은 클라이언트의 모든 요청을 처리하는 동시에 단일 스레드에서 실행되도록 서버를 작성할 수 있다는 것입니다. 서버를 설계하는 데 동시성 개념을 적용하지 않으면 이벤트에 대한 반응성이 떨어집니다. 단일 스레드일 때는 reactor가 이벤트를 handler에 전달해 처리될 때 까지는 다른 이벤트에 응답할 수 없기 때문입니다. 왜냐하면 하나의 스레드를 사용하여 모든 이벤트를 처리하기 때문입니다.</p>
<p>위의 아키텍처에 동시성을 추가해서 시스템의 응답 속도를 향상시킬 수 있습니다. <strong>Reactor가 이벤트를 Handler에 전달하고 새로운 Thread에서 Handler를 이용해 이벤트를 처리하면 Reacgtor는 계속해서 다른 이벤트에 응답할 수 있습니다.</strong> 또한 스레드 풀을 이용하면 시스템의 스레드 수를 제한하면서 더 효율적으로 사용할 수 있을 것 입니다.</p>
<h1 id="part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h1><p>간단한 Reactor 패턴의 예시를 살펴보겠습니다. 클라이언트는 서버로 이름을 넣은 메시지를 전송하고 서버는 클라이언트에 Hello 메시지로 응답합니다. 스레드 풀은 Part3에서 살펴보겠습니다.</p>
<p>클라이언트는 java.nio를 사용하여 Socket을 생성하지 않고 java.net.Socket을 사용합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    String hostIp;</span><br><span class="line">    <span class="keyword">int</span> hostPort;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">(String hostIp, <span class="keyword">int</span> hostPort)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hostIp = hostIp;</span><br><span class="line">        <span class="keyword">this</span>.hostPort = hostPort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Socket clientSocket = <span class="keyword">null</span>;</span><br><span class="line">        PrintWriter out = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader in = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clientSocket = <span class="keyword">new</span> Socket(hostIp, hostPort);</span><br><span class="line">            out = <span class="keyword">new</span> PrintWriter(clientSocket.getOutputStream(), <span class="keyword">true</span>);</span><br><span class="line">            in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(clientSocket.getInputStream()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Unknown host: "</span> + hostIp);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Couldn't connect to: "</span> + hostIp);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BufferedReader stdIn = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">        String userInput;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Client connected to host : "</span> + hostIp + <span class="string">" port: "</span> + hostPort);</span><br><span class="line">        System.out.println(<span class="string">"Type (\"Bye\" to quit)"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Tell what your name is to the Server....."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((userInput = stdIn.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            out.println(userInput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Break when client says Bye.</span></span><br><span class="line">            <span class="keyword">if</span> (userInput.equalsIgnoreCase(<span class="string">"Bye"</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"Server says: "</span> + in.readLine());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.close();</span><br><span class="line">        in.close();</span><br><span class="line">        stdIn.close();</span><br><span class="line">        clientSocket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Client client = <span class="keyword">new</span> Client(<span class="string">"127.0.0.1"</span>, <span class="number">9900</span>);</span><br><span class="line">        client.runClient();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>서버는 Reactor 패턴을 이용해 구현합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reactor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Selector selector;</span><br><span class="line">    <span class="keyword">final</span> ServerSocketChannel serverSocketChannel;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isWithThreadPool;</span><br><span class="line"></span><br><span class="line">    Reactor(<span class="keyword">int</span> port, <span class="keyword">boolean</span> isWithThreadPool) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.isWithThreadPool = isWithThreadPool;</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">        serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">        serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        SelectionKey selectionKey0 = serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        selectionKey0.attach(<span class="keyword">new</span> Acceptor());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Server listening to port: "</span> + serverSocketChannel.socket().getLocalPort());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!Thread.interrupted()) &#123;</span><br><span class="line">                selector.select();</span><br><span class="line">                Set selected = selector.selectedKeys();</span><br><span class="line">                Iterator it = selected.iterator();</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    dispatch((SelectionKey) (it.next()));</span><br><span class="line">                &#125;</span><br><span class="line">                selected.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(SelectionKey k)</span> </span>&#123;</span><br><span class="line">        Runnable r = (Runnable) (k.attachment());</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line">                <span class="keyword">if</span> (socketChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isWithThreadPool)</span><br><span class="line">                        <span class="keyword">new</span> HandlerWithThreadPool(selector, socketChannel);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">new</span> Handler(selector, socketChannel);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Connection Accepted by Reactor"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Reactor는 Runnable을 구현하고 있으며, run() 메서드에서는 while 루프를 돌며 selector.select()를 호출하여 처리할 수 있는 이벤트 정보가 담긴 SelectionKey Set을 가져옵니다. SelectionKey에 바인드 되어있는 Handler를 가져와 dispatch합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SocketChannel socketChannel;</span><br><span class="line">    <span class="keyword">final</span> SelectionKey selectionKey;</span><br><span class="line">    ByteBuffer input = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READING = <span class="number">0</span>, SENDING = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> state = READING;</span><br><span class="line">    String clientName = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    Handler(Selector selector, SocketChannel c) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        socketChannel = c;</span><br><span class="line">        c.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        selectionKey = socketChannel.register(selector, <span class="number">0</span>);</span><br><span class="line">        selectionKey.attach(<span class="keyword">this</span>);</span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">        selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (state == READING) &#123;</span><br><span class="line">                read();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SENDING) &#123;</span><br><span class="line">                send();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readCount = socketChannel.read(input);</span><br><span class="line">        <span class="keyword">if</span> (readCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            readProcess(readCount);</span><br><span class="line">        &#125;</span><br><span class="line">        state = SENDING;</span><br><span class="line">        <span class="comment">// Interested in writing</span></span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Processing of the read message. This only prints the message to stdOut.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> readCount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">readProcess</span><span class="params">(<span class="keyword">int</span> readCount)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        input.flip();</span><br><span class="line">        <span class="keyword">byte</span>[] subStringBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readCount];</span><br><span class="line">        <span class="keyword">byte</span>[] array = input.array();</span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, subStringBytes, <span class="number">0</span>, readCount);</span><br><span class="line">        <span class="comment">// Assuming ASCII (bad assumption but simplifies the example)</span></span><br><span class="line">        sb.append(<span class="keyword">new</span> String(subStringBytes));</span><br><span class="line">        input.clear();</span><br><span class="line">        clientName = sb.toString().trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Saying hello to "</span> + clientName);</span><br><span class="line">        ByteBuffer output = ByteBuffer.wrap((<span class="string">"Hello "</span> + clientName + <span class="string">"\n"</span>).getBytes());</span><br><span class="line">        socketChannel.write(output);</span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">        state = READING;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Handler에는 READING, SENDING 2가지 상태가 있습니다. 채널은 한 번에 하나의 작업만 지원하기 때문에 동시에 처리할 수 없습니다. Handler가 SelectionKey에 어떻게 attach 되는지와 관심있는 연산이 OP_READ로 설정되는 부분에 유의해야합니다. Selector는 Read 이벤트가 발생할 때만 SelectionKey를 select해야 합니다. READ 프로세스가 완료되면 Handler는 상태를 SENDING으로 변경하고 관심 대상 연산을 OP_WRITE로 변경합니다. 이제 Selector는 채널이 데이터를 전송할 준비가 되었을 때 SelectionKey를 select 합니다. Write 이벤트가 Handler에 dispatch될 때, 상태가 SENDING이므로 Hello 메시지를 출력 버퍼에 씁니다. 전송이 완료되면 관심있는 작업을 OP_READ로 다시 변경하면서 Handler의 상태가 READING으로 변경됩니다.</p>
<p>결과적으로 서버는 단일 스레드에서 실행되지만 서버에 연결하는 클라이언트 수에 상관없이 응답합니다.</p>
<h1 id="part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a>Part 3</h1><p>이번 파트에서는 Handler의 스레드 풀에 대해서 설명합니다. HandlerWithThreadPool은 Handler 클래스의 확장 버전입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerWithThreadPool</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ExecutorService pool = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESSING = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerWithThreadPool</span><span class="params">(Selector sel, SocketChannel c)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(sel, c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readCount = socketChannel.read(input);</span><br><span class="line">        <span class="keyword">if</span> (readCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            state = PROCESSING;</span><br><span class="line">            pool.execute(<span class="keyword">new</span> Processer(readCount));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We are interested in writing back to the client soon after read processing is done.</span></span><br><span class="line">        selectionKey.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start processing in a new Processer Thread and Hand off to the reactor thread.</span></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">processAndHandOff</span><span class="params">(<span class="keyword">int</span> readCount)</span> </span>&#123;</span><br><span class="line">        readProcess(readCount);</span><br><span class="line">        <span class="comment">// Read processing done. Now the server is ready to send a message to the client.</span></span><br><span class="line">        state = SENDING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Processer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> readCount;</span><br><span class="line">        Processer(<span class="keyword">int</span> readCount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.readCount =  readCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            processAndHandOff(readCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PROCESSING이 새로 도입되었으며 read() 메서드가 override 되었습니다. 이제 Read 이벤트가 Handler에 dispatch되면 데이터를 읽지만 상태를 SENDING으로 변경하지는 않습니다. 메시지를 처리하고 스레드 풀의 다른 스레드에서 실행하고 관련 작업을 OP_WRITE로 설정하는 Processer를 생성합니다. 이 시점에서 채널에 Write 준비가 되어 있더라도 Handler는 아직 PROCESSING 상태이기 때문에 write하지 않습니다.</p>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><p><a href="http://i5on9i.blogspot.com/2013/11/reactor-pattern.html" rel="external nofollow noopener noreferrer" target="_blank">Reactor Pattern 에 대해 알아보자</a></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-03-03T04:00:00.000Z">2019-03-03</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    25분 읽기 (대략 3677 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/03/03/Java/java-nio/">Java NIO와 멀티플렉싱 기반의 다중 접속 서버</a>
            
        </h1>
        <div class="content">
            <p>자바 NIO에 대한 소개와 NIO와 함께 도입된 자바에서 I/O 멀티플렉싱(multiplexing)을 구현한 selector에 대해 알아봅니다. I/O 멀티플렉싱(multiplexing)에 대한 개념에 대해 아직 잘 이해하지 못하고 있다면 먼저 <a href="https://jongmin92.github.io/2019/02/28/Java/java-with-non-blocking-io/"><strong>&lt;멀티플렉싱 기반의 다중 접속 서버로 가기까지&gt;</strong></a> 포스팅을 읽어주세요.</p>
<h1 id="overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p><strong>자바 NIO (New IO)는 기존의 자바 IO API를 대체하기 위해 자바 1.4부터 도입이 되었습니다.</strong> 새롭게 변화된 부분에 대해서 간략히 요약해보면 다음과 같습니다. </p>
<ul>
<li><strong><code>Channels and Buffers</code></strong><br>기존 IO API에서는 byte streams character streams 사용했지만, NIO에서는 channels(채널)과 buffers(버퍼)를 사용합니다. 데이터는 항상 채널에서 버퍼로 읽히거나 버퍼에서 채널로 쓰여집니다.</li>
<li><strong><code>Non-blocking IO</code></strong><br>자바 NIO에서는 non-blocking IO를 사용할 수 있습니다. 예를 들면, 하나의 스레드는 버퍼에 데이터를 읽도록 채널에 요청할 수 있습니다. 채널이 버퍼로 데이터를 읽는 동안 스레드는 다른 작업을 수행할 수 있습니다. 데이터가 채널에서 버퍼로 읽어지면, 스레드는 해당 버퍼를 이용한 processing(처리)를 계속 할 수 있습니다. 데이터를 채널에 쓰는 경우도 non-blocking이 가능합니다.</li>
<li><strong><code>Selectors</code></strong><br>자바 NIO에는 “selectors” 개념을 포함하고 있습니다. selector는 여러개의 채널에서 이벤트(연결이 생성됨, 데이터가 도착함)를 모니터링할 수 있는 객체입니다. 그래서 하나의 스레드에서 여러 채널에 대해 모니터링이 가능합니다.</li>
</ul>
<p>자바 NIO는 다음과 같은 핵심 컴포넌트로 구성되어있습니다.</p>
<ul>
<li><strong>Channels</strong></li>
<li><strong>Buffers</strong></li>
<li><strong>Selectors</strong></li>
</ul>
<p>실제로는 더 많은 클래스와 컴포넌트가 있지만 채널, 버퍼, 셀렉터가 API의 핵심을 구성합니다.</p>
<h1 id="channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h1><p><strong>일반적으로 NIO의 모든 IO는 채널로 시작합니다. 채널 데이터를 버퍼로 읽을 수 있고, 버퍼에서 채널로 데이터를 쓸 수 있습니다.</strong><br><img src="/images/post/2019-03-03/channel_buffer.png" alt="channel and buffer"></p>
<p>채널은 스트림(stream)과 유사하지만 몇가지 차이점이 있습니다.</p>
<ul>
<li>채널을 통해서는 읽고 쓸 수 있지만, 스트림은 일반적으로 단방향(읽기 혹은 쓰기)으로만 가능합니다.</li>
<li>채널은 비동기적(asynchronously)으로 읽고 쓸 수 있습니다.</li>
<li>채널은 항상 버퍼에서 부터 읽거나 버퍼로 씁니다.</li>
</ul>
<p>채널에는 여러가지 타입이 있습니다. 다음은 자바 NIO에 기본적으로 구현되어 있는 목록입니다.</p>
<ul>
<li>Channels<ul>
<li>FileChannel<br>: 파일에 데이터를 읽고 쓴다.</li>
<li>DatagramChannel<br>: UDP를 이용해 네트워크를 통해 데이터를 읽고 쓴다.</li>
<li><strong>SocketChannel</strong><br>: TCP를 이용해 네트워크를 통해 데이터를 읽고 쓴다.</li>
<li><strong>ServerSocketChannel</strong><br>: 들어오는 TCP 연결을 수신(listening)할 수 있다. 들어오는 연결마다 SocketChannel이 만들어진다.</li>
</ul>
</li>
</ul>
<h1 id="buffers"><a href="#Buffers" class="headerlink" title="Buffers"></a>Buffers</h1><p><strong>NIO의 버퍼는 채널과 상호작용할 때 사용됩니다. 데이터는 채널에서 버퍼로 읽혀지거나, 버퍼에서 읽혀 채널로 쓰여집니다.</strong></p>
<p>버퍼에는 여러가지 타입이 있습니다. 다음은 자바 NIO에 기본적으로 구현되어 있는 목록입니다.</p>
<ul>
<li>Buffers<ul>
<li>ByteBuffer</li>
<li>MappedByteBuffer</li>
<li>CharBuffer</li>
<li>ShortBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>FloatBuffer</li>
<li>DoubleBuffer</li>
</ul>
</li>
</ul>
<p>일반적으로 버퍼를 사용하여 데이터를 읽고 쓰는 것은 4단계 프로세스를 가집니다.</p>
<ol>
<li>버퍼에 데이터 쓰기</li>
<li>buffer.flip() 호출</li>
<li>버퍼에서 데이터 읽기</li>
<li>buffer.clear() 혹은 buffer.compact() 호출</li>
</ol>
<p>버퍼에 데이터를 쓸 때 버퍼는 쓰여진 데이터의 양을 기록합니다. 만약 데이터를 읽어야한다면 flip() 메서드를 호출해서 버퍼를 쓰기 모드에서 읽기 모드로 전환해야 합니다. 읽기 모드에서 버퍼를 사용하면 버퍼에 쓰여진 모든 데이터를 읽을 수 있습니다.<br>모든 데이터를 읽은 후에는 버퍼를 지우고 다시 쓸 준비를 해야합니다. clear() 혹은 compact()를 호출함으로써 전체 버퍼를 지울 수 있습니다. (clear() 메서드는 버퍼 전체를 지우고, compact() 메서드는 이미 읽은 데이터만 지웁니다.)</p>
<h1 id="selectors"><a href="#Selectors" class="headerlink" title="Selectors"></a>Selectors</h1><p><strong>셀렉터를 사용하면 하나의 스레드가 여러 채널을 처리(handle)할 수 있습니다.</strong><br><img src="/images/post/2019-03-03/selector.png" alt="selector"><br>셀렉터는 사용을 위해 하나 이상의 채널을 셀렉터에 등록하고 <strong>select()</strong> 메서드를 호출해 등록 된 채널 중 이벤트 준비가 완료된 하나 이상의 채널이 생길 때까지 봉쇄(block)됩니다. 메서드가 반환(return)되면 스레드는 채널에 준비 완료된 이벤트를 처리할 수 있습니다. 즉, 하나의 스레드에서 여러 채널을 관리할 수 있으므로 여러 네트워크 연결을 관리할 수 있습니다. (SocketChannel, ServerSocketChannel)</p>
<h2 id="selector-생성"><a href="#Selector-생성" class="headerlink" title="Selector 생성"></a>Selector 생성</h2><p><strong><code>Selector.open()</code> 메서드를 통해 셀렉터를 생성할 수 있습니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Selector selector = Selector.open();</span><br></pre></td></tr></table></figure></p>
<h2 id="channels-등록"><a href="#Channels-등록" class="headerlink" title="Channels 등록"></a>Channels 등록</h2><p><strong>생성한 셀렉터에 채널을 등록하기 위해서는 다음과 같이 채널의 <code>register()</code> 메서드를 호출합니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">channel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">SelectionKey key = channel.register(selector, SelectionKey.OP_READ);</span><br></pre></td></tr></table></figure></p>
<p>셀렉터에 채널을 등록하기 위해서는 반드시 해당 채널이 non-blocking 모드로 변환되어야 합니다. (FileChannel은 non-blocking 모드로 변경이 불가능하기 때문에 셀렉터에 등록이 불가능합니다.)</p>
<p><strong>register() 메서드의 두 번째 매개 변수는 셀렉터를 통해 채널에서 발생하는 이벤트 중 확인(알림)하고자 하는 이벤트의 집합을 의미합니다.<br>이벤트에는 4가지 종류가 있으며, 이 4가지 이벤트는 <code>SelectionKey</code> 상수로 표시됩니다.</strong></p>
<ul>
<li>SelectionKey.OP_CONNECT</li>
<li>SelectionKey.OP_ACCEPT</li>
<li>SelectionKey.OP_READ</li>
<li>SelectionKey.OP_WRITE</li>
</ul>
<p>둘 이상의 이벤트 상수는 다음과 같이 사용 가능합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interestSet = SelectionKey.OP_READ | SelectionKey.OP_WRITE</span><br></pre></td></tr></table></figure></p>
<h2 id="selectionkey"><a href="#SelectionKey" class="headerlink" title="SelectionKey"></a>SelectionKey</h2><p>register() 메서드를 이용해 채널을 셀렉터에 등록하면 SelectionKey 객체가 반환됩니다. 이 SelectionKey 객체에는 몇 가지 속성들이 있습니다.</p>
<ul>
<li>The interest set</li>
<li>The ready set</li>
<li>The Channel</li>
<li>The Selector</li>
<li>An attached object (optional)</li>
</ul>
<h3 id="interest-set"><a href="#interest-Set" class="headerlink" title="interest Set"></a>interest Set</h3><p>interest set은 셀렉터에 등록된 채널이 확인하고자 하는 이벤트 집합(세트)입니다. 다음과 같이 SelectionKey를 이용해 해당 interest set을 확인할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interestSet = selectionKey.interestOps();</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> isInterestedInAccept  = interestSet &amp; SelectionKey.OP_ACCEPT;</span><br><span class="line"><span class="keyword">boolean</span> isInterestedInConnect = interestSet &amp; SelectionKey.OP_CONNECT;</span><br><span class="line"><span class="keyword">boolean</span> isInterestedInRead    = interestSet &amp; SelectionKey.OP_READ;</span><br><span class="line"><span class="keyword">boolean</span> isInterestedInWrite   = interestSet &amp; SelectionKey.OP_WRITE;</span><br></pre></td></tr></table></figure></p>
<h3 id="ready-set"><a href="#Ready-Set" class="headerlink" title="Ready Set"></a>Ready Set</h3><p>ready set은 셀렉터에 등록된 채널에서 준비되어 처리(handle) 가능한 이벤트의 집합입니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> readySet = SelectionKey.readyOps();</span><br></pre></td></tr></table></figure></p>
<p>위와 같이 interest Set과 동일한 방식으로 확인할 수도 있지만 아래와 같이 4가지 메소드를 이용해서 확인할 수도 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">selectionKey.isAcceptable();</span><br><span class="line">selectionKey.isConnectable();</span><br><span class="line">selectionKey.isReadable();</span><br><span class="line">selectionKey.isWritable();</span><br></pre></td></tr></table></figure></p>
<h3 id="channel-selector"><a href="#Channel-Selector" class="headerlink" title="Channel + Selector"></a>Channel + Selector</h3><p>SelectionKey를 이용해 채널과 셀렉터에 쉽게 접근할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Channel  channel  = selectionKey.channel();</span><br><span class="line"></span><br><span class="line">Selector selector = selectionKey.selector();</span><br></pre></td></tr></table></figure></p>
<h3 id="attaching-objects"><a href="#Attaching-Objects" class="headerlink" title="Attaching Objects"></a>Attaching Objects</h3><p>SelectionKey에 객체를 첨부(attach)할 수 있습니다. 이 방법을 이용하면 채널에 추가 정보나 채널에서 사용하는 버퍼와 같은 객체들을 쉽게 첨부할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selectionKey.attach(theObject);</span><br><span class="line"></span><br><span class="line">Object attachedObj = selectionKey.attachment();</span><br></pre></td></tr></table></figure></p>
<p>selectionKey를 통해 직접 attach 하는 것 뿐만 아니라 셀렉터에 채널을 등록하면서 객체를 첨부할 수도 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SelectionKey key = channel.register(selector, SelectionKey.OP_READ, theObject);</span><br></pre></td></tr></table></figure></p>
<h2 id="셀렉터를-이용해-채널-선택"><a href="#셀렉터를-이용해-채널-선택" class="headerlink" title="셀렉터를 이용해 채널 선택"></a>셀렉터를 이용해 채널 선택</h2><p><strong>셀렉터에 하나 이상의 채널을 등록한 후에는 <code>select()</code> 메소드를 호출할 수 있습니다. select() 메소드는 accept, connect, read, write 이벤트에 대해 준비(ready) 되어 있는 채널을 반환합니다.</strong> select() 메소드는 다음과 같이 3가지 방식으로 사용 가능합니다.</p>
<ul>
<li><strong>select()</strong><br>: 등록한 이벤트에 대해 하나 이상의 채널이 준비 될 때까지 봉쇄(block)됩니다. 몇개의 채널이 준비되었는지 준비된 채널의 수를 반환합니다. (마지막으로 select()를 호출한 이후 준비된 채널 수 입니다.)</li>
<li><strong>select(long timeout)</strong><br>: 최대 timeout(ms) 동안만 봉쇄한다는 점을 제외하면 select()와 동일합니다.</li>
<li><strong>selectNow()</strong><br>: select와 달리 봉쇄하지 않습니다. 준비된 채널이 있으면 즉시 반환됩니다.</li>
</ul>
<h3 id="selectedkeys"><a href="#selectedKeys" class="headerlink" title="selectedKeys()"></a>selectedKeys()</h3><p><strong>select() 메서드를 통해 하나 이상의 준비된 채널이 발생하면, <code>selectedKeys()</code> 메서드를 사용해 준비된 채널의 집합을 반환 받습니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br></pre></td></tr></table></figure></p>
<p>반환된 SelectionKey set을 반복해 준비된 채널에 접근할 수 있습니다. 채널의 이벤트 처리가 끝나면 keyIterator.remove()를 통해 키 세트에서 제거해야 합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(keyIterator.hasNext()) &#123;</span><br><span class="line">    </span><br><span class="line">    SelectionKey key = keyIterator.next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(key.isAcceptable()) &#123;</span><br><span class="line">        <span class="comment">// a connection was accepted by a ServerSocketChannel.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">        <span class="comment">// a connection was established with a remote server.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">        <span class="comment">// a channel is ready for reading</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">        <span class="comment">// a channel is ready for writing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    keyIterator.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="serversocketchannel"><a href="#ServerSocketChannel" class="headerlink" title="ServerSocketChannel"></a>ServerSocketChannel</h1><p><strong>NIO ServerSocketChannel은 표준 자바 네트워킹의 ServerSocket과 마찬가지로 들어오는 TCP 연결을 수신 대기 할 수 있는 채널입니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9999</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">    SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do something with socketChannel...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="non-blocking-mode"><a href="#Non-blocking-Mode" class="headerlink" title="Non-blocking Mode"></a>Non-blocking Mode</h2><p><strong>ServerSocketChannel은 non-blocking 모드로 설정이 가능합니다.</strong> non-blocking 모드에서는 accept() 메서드가 즉시 반환되므로 들어오는 연결이 없으면 null을 반환할 수 있습니다. 이에 따라 반환 된 ServerSocketChannel이 null인지 확인해야합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9999</span>));</span><br><span class="line">serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">    SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (socketChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// do something with socketChannel...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="socketchannel"><a href="#SocketChannel" class="headerlink" title="SocketChannel"></a>SocketChannel</h1><p><strong>NIO SocketChannel은 TCP 네트워크 소켓에 연결된 채널입니다. 표준 자바 네트워킹의 Socket과 역할이 같습니다.</strong></p>
<h2 id="non-blocking-mode"><a href="#Non-blocking-Mode-1" class="headerlink" title="Non-blocking Mode"></a>Non-blocking Mode</h2><p><strong>ServerSocketChannel과 마찬가지로 SocketChannel을 non-blocking 모드로 설정할 수 있습니다.</strong> non-blocking 모드에서는 connect(), read(), write()를 호출할 수 있습니다.</p>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect()"></a>connect()</h3><p>SocketChannel이 non-blocking 모드일 때, connect()를 호출하면 메서드가 연결이 설정되기 전에 반환될 수 있습니다. 연결이 설정되었는지 확인하기 위해서 finishConnect() 메서드를 이용할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">socketChannel.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"http://naver.com"</span>, <span class="number">80</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!socketChannel.finishConnect()) &#123;</span><br><span class="line">    <span class="comment">// wait, or do something else...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="read"><a href="#read" class="headerlink" title="read()"></a>read()</h3><p>non-blocking 모드일 때, read() 메서드는 데이터를 전혀 읽지 않고 반환 될 수 있습니다. 따라서 반환 된 결과(int)를 갖고 판단해야 합니다. 반환 된 결과(int)는 읽은 바이트 수를 나타냅니다.</p>
<h1 id="멀티플렉싱-기반의-다중-접속-서버"><a href="#멀티플렉싱-기반의-다중-접속-서버" class="headerlink" title="멀티플렉싱 기반의 다중 접속 서버"></a>멀티플렉싱 기반의 다중 접속 서버</h1><p>지금까지 살펴본 Channel, Buffer, Selector를 이용해 간단한 echo 서버를 만들어 보았습니다.</p>
<h2 id="echoserverjava"><a href="#EchoServer-java" class="headerlink" title="EchoServer.java"></a>EchoServer.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXIT = <span class="string">"EXIT"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Selector selector = Selector.open();</span><br><span class="line">        ServerSocketChannel serverSocket = ServerSocketChannel.open();</span><br><span class="line">        serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">3000</span>));</span><br><span class="line">        serverSocket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        serverSocket.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = selectedKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">                SelectionKey key = iter.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    register(selector, serverSocket);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    answerWithEcho(buffer, key);</span><br><span class="line">                &#125;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">answerWithEcho</span><span class="params">(ByteBuffer buffer, SelectionKey key)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        SocketChannel client = (SocketChannel) key.channel();</span><br><span class="line">        client.read(buffer);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> String(buffer.array()).trim().equals(EXIT)) &#123;</span><br><span class="line">            client.close();</span><br><span class="line">            System.out.println(<span class="string">"Not accepting client messages anymore"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buffer.flip();</span><br><span class="line">        client.write(buffer);</span><br><span class="line">        buffer.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Selector selector, ServerSocketChannel serverSocket)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        SocketChannel client = serverSocket.accept();</span><br><span class="line">        client.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        System.out.println(<span class="string">"new client connected..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="실행-결과"><a href="#실행-결과" class="headerlink" title="실행 결과"></a>실행 결과</h2><p><img src="/images/post/2019-03-03/echo_server_with_select.gif" alt="echo_server_with_select"></p>
<h1 id="java-nio-vs-io"><a href="#Java-NIO-vs-IO" class="headerlink" title="Java NIO vs IO"></a>Java NIO vs IO</h1><h2 id="stream-oriented-vs-buffer-oriented"><a href="#Stream-Oriented-vs-Buffer-Oriented" class="headerlink" title="Stream Oriented vs Buffer Oriented"></a>Stream Oriented vs Buffer Oriented</h2><p><strong>스트림 지향의 IO는 스트림에서 한 번에 하나 이상의 바이트를 읽는 것을 의미합니다.</strong> 읽은 바이트를 이용해 유저가 데이터를 처리해야 하며 읽힌 바이트는 따로 캐시되지 않습니다. 또한 스트림의 데이터는 임의로 유저가 앞뒤로 이동할 수 없습니다. 스트림에서 읽은 데이터를 앞뒤로 이동해야 하는 경우는 먼저 스트림의 데이터를 읽어 버퍼에 캐시해야합니다.</p>
<p><strong>버퍼 지향의 NIO 방식은 조금 다릅니다. 데이터는 나중에 처리되는 임의의 버퍼로 읽어집니다.</strong> 필요에 따라 버퍼에서 앞뒤로 이동할 수 있습니다. 이로 인해 버퍼를 이용한 처리 과정에서 좀 더 유연한 사용이 가능합니다. 그러나 버퍼를 이용해 완전히 처리하려면 필요한 모든 데이터가 버퍼에 들어있는지 확인해야합니다. 또한 버퍼에 더 많은 데이터를 읽을 때, 아직 처리하지 않은 버퍼의 데이터를 덮어 쓰지 않도록 주의해야합니다.</p>
<h2 id="blocking-vs-non-blocking-io"><a href="#Blocking-vs-Non-blocking-IO" class="headerlink" title="Blocking vs Non-blocking IO"></a>Blocking vs Non-blocking IO</h2><p><strong>자바 IO의 스트림을 이용하면 봉쇄(block)됩니다.</strong> 즉, 스레드가 read() 혹은 write()를 호출하면 읽은 데이터가 있거나 데이터가 완전히 쓰여질 때까지 해당 스레드가 차단되어 그 동안 스레드는 아무 것도 할 수 없습니다.</p>
<p><strong>자바 NIO의 Non-blocking 모드는 스레드가 채널에서 데이터 읽기를 요청할 때, 현재 사용할 수 있는 데이터가 없는 경우 사용 가능한 데이터가 준비될 때까지 기다리지 않습니다.</strong> 때문에 해당 스레드는 봉쇄되지 않고 계속 진행될 수 있습니다. 쓰기 작업 또한 마찬가지 입니다. 스레드는 일부 데이터를 채널에 쓰도록 요청할 수 있지만 완전히 쓰여지기를 기다리지는 않습니다.</p>
<h2 id="selectos"><a href="#Selectos" class="headerlink" title="Selectos"></a>Selectos</h2><p><strong>자바 NIO의 셀렉터는 하나의 스레드에서 다중 입력 채널을 관리할 수 있습니다.</strong> 이 멀티플렉싱 메커니즘을 사용하면 단일 스레드에서 여러 채널의 입출력을 쉽게 관리할 수 있습니다.</p>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li><a href="http://tutorials.jenkov.com/java-nio/index.html" rel="external nofollow noopener noreferrer" target="_blank">Java NIO Tutorial</a></li>
<li><a href="https://www.baeldung.com/java-nio-selector" rel="external nofollow noopener noreferrer" target="_blank">Introduction to the Java NIO Selector</a></li>
</ul>

        </div>
        
        
        
    </div>
</div>









<!-- For Google Adsense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3921438651818825" data-ad-slot="3015269677"></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>



    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous">
            <a class="is-flex-grow has-text-black-ter" href="/archives/3/">이전</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/archives/5/">다음</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link has-text-black-ter" href="/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/archives/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/archives/3/">3</a></li>
            
            <li><a class="pagination-link is-current" href="/archives/4/">4</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/archives/5/">5</a></li>
            
            <li><span class="pagination-ellipsis has-text-black-ter">&hellip;</span></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/archives/21/">21</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="is-rounded" src="/images/avatar.jpeg" alt="JongMin">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        JongMin
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        생각을 기록하자
                    </p>
                    
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        포스트
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            123
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        카테고리
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            21
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        태그
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            203
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/jongmin92" target="_blank" rel="external nofollow noopener noreferrer">
                팔로우</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="external nofollow noopener noreferrer" title="Github" href="https://github.com/jongmin92">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="external nofollow noopener noreferrer" title="Facebook" href="https://www.facebook.com/jongmin.kim.7796420">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener" title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            최근 글
        </h3>
        
        <article class="media">
            
            <a href="/2020/01/02/Java/rsa/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Encryption - RSA">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-02T13:29:00.000Z">2020-01-02</time></div>
                    <a href="/2020/01/02/Java/rsa/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Encryption - RSA</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Programming/">Programming</a> / <a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/26/Programming/2019-retrospect/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="2년차 LINE 서버 개발자의 2019년 회고">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-26T13:23:00.000Z">2019-12-26</time></div>
                    <a href="/2019/12/26/Programming/2019-retrospect/" class="title has-link-black-ter is-size-6 has-text-weight-normal">2년차 LINE 서버 개발자의 2019년 회고</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/23/Programming/hmac/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="HMAC을 이용한 무결성 보장">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-23T14:37:00.000Z">2019-12-23</time></div>
                    <a href="/2019/12/23/Programming/hmac/" class="title has-link-black-ter is-size-6 has-text-weight-normal">HMAC을 이용한 무결성 보장</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/18/Java/hash/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Hash - MD5와 SHA256">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-17T15:23:00.000Z">2019-12-18</time></div>
                    <a href="/2019/12/18/Java/hash/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Hash - MD5와 SHA256</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Programming/">Programming</a> / <a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/07/Gradle/gradle-implementation/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Gradle에서 Dependency Pollution 문제 해결하기">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-07T04:56:00.000Z">2019-12-07</time></div>
                    <a href="/2019/12/07/Gradle/gradle-implementation/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Gradle에서 Dependency Pollution 문제 해결하기</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Programming/">Programming</a> / <a class="has-link-grey -link" href="/categories/Programming/Gradle/">Gradle</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                카테고리
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Algorithm/">
            <span class="level-start">
                <span class="level-item">Algorithm</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Algorithm/BOJ/">
            <span class="level-start">
                <span class="level-item">BOJ</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Algorithm/Concept/">
            <span class="level-start">
                <span class="level-item">Concept</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Book/">
            <span class="level-start">
                <span class="level-item">Book</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Database/">
            <span class="level-start">
                <span class="level-item">Database</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/">
            <span class="level-start">
                <span class="level-item">Programming</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">95</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Programming/AWS/">
            <span class="level-start">
                <span class="level-item">AWS</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Git/">
            <span class="level-start">
                <span class="level-item">Git</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Gradle/">
            <span class="level-start">
                <span class="level-item">Gradle</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/HTML/">
            <span class="level-start">
                <span class="level-item">HTML</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">21</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/JavaScript/">
            <span class="level-start">
                <span class="level-item">JavaScript</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">15</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Linux-Ubuntu/">
            <span class="level-start">
                <span class="level-item">Linux & Ubuntu</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Node/">
            <span class="level-start">
                <span class="level-item">Node</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/RaspberryPi/">
            <span class="level-start">
                <span class="level-item">RaspberryPi</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/React-Native/">
            <span class="level-start">
                <span class="level-item">React Native</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">19</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Tool/">
            <span class="level-start">
                <span class="level-item">Tool</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Project/">
            <span class="level-start">
                <span class="level-item">Project</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Project/Emily/">
            <span class="level-start">
                <span class="level-item">Emily</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Tip/">
            <span class="level-start">
                <span class="level-item">Tip</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.png" alt="92Hz" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 KimJongMin&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> & <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="external nofollow noopener noreferrer">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("ko");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://jongmin92.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" rel="external nofollow noopener noreferrer" target="_blank">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Zurück nach oben" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="입력 하세요...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '포스트',
                PAGES: '페이지',
                CATEGORIES: '카테고리',
                TAGS: '태그',
                UNTITLED: '(제목없음)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>